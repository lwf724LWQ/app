{"version":3,"file":"code-login.js","sources":["pages/code-login/code-login.vue","D:/uniapp/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY29kZS1sb2dpbi9jb2RlLWxvZ2luLnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"code-login-container\">\r\n    <!-- 状态栏 -->\r\n    <view class=\"status-bar\"></view>\r\n    \r\n    <!-- 头部 -->\r\n    <view class=\"header\">\r\n      <view class=\"back-btn\" @click=\"goBack\">\r\n        <view class=\"back-icon\">\r\n          <text class=\"back-arrow\">←</text>\r\n          <view class=\"logo-lines\">\r\n            <view class=\"line line-1\"></view>\r\n            <view class=\"line line-2\"></view>\r\n          </view>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    \r\n    <!-- 主标题 -->\r\n    <view class=\"title-section\">\r\n      <text class=\"main-title\" v-if=\"!isForgetPwd\">验证码登录</text>\r\n      <text class=\"main-title\" v-if=\"isForgetPwd\">重置密码</text>\r\n    </view>\r\n    \r\n    <!-- 登录表单 -->\r\n    <view class=\"code-login-form\">\r\n      <!-- 手机号输入框 -->\r\n      <view class=\"input-group\">\r\n        <view class=\"input-container\">\r\n          <view class=\"input-icon phone-icon\">\r\n            <view class=\"phone-icon-svg\"></view>\r\n          </view>\r\n          <text class=\"country-code\">+86</text>\r\n          <view class=\"separator\"></view>\r\n          <input \r\n            type=\"text\" \r\n            placeholder=\"请输入手机号\" \r\n            placeholder-class=\"input-placeholder\" \r\n            v-model=\"phone\"\r\n            class=\"phone-input\"\r\n          />\r\n        </view>\r\n      </view>\r\n      \r\n      <!-- 验证码输入框 -->\r\n      <view class=\"input-group\">\r\n        <view class=\"input-container\">\r\n          <view class=\"input-icon code-icon\">\r\n            <view class=\"code-icon-svg\"></view>\r\n          </view>\r\n          <view class=\"code-container\">\r\n            <VerificationCode\r\n              ref=\"codeRef\"  \r\n              placeholder=\"请输入验证码\"\r\n              @getCode=\"sendLoginCode\"  \r\n              @input=\"handleCodeInput\" \r\n            />\r\n          </view>\r\n        </view>\r\n      </view>\r\n      \r\n      <!-- 链接区域 -->\r\n      <view class=\"links-section\" v-if=\"!isForgetPwd\">\r\n        <text class=\"user-login\" @click=\"userLogin\">账号登录</text>\r\n        <text class=\"register-link\" @click=\"goToReg\">注册</text>\r\n      </view>\r\n      \r\n      <!-- 登录按钮 -->\r\n      <view class=\"login-btn-container\">\r\n        <button class=\"login-btn\" @click=\"login\">\r\n          {{ isForgetPwd ? '重置密码' : '登录' }}\r\n        </button>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script lang=\"ts\" setup>\r\n// @ts-ignore\r\nimport VerificationCode from '../../components/VerificationCode.vue'\r\n// @ts-ignore\r\nimport { onLoad } from '@dcloudio/uni-app'\r\nimport { ref } from 'vue'\r\nimport { apiSendCode } from '../../api/apis.js'\r\nimport { apilogin } from '../../api/apis.js'\r\nimport { setToken, setAccount } from '../../utils/request.js'\r\n\r\ndeclare const uni: any\r\n\r\n// 是否显示忘记密码\r\nconst isForgetPwd = ref(false)\r\n\r\n// 返回上一页\r\nconst goBack = () => {\r\n  uni.navigateBack()\r\n}\r\n\r\n// 跳转到注册页面\r\nconst goToReg = () => {\r\n  uni.navigateTo({\r\n    url: '/pages/reg/reg',\r\n  })\r\n}\r\n\r\n// 前往账号登录的页面\r\nconst userLogin = () => {\r\n  uni.navigateTo({\r\n    url: '/pages/login/login',\r\n  })\r\n}\r\n\r\nonLoad((options: any) => {\r\n  if (options.type === 'forgetPwd') {\r\n    isForgetPwd.value = true\r\n  } else {\r\n    isForgetPwd.value = false\r\n  }\r\n})\r\n\r\nconst phone = ref('');\r\nconst code = ref('');\r\nconst codeRef = ref(null);  // 验证码组件实例\r\n\r\n// 输入验证码时更新值\r\nconst handleCodeInput = (value) => {\r\n  code.value = value;\r\n};\r\n\r\n// 发送验证码\r\nconst sendLoginCode = async () => {\r\n  if (!phone.value) {\r\n    uni.showToast({ title: '请输入手机号', icon: 'none' })\r\n    return\r\n  }\r\n  \r\n  try {\r\n    const response = await apiSendCode({phone: phone.value})\r\n    if (response.code === 200) {\r\n      codeRef.value.startCountdown()\r\n      uni.showToast({ title: '验证码已发送', icon: 'success' })\r\n    } else {\r\n      uni.showToast({ title: response.errMsg || '发送失败', icon: 'none' })\r\n    }\r\n  } catch (error) {\r\n    uni.showToast({ title: '发送验证码失败', icon: 'none' })\r\n  }\r\n}\r\n\r\n// 登录逻辑\r\nconst login = async () => {\r\n  if (!phone.value) {\r\n    uni.showToast({ title: '请输入手机号', icon: 'none' })\r\n    return\r\n  }\r\n  \r\n  if (!code.value) {\r\n    uni.showToast({ title: '请输入验证码', icon: 'none' })\r\n    return\r\n  }\r\n  \r\n  uni.showLoading({ title: '登录中...' })\r\n  \r\n  try {\r\n    const loginData = {\r\n      type: '1', // 验证码登录\r\n      account: phone.value,\r\n      code: code.value\r\n    }\r\n    \r\n    const success = await apilogin(loginData)\r\n    uni.hideLoading()\r\n    \r\n    if (success) {\r\n      // 打印登录返回的完整数据，用于调试\r\n      uni.__f__('log','at pages/code-login/code-login.vue:175','验证码登录API返回的完整数据:', success);\r\n      \r\n      // 设置全局token\r\n      if (success.data?.token) {\r\n        setToken(success.data.token)\r\n      }\r\n      \r\n      // 设置全局account\r\n      if (phone.value) {\r\n        setAccount(phone.value)\r\n      }\r\n      \r\n      // 直接使用登录返回的用户信息\r\n      try {\r\n        // 从登录返回的数据中提取用户信息\r\n        const loginData = success.data || {};\r\n        \r\n        // 处理头像URL - 如果是相对路径，拼接完整URL\r\n        let avatarUrl = 'http://video.caimizm.com/himg/user.png'; // 默认头像\r\n        if (loginData.himg) {\r\n          if (loginData.himg.startsWith('http')) {\r\n            // 已经是完整URL\r\n            avatarUrl = loginData.himg;\r\n          } else {\r\n            // 相对路径，拼接完整URL\r\n            avatarUrl = `http://video.caimizm.com/himg/${loginData.himg}`;\r\n          }\r\n        }\r\n        \r\n        // 保存用户信息到本地存储\r\n        const userInfo = {\r\n          nickname: loginData.uname || '用户',\r\n          avatar: avatarUrl,\r\n          phone: phone.value\r\n        };\r\n        \r\n        // 保存到本地存储，供用户页面使用\r\n        uni.setStorageSync('userInfo', userInfo);\r\n        uni.setStorageSync('loginData', {\r\n          uname: loginData.uname,\r\n          himg: loginData.himg,\r\n          account: phone.value\r\n        });\r\n        \r\n        uni.__f__('log','at pages/code-login/code-login.vue:219','验证码登录成功，用户信息已保存:', userInfo);\r\n        uni.__f__('log','at pages/code-login/code-login.vue:220','登录数据已保存:', {\r\n          uname: loginData.uname,\r\n          himg: loginData.himg,\r\n          account: phone.value\r\n        });\r\n        \r\n      } catch (error) {\r\n        uni.__f__('error','at pages/code-login/code-login.vue:227','保存用户信息失败:', error);\r\n        // 使用默认用户信息\r\n        const defaultUserInfo = {\r\n          nickname: '用户',\r\n          avatar: 'http://video.caimizm.com/himg/user.png',\r\n          phone: phone.value\r\n        };\r\n        uni.setStorageSync('userInfo', defaultUserInfo);\r\n        uni.setStorageSync('loginData', {\r\n          uname: '用户',\r\n          himg: 'http://video.caimizm.com/himg/user.png',\r\n          account: phone.value\r\n        });\r\n      }\r\n      \r\n      uni.showToast({ title: '登录成功', icon: 'success' })\r\n      \r\n      setTimeout(() => {\r\n        uni.switchTab({ url: '/pages/user/user' })\r\n      }, 1500)\r\n    } else {\r\n      uni.showModal({ title: '登录失败', content: '验证码错误或已过期，请重试', showCancel: false })\r\n    }\r\n  } catch (error) {\r\n    uni.hideLoading()\r\n    uni.showModal({ title: '登录失败', content: '网络错误，请检查网络连接后重试', showCancel: false })\r\n  }\r\n}\r\n</script>\r\n\r\n<style>\r\n.input-placeholder {\r\n  color: #999;\r\n}\r\n</style>\r\n\r\n<style lang=\"scss\" scoped>\r\n.code-login-container {\r\n  min-height: 100vh;\r\n  background: linear-gradient(180deg, #f8fffe 0%, #ffffff 100%);\r\n  position: relative;\r\n}\r\n\r\n/* 状态栏 */\r\n.status-bar {\r\n  height: 44rpx;\r\n  background: transparent;\r\n}\r\n\r\n/* 头部区域 */\r\n.header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 20rpx 40rpx;\r\n  margin-bottom: 40rpx;\r\n  \r\n  .back-btn {\r\n    width: 60rpx;\r\n    height: 60rpx;\r\n    background: #e8f5e8;\r\n    border-radius: 50%;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    \r\n    .back-icon {\r\n      position: relative;\r\n      width: 40rpx;\r\n      height: 40rpx;\r\n      \r\n      .back-arrow {\r\n        position: absolute;\r\n        top: 50%;\r\n        left: 50%;\r\n        transform: translate(-50%, -50%);\r\n        font-size: 32rpx;\r\n        color: #28B389;\r\n        font-weight: bold;\r\n        z-index: 2;\r\n      }\r\n      \r\n      .logo-lines {\r\n        position: absolute;\r\n        top: 50%;\r\n        left: 50%;\r\n        transform: translate(-50%, -50%);\r\n        \r\n        .line {\r\n          position: absolute;\r\n          background: #28B389;\r\n          border-radius: 2rpx;\r\n          opacity: 0.3;\r\n          \r\n          &.line-1 {\r\n            width: 20rpx;\r\n            height: 2rpx;\r\n            top: -8rpx;\r\n            left: -10rpx;\r\n            transform: rotate(-15deg);\r\n          }\r\n          \r\n          &.line-2 {\r\n            width: 16rpx;\r\n            height: 2rpx;\r\n            top: 4rpx;\r\n            left: -8rpx;\r\n            transform: rotate(15deg);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/* 主标题 */\r\n.title-section {\r\n  text-align: center;\r\n  margin-bottom: 80rpx;\r\n  \r\n  .main-title {\r\n    font-size: 56rpx;\r\n    font-weight: 700;\r\n    color: #000;\r\n    letter-spacing: 4rpx;\r\n  }\r\n}\r\n\r\n/* 登录表单 */\r\n.code-login-form {\r\n  padding: 0 60rpx;\r\n  \r\n  .input-group {\r\n    margin-bottom: 40rpx;\r\n    \r\n    .input-container {\r\n      background: #fff;\r\n      border-radius: 20rpx;\r\n      padding: 30rpx 40rpx;\r\n      display: flex;\r\n      align-items: center;\r\n      box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);\r\n      \r\n      .input-icon {\r\n        width: 40rpx;\r\n        height: 40rpx;\r\n        margin-right: 20rpx;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        \r\n        .phone-icon-svg {\r\n          width: 32rpx;\r\n          height: 48rpx;\r\n          border: 3rpx solid #28B389;\r\n          border-radius: 8rpx;\r\n          position: relative;\r\n          \r\n          &::before {\r\n            content: '';\r\n            position: absolute;\r\n            top: 4rpx;\r\n            left: 4rpx;\r\n            right: 4rpx;\r\n            bottom: 8rpx;\r\n            border: 2rpx solid #28B389;\r\n            border-radius: 4rpx;\r\n          }\r\n          \r\n          &::after {\r\n            content: '';\r\n            position: absolute;\r\n            bottom: 2rpx;\r\n            left: 50%;\r\n            transform: translateX(-50%);\r\n            width: 8rpx;\r\n            height: 8rpx;\r\n            background: #28B389;\r\n            border-radius: 50%;\r\n          }\r\n        }\r\n        \r\n        .code-icon-svg {\r\n          width: 32rpx;\r\n          height: 32rpx;\r\n          border: 3rpx solid #28B389;\r\n          border-radius: 6rpx;\r\n          position: relative;\r\n          \r\n          &::before {\r\n            content: '';\r\n            position: absolute;\r\n            top: 4rpx;\r\n            left: 4rpx;\r\n            width: 6rpx;\r\n            height: 6rpx;\r\n            background: #28B389;\r\n            border-radius: 50%;\r\n          }\r\n          \r\n          &::after {\r\n            content: '';\r\n            position: absolute;\r\n            bottom: 4rpx;\r\n            right: 4rpx;\r\n            width: 8rpx;\r\n            height: 8rpx;\r\n            background: #28B389;\r\n            border-radius: 50%;\r\n          }\r\n        }\r\n      }\r\n      \r\n      .country-code {\r\n        font-size: 32rpx;\r\n        color: #000;\r\n        font-weight: 500;\r\n        margin-right: 20rpx;\r\n      }\r\n      \r\n      .separator {\r\n        width: 2rpx;\r\n        height: 40rpx;\r\n        background: #ddd;\r\n        margin-right: 20rpx;\r\n      }\r\n      \r\n      .code-container {\r\n        flex: 1;\r\n        display: flex;\r\n        align-items: center;\r\n      }\r\n      \r\n      .phone-input {\r\n        flex: 1;\r\n        font-size: 32rpx;\r\n        color: #000;\r\n        border: none;\r\n        outline: none;\r\n        background: transparent;\r\n      }\r\n    }\r\n  }\r\n  \r\n  /* 链接区域 */\r\n  .links-section {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    margin-bottom: 60rpx;\r\n    \r\n    .user-login {\r\n      font-size: 28rpx;\r\n      color: #28B389;\r\n    }\r\n    \r\n    .register-link {\r\n      font-size: 28rpx;\r\n      color: #28B389;\r\n    }\r\n  }\r\n  \r\n  /* 登录按钮 */\r\n  .login-btn-container {\r\n    margin-bottom: 40rpx;\r\n    \r\n    .login-btn {\r\n      width: 100%;\r\n      height: 100rpx;\r\n      background: #28B389;\r\n      border-radius: 20rpx;\r\n      border: none;\r\n      color: #fff;\r\n      font-size: 36rpx;\r\n      font-weight: 600;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n    }\r\n  }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'C:/梓梅2.0/梓梅xcx/my-painting-rules-project/pages/code-login/code-login.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","onLoad","apiSendCode","apilogin","setToken","setAccount","loginData"],"mappings":"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"}