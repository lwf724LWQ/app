{"version":3,"file":"code-login.js","sources":["pages/code-login/code-login.vue","D:/uniapp/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvY29kZS1sb2dpbi9jb2RlLWxvZ2luLnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"code-login-container\">\n    <!-- 状态栏 -->\n    <view class=\"status-bar\"></view>\n    \n    <!-- 头部 -->\n    <view class=\"header\">\n      <view class=\"back-btn\" @click=\"goBack\">\n        <view class=\"back-icon\">\n          <text class=\"back-arrow\">←</text>\n          <view class=\"logo-lines\">\n            <view class=\"line line-1\"></view>\n            <view class=\"line line-2\"></view>\n          </view>\n        </view>\n      </view>\n    </view>\n    \n    <!-- 主标题 -->\n    <view class=\"title-section\">\n      <text class=\"main-title\" v-if=\"!isForgetPwd\">验证码登录</text>\n      <text class=\"main-title\" v-if=\"isForgetPwd\">重置密码</text>\n    </view>\n    \n    <!-- 登录表单 -->\n    <view class=\"code-login-form\">\n      <!-- 手机号输入框 -->\n      <view class=\"input-group\">\n        <view class=\"input-container\">\n          <view class=\"input-icon phone-icon\">\n            <view class=\"phone-icon-svg\"></view>\n          </view>\n          <text class=\"country-code\">+86</text>\n          <view class=\"separator\"></view>\n          <input \n            type=\"text\" \n            placeholder=\"请输入手机号\" \n            placeholder-class=\"input-placeholder\" \n            v-model=\"phone\"\n            class=\"phone-input\"\n          />\n        </view>\n      </view>\n      \n      <!-- 验证码输入框 -->\n      <view class=\"input-group\">\n        <view class=\"input-container\">\n          <view class=\"input-icon code-icon\">\n            <view class=\"code-icon-svg\"></view>\n          </view>\n          <view class=\"code-container\">\n            <VerificationCode\n              ref=\"codeRef\"  \n              placeholder=\"请输入验证码\"\n              @getCode=\"sendLoginCode\"  \n              @input=\"handleCodeInput\" \n            />\n          </view>\n        </view>\n      </view>\n      \n      <!-- 链接区域 -->\n      <view class=\"links-section\" v-if=\"!isForgetPwd\">\n        <text class=\"user-login\" @click=\"userLogin\">账号登录</text>\n        <text class=\"register-link\" @click=\"goToReg\">注册</text>\n      </view>\n      \n      <!-- 登录按钮 -->\n      <view class=\"login-btn-container\">\n        <button class=\"login-btn\" @click=\"login\">\n          {{ isForgetPwd ? '重置密码' : '登录' }}\n        </button>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script lang=\"ts\" setup>\n// @ts-ignore\nimport VerificationCode from '../../components/VerificationCode.vue'\n// @ts-ignore\nimport { onLoad } from '@dcloudio/uni-app'\nimport { ref } from 'vue'\nimport { apiSendCode } from '../../api/apis.js'\nimport { apilogin } from '../../api/apis.js'\nimport { setToken, setAccount } from '../../utils/request.js'\n\ndeclare const uni: any\n\n// 是否显示忘记密码\nconst isForgetPwd = ref(false)\n\n// 返回上一页\nconst goBack = () => {\n  uni.navigateBack()\n}\n\n// 跳转到注册页面\nconst goToReg = () => {\n  uni.navigateTo({\n    url: '/pages/reg/reg',\n  })\n}\n\n// 前往账号登录的页面\nconst userLogin = () => {\n  uni.navigateTo({\n    url: '/pages/login/login',\n  })\n}\n\nonLoad((options: any) => {\n  if (options.type === 'forgetPwd') {\n    isForgetPwd.value = true\n  } else {\n    isForgetPwd.value = false\n  }\n})\n\nconst phone = ref('');\nconst code = ref('');\nconst codeRef = ref(null);  // 验证码组件实例\n\n// 输入验证码时更新值\nconst handleCodeInput = (value) => {\n  code.value = value;\n};\n\n// 发送验证码\nconst sendLoginCode = async () => {\n  if (!phone.value) {\n    uni.showToast({ title: '请输入手机号', icon: 'none' })\n    return\n  }\n  \n  try {\n    const response = await apiSendCode({phone: phone.value})\n    if (response.code === 200) {\n      codeRef.value.startCountdown()\n      uni.showToast({ title: '验证码已发送', icon: 'success' })\n    } else {\n      uni.showToast({ title: response.errMsg || '发送失败', icon: 'none' })\n    }\n  } catch (error) {\n    uni.showToast({ title: '发送验证码失败', icon: 'none' })\n  }\n}\n\n// 登录逻辑\nconst login = async () => {\n  if (!phone.value) {\n    uni.showToast({ title: '请输入手机号', icon: 'none' })\n    return\n  }\n  \n  if (!code.value) {\n    uni.showToast({ title: '请输入验证码', icon: 'none' })\n    return\n  }\n  \n  uni.showLoading({ title: '登录中...' })\n  \n  try {\n    const loginData = {\n      type: '1', // 验证码登录\n      account: phone.value,\n      code: code.value\n    }\n    \n    const success = await apilogin(loginData)\n    uni.hideLoading()\n    \n    if (success) {\n      // 打印登录返回的完整数据，用于调试\n      uni.__f__('log','at pages/code-login/code-login.vue:175','验证码登录API返回的完整数据:', success);\n      \n      // 设置全局token\n      if (success.data?.token) {\n        setToken(success.data.token)\n      }\n      \n      // 设置全局account\n      if (phone.value) {\n        setAccount(phone.value)\n      }\n      \n      // 直接使用登录返回的用户信息\n      try {\n        // 从登录返回的数据中提取用户信息\n        const loginData = success.data || {};\n        \n        // 处理头像URL - 如果是相对路径，拼接完整URL\n        let avatarUrl = 'http://video.caimizm.com/himg/user.png'; // 默认头像\n        if (loginData.himg) {\n          if (loginData.himg.startsWith('http')) {\n            // 已经是完整URL\n            avatarUrl = loginData.himg;\n          } else {\n            // 相对路径，拼接完整URL\n            avatarUrl = `http://video.caimizm.com/himg/${loginData.himg}`;\n          }\n        }\n        \n        // 保存用户信息到本地存储\n        const userInfo = {\n          nickname: loginData.uname || '用户',\n          avatar: avatarUrl,\n          phone: phone.value\n        };\n        \n        // 保存到本地存储，供用户页面使用\n        uni.setStorageSync('userInfo', userInfo);\n        uni.setStorageSync('loginData', {\n          uname: loginData.uname,\n          himg: loginData.himg,\n          account: phone.value\n        });\n        \n        uni.__f__('log','at pages/code-login/code-login.vue:219','验证码登录成功，用户信息已保存:', userInfo);\n        uni.__f__('log','at pages/code-login/code-login.vue:220','登录数据已保存:', {\n          uname: loginData.uname,\n          himg: loginData.himg,\n          account: phone.value\n        });\n        \n      } catch (error) {\n        uni.__f__('error','at pages/code-login/code-login.vue:227','保存用户信息失败:', error);\n        // 使用默认用户信息\n        const defaultUserInfo = {\n          nickname: '用户',\n          avatar: 'http://video.caimizm.com/himg/user.png',\n          phone: phone.value\n        };\n        uni.setStorageSync('userInfo', defaultUserInfo);\n        uni.setStorageSync('loginData', {\n          uname: '用户',\n          himg: 'http://video.caimizm.com/himg/user.png',\n          account: phone.value\n        });\n      }\n      \n      uni.showToast({ title: '登录成功', icon: 'success' })\n      \n      setTimeout(() => {\n        uni.switchTab({ url: '/pages/user/user' })\n      }, 1500)\n    } else {\n      uni.showModal({ title: '登录失败', content: '验证码错误或已过期，请重试', showCancel: false })\n    }\n  } catch (error) {\n    uni.hideLoading()\n    uni.showModal({ title: '登录失败', content: '网络错误，请检查网络连接后重试', showCancel: false })\n  }\n}\n</script>\n\n<style>\n.input-placeholder {\n  color: #999;\n}\n</style>\n\n<style lang=\"scss\" scoped>\n.code-login-container {\n  min-height: 100vh;\n  background: linear-gradient(180deg, #f8fffe 0%, #ffffff 100%);\n  position: relative;\n}\n\n/* 状态栏 */\n.status-bar {\n  height: 44rpx;\n  background: transparent;\n}\n\n/* 头部区域 */\n.header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 20rpx 40rpx;\n  margin-bottom: 40rpx;\n  \n  .back-btn {\n    width: 60rpx;\n    height: 60rpx;\n    background: #e8f5e8;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    \n    .back-icon {\n      position: relative;\n      width: 40rpx;\n      height: 40rpx;\n      \n      .back-arrow {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        font-size: 32rpx;\n        color: #28B389;\n        font-weight: bold;\n        z-index: 2;\n      }\n      \n      .logo-lines {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        \n        .line {\n          position: absolute;\n          background: #28B389;\n          border-radius: 2rpx;\n          opacity: 0.3;\n          \n          &.line-1 {\n            width: 20rpx;\n            height: 2rpx;\n            top: -8rpx;\n            left: -10rpx;\n            transform: rotate(-15deg);\n          }\n          \n          &.line-2 {\n            width: 16rpx;\n            height: 2rpx;\n            top: 4rpx;\n            left: -8rpx;\n            transform: rotate(15deg);\n          }\n        }\n      }\n    }\n  }\n}\n\n/* 主标题 */\n.title-section {\n  text-align: center;\n  margin-bottom: 80rpx;\n  \n  .main-title {\n    font-size: 56rpx;\n    font-weight: 700;\n    color: #000;\n    letter-spacing: 4rpx;\n  }\n}\n\n/* 登录表单 */\n.code-login-form {\n  padding: 0 60rpx;\n  \n  .input-group {\n    margin-bottom: 40rpx;\n    \n    .input-container {\n      background: #fff;\n      border-radius: 20rpx;\n      padding: 30rpx 40rpx;\n      display: flex;\n      align-items: center;\n      box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);\n      \n      .input-icon {\n        width: 40rpx;\n        height: 40rpx;\n        margin-right: 20rpx;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        \n        .phone-icon-svg {\n          width: 32rpx;\n          height: 48rpx;\n          border: 3rpx solid #28B389;\n          border-radius: 8rpx;\n          position: relative;\n          \n          &::before {\n            content: '';\n            position: absolute;\n            top: 4rpx;\n            left: 4rpx;\n            right: 4rpx;\n            bottom: 8rpx;\n            border: 2rpx solid #28B389;\n            border-radius: 4rpx;\n          }\n          \n          &::after {\n            content: '';\n            position: absolute;\n            bottom: 2rpx;\n            left: 50%;\n            transform: translateX(-50%);\n            width: 8rpx;\n            height: 8rpx;\n            background: #28B389;\n            border-radius: 50%;\n          }\n        }\n        \n        .code-icon-svg {\n          width: 32rpx;\n          height: 32rpx;\n          border: 3rpx solid #28B389;\n          border-radius: 6rpx;\n          position: relative;\n          \n          &::before {\n            content: '';\n            position: absolute;\n            top: 4rpx;\n            left: 4rpx;\n            width: 6rpx;\n            height: 6rpx;\n            background: #28B389;\n            border-radius: 50%;\n          }\n          \n          &::after {\n            content: '';\n            position: absolute;\n            bottom: 4rpx;\n            right: 4rpx;\n            width: 8rpx;\n            height: 8rpx;\n            background: #28B389;\n            border-radius: 50%;\n          }\n        }\n      }\n      \n      .country-code {\n        font-size: 32rpx;\n        color: #000;\n        font-weight: 500;\n        margin-right: 20rpx;\n      }\n      \n      .separator {\n        width: 2rpx;\n        height: 40rpx;\n        background: #ddd;\n        margin-right: 20rpx;\n      }\n      \n      .code-container {\n        flex: 1;\n        display: flex;\n        align-items: center;\n      }\n      \n      .phone-input {\n        flex: 1;\n        font-size: 32rpx;\n        color: #000;\n        border: none;\n        outline: none;\n        background: transparent;\n      }\n    }\n  }\n  \n  /* 链接区域 */\n  .links-section {\n    display: flex;\n    justify-content: space-between;\n    margin-bottom: 60rpx;\n    \n    .user-login {\n      font-size: 28rpx;\n      color: #28B389;\n    }\n    \n    .register-link {\n      font-size: 28rpx;\n      color: #28B389;\n    }\n  }\n  \n  /* 登录按钮 */\n  .login-btn-container {\n    margin-bottom: 40rpx;\n    \n    .login-btn {\n      width: 100%;\n      height: 100rpx;\n      background: #28B389;\n      border-radius: 20rpx;\n      border: none;\n      color: #fff;\n      font-size: 36rpx;\n      font-weight: 600;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n  }\n}\n</style>\n","import MiniProgramPage from 'C:/Users/Administrator/Desktop/my-painting-rules-project/pages/code-login/code-login.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uni","onLoad","apiSendCode","apilogin","setToken","setAccount","loginData"],"mappings":"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"}