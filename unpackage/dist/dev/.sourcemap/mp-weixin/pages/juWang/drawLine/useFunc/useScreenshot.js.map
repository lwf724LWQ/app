{"version":3,"file":"useScreenshot.js","sources":["pages/juWang/drawLine/useFunc/useScreenshot.js"],"sourcesContent":["export default function useScreenshot(html2canvas) {\r\n    // 保存 Canvas 和表格内容 - 使用html2canvas实现\r\n    const saveCanvasImage = async () => {\r\n        // 显示加载提示\r\n        uni.showLoading({ title: '正在生成截图...', mask: true });\r\n\r\n        try {\r\n            // 获取表格容器元素\r\n            const container = document.querySelector('.numbers-table-container');\r\n            if (!container) {\r\n                throw new Error('未找到表格容器');\r\n            }\r\n\r\n            // 使用html2canvas捕获整个表格容器，包括表格、Canvas和文字标注\r\n            const canvas = await html2canvas(container, {\r\n                scale: window.devicePixelRatio || 1, // 保持高清\r\n                useCORS: true,\r\n                logging: false,\r\n                backgroundColor: null, // 透明背景\r\n                ignoreElements: (element) => {\r\n                    // 忽略Fab按钮组，避免截图包含操作按钮\r\n                    return element.classList.contains('fab-wrapper');\r\n                }\r\n            });\r\n\r\n            // 将Canvas转换为图片\r\n            canvas.toBlob(async (blob) => {\r\n                try {\r\n                    // 创建下载链接\r\n                    const url = URL.createObjectURL(blob);\r\n                    const timestamp = new Date().getTime();\r\n                    const fileName = `table-canvas-${timestamp}.png`;\r\n\r\n                    // 处理H5环境下载\r\n                    const link = document.createElement('a');\r\n                    link.href = url;\r\n                    link.download = fileName;\r\n                    link.style.display = 'none';\r\n                    document.body.appendChild(link);\r\n                    link.click();\r\n\r\n                    // 清理\r\n                    setTimeout(() => {\r\n                        document.body.removeChild(link);\r\n                        URL.revokeObjectURL(url);\r\n                    }, 100);\r\n\r\n                    uni.hideLoading();\r\n                    uni.showToast({ title: '保存成功', icon: 'none' });\r\n                } catch (error) {\r\n                    console.error('创建下载链接失败:', error);\r\n                    uni.hideLoading();\r\n                    uni.showToast({ title: '保存失败', icon: 'none' });\r\n                }\r\n            }, 'image/png');\r\n        } catch (err) {\r\n            console.error('截图失败:', err);\r\n            uni.hideLoading();\r\n            uni.showToast({ title: '截图失败，请重试', icon: 'none' });\r\n        }\r\n    };\r\n\r\n    // 将DOM元素转换为图片 - 修复版\r\n    const domToImage = (dom) => {\r\n        return new Promise((resolve, reject) => {\r\n            // 创建一个临时Canvas\r\n            const canvas = document.createElement('canvas');\r\n            const ctx = canvas.getContext('2d');\r\n\r\n            // 获取DOM元素的尺寸\r\n            const rect = dom.getBoundingClientRect();\r\n            canvas.width = rect.width;\r\n            canvas.height = rect.height;\r\n\r\n            // 创建一个临时img元素\r\n            const tempImg = new Image();\r\n\r\n            // 创建SVG，使用base64编码避免跨域问题\r\n            const svg = `\r\n        <svg width=\"${rect.width}\" height=\"${rect.height}\" xmlns=\"http://www.w3.org/2000/svg\">\r\n          <foreignObject width=\"100%\" height=\"100%\">\r\n            <div xmlns=\"http://www.w3.org/1999/xhtml\">${new XMLSerializer().serializeToString(dom)}</div>\r\n          </foreignObject>\r\n        </svg>\r\n      `;\r\n\r\n            // 将SVG转换为data URL\r\n            const svgData = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));\r\n\r\n            // 关键：允许跨域使用图像，但这会污染Canvas\r\n            // 所以我们需要另一种方式处理\r\n            tempImg.crossOrigin = 'anonymous';\r\n\r\n            tempImg.onload = () => {\r\n                try {\r\n                    // 绘制图像到Canvas\r\n                    ctx.drawImage(tempImg, 0, 0);\r\n\r\n                    // 创建第二个Canvas用于净化\r\n                    const cleanCanvas = document.createElement('canvas');\r\n                    const cleanCtx = cleanCanvas.getContext('2d');\r\n                    cleanCanvas.width = rect.width;\r\n                    cleanCanvas.height = rect.height;\r\n\r\n                    // 将第一个Canvas的内容绘制到第二个Canvas，净化处理\r\n                    cleanCtx.drawImage(canvas, 0, 0);\r\n\r\n                    resolve(cleanCanvas);\r\n                } catch (error) {\r\n                    reject(error);\r\n                } finally {\r\n                    // 清理\r\n                    URL.revokeObjectURL(svgData);\r\n                }\r\n            };\r\n\r\n            tempImg.onerror = (error) => {\r\n                reject(new Error('无法加载图像: ' + error.message));\r\n            };\r\n\r\n            tempImg.src = svgData;\r\n        });\r\n    };\r\n\r\n    return {\r\n        saveCanvasImage,\r\n        domToImage\r\n    };\r\n}"],"names":["uni"],"mappings":"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"}