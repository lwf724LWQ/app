{"version":3,"file":"useTextLabels.js","sources":["pages/juWang/drawLine/useFunc/useTextLabels.js"],"sourcesContent":["import { ref, nextTick } from 'vue';\r\n\r\nexport default function useTextLabels(canvasSize) {\r\n    // 文字标注相关\r\n    const textLabels = ref([]);\r\n    const movingLabel = ref(-1);\r\n    const touchStartTime = ref(0);\r\n    const touchStartPos = ref({ x: 0, y: 0 });\r\n    const touchEndTime = ref(0);\r\n    const touchCount = ref(0);\r\n    const touchTimer = ref(null);\r\n    const labelOffset = ref({ x: 0, y: 0 });\r\n    const longPressDetected = ref(false);\r\n\r\n    // 文字标签样式\r\n    function getLabelStyle(label) {\r\n        return {\r\n            left: `${label.x}px`,\r\n            top: `${label.y}px`,\r\n            zIndex: 25\r\n        };\r\n    }\r\n\r\n    // 触摸开始 - 用于移动设备上的双击和长按检测\r\n    function handleLabelTouchStart(idx, e) {\r\n        const currentMode = 'text'; // 在实际使用中应该从主组件传入\r\n        if (currentMode!== 'text') return;// 如果当前模式不是 'text'，则直接返回，不执行后续操作\r\n        if (textLabels.value[idx].editing) {\r\n            e.stopPropagation();\r\n            return;\r\n        }// 检查当前标签是否处于编辑状态，如果是，则阻止事件冒泡并返回\r\n\r\n        touchStartTime.value = Date.now();// 记录触摸开始的时间（用于后续判断是否为长按）\r\n        const touch = e.touches[0];// 获取触摸事件中的第一个触摸点\r\n\r\n        // 获取容器的绝对位置\r\n        const container = document.querySelector('.numbers-table-container');\r\n        const containerRect = container? container.getBoundingClientRect() : { left: 0, top: 0 };\r\n        const containerAbsTop = containerRect.top + window.scrollY;\r\n        const containerAbsLeft = containerRect.left + window.scrollX;\r\n\r\n        // 计算label的绝对位置\r\n        const currentLabel = textLabels.value[idx];\r\n        const labelAbsX = currentLabel.x + containerAbsLeft;\r\n        const labelAbsY = currentLabel.y + containerAbsTop;\r\n\r\n        // 记录触摸开始位置（页面坐标）\r\n        touchStartPos.value = {\r\n            x: touch.pageX,\r\n            y: touch.pageY,\r\n        };\r\n\t\t// highlighted.value.push({ touch.pageX, touch.pageY });\r\n// toggleHighlight(touch.pageX, touch.pageY);\r\n        // 计算偏移量（页面坐标 - label绝对坐标）\r\n        labelOffset.value = {\r\n            x: touch.pageX - labelAbsX,\r\n            y: touch.pageY - labelAbsY\r\n        };\r\n\r\n        // 增加触摸计数\r\n        touchCount.value++;\r\n\r\n        // 检测双击（两次触摸在短时间内）\r\n        if (touchCount.value === 2) {\r\n            // 清除之前的计时器\r\n            if (touchTimer.value) {\r\n                clearTimeout(touchTimer.value);\r\n                touchTimer.value = null;\r\n            }\r\n\r\n            // 确认是双击\r\n            handleDoubleTap(idx);\r\n            touchCount.value = 0;\r\n        } else {\r\n            // 设置计时器，重置触摸计数\r\n            touchTimer.value = setTimeout(() => {\r\n                touchCount.value = 0;\r\n            }, 300); // 300ms内的两次触摸视为双击\r\n        }\r\n\r\n        // 启动长按检测\r\n        setTimeout(() => {\r\n            if (touchCount.value === 1 &&\r\n                Date.now() - touchStartTime.value > 500 && // 长按超过500ms\r\n                !longPressDetected.value) {\r\n                longPressDetected.value = true;\r\n                handleLongPress(idx); // 长按也进入编辑模式，作为双击的备用方案\r\n            }\r\n        }, 500);\r\n\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n    }\r\n\r\n    // 触摸移动 - 处理文字标签拖动\r\n    function handleLabelTouchMove(idx, e) {\r\n        // 获取当前模式（实际应用中应从主组件传入）\r\n        const currentMode = 'text';\r\n        \r\n        // 如果当前不是文本模式或已检测到长按，则退出函数\r\n        if (currentMode !== 'text' || longPressDetected.value) return;\r\n    \r\n        // 获取触摸事件中的第一个触摸点\r\n        const touch = e.touches[0];\r\n\t\t\r\n        \r\n        // 计算触摸点从起始位置移动的水平距离和垂直距离（绝对值）\r\n        const moveX = Math.abs(touch.clientX - touchStartPos.value.x);\r\n        const moveY = Math.abs(touch.clientY - touchStartPos.value.y);\r\n    \r\n        // 如果移动距离超过阈值（5像素），则执行移动操作\r\n        if (moveX > 5 || moveY > 5) {\r\n            // 设置当前移动的标签索引\r\n            movingLabel.value = idx;\r\n\r\n            // 获取包含数字表格的容器元素\r\n            const container = document.querySelector('.numbers-table-container');\r\n            \r\n            // 获取容器的位置信息（如果不存在则使用默认值）\r\n            const containerRect = container ? container.getBoundingClientRect() : { left: 0, top: 0 };\r\n            \r\n            // 计算容器的绝对位置（考虑页面滚动偏移）\r\n            const containerAbsTop = containerRect.top + window.scrollY;\r\n            const containerAbsLeft = containerRect.left + window.scrollX;\r\n    \r\n            // 计算标签的新位置（考虑标签偏移和容器位置）\r\n            let newX = touch.pageX - labelOffset.value.x - containerAbsLeft;\r\n            let newY = touch.pageY - labelOffset.value.y - containerAbsTop;\r\n    \r\n            // 设置标签在画布内的最大Y位置（底部限制）\r\n            const maxY = canvasSize.value.h;\r\n    \r\n            // 限制标签在画布范围内（X轴：0到画布宽度-100，Y轴：0到最大Y值）\r\n            textLabels.value[idx].x = Math.max(0, Math.min(newX, canvasSize.value.w - 100));\r\n            textLabels.value[idx].y = Math.max(0, Math.min(newY, maxY));\r\n\r\n        }\r\n    \r\n        // 阻止事件冒泡和默认行为\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n\t\t// console.log('1'),\r\n    }\r\n\r\n    // 触摸结束 - 清理状态\r\n    function handleLabelTouchEnd(idx, e) {\r\n        const currentMode = 'text'; // 在实际使用中应该从主组件传入\r\n        if (currentMode!== 'text') return;\r\n\r\n        touchEndTime.value = Date.now();\r\n        movingLabel.value = -1;\r\n        longPressDetected.value = false;\r\n\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n    }\r\n\r\n    // 处理单击（鼠标设备）\r\n    function handleLabelClick(idx) {\r\n        const currentMode = 'text'; // 在实际使用中应该从主组件传入\r\n\t\t\r\n        // 仅在非编辑状态下响应\r\n        if (currentMode === 'text' &&!textLabels.value[idx].editing) {\r\n            // 单击不做任何操作，等待可能的双击\r\n        }\r\n    }\r\n\r\n    // 处理双击（鼠标设备）\r\n    function handleLabelDblClick(idx) {\r\n        const currentMode = 'text'; // 在实际使用中应该从主组件传入\r\n        if (currentMode === 'text') {\r\n            editLabel(idx);\r\n        }\r\n    }\r\n\r\n    // 处理双击（触摸设备）\r\n    function handleDoubleTap(idx) {\r\n        editLabel(idx);\r\n    }\r\n\r\n    // 处理长按（作为双击的备用方案）\r\n    function handleLongPress(idx) {\r\n        editLabel(idx);\r\n    }\r\n\r\n    // 添加文字功能\r\n    function addTextLabel() {\r\n        // 获取画布位置，确保文字添加在可见区域且不在前两列\r\n        const canvasRect = document.querySelector('.draw-canvas')?.getBoundingClientRect();\r\n        let x = 100;\r\n        let y = 100;\r\n\r\n        if (canvasRect) {\r\n            // 获取前两列的总宽度\r\n            const table = document.querySelector('.numbers-table');\r\n            if (table) {\r\n                const firstCol = table.querySelector('.col-1');\r\n                const secondCol = table.querySelector('.col-2');\r\n                if (firstCol && secondCol) {\r\n                    const firstColWidth = firstCol.getBoundingClientRect().width;\r\n                    const secondColWidth = secondCol.getBoundingClientRect().width;\r\n                    x = firstColWidth + secondColWidth + 20; // 在前两列右侧添加偏移\r\n                }\r\n            }\r\n            y = canvasRect.height / 3;\r\n        }\r\n\r\n        const newLabel = {\r\n            id: Date.now(), // 唯一ID\r\n            x: x,\r\n            y: y,\r\n            text: '双击或长按编辑',\r\n            editing: false\r\n        };\r\n\r\n        textLabels.value.push(newLabel);\r\n\r\n        // 强制更新DOM\r\n        nextTick(() => {\r\n            const lastIdx = textLabels.value.length - 1;\r\n            editLabel(lastIdx);\r\n        });\r\n    }\r\n\r\n    // 编辑文字标签 - 增强版确保焦点\r\n    function editLabel(idx) {\r\n        const currentMode = 'text'; // 在实际使用中应该从主组件传入\r\n        if (currentMode!== 'text') return;\r\n\r\n        // 退出其他标签的编辑状态\r\n        textLabels.value.forEach((label, i) => {\r\n            label.editing = i === idx;\r\n        });\r\n\r\n        nextTick(() => {\r\n            // 获取文字元素并设置焦点\r\n            const elements = document.querySelectorAll('.text-label');\r\n            if (elements[idx]) {\r\n                const content = elements[idx].querySelector('.text-content');\r\n                if (content) {\r\n                    // 确保元素可编辑\r\n                    content.setAttribute('contenteditable', 'true');\r\n                    content.focus();\r\n\r\n                    // 选中所有文本\r\n                    const range = document.createRange();\r\n                    range.selectNodeContents(content);\r\n                    range.collapse(false); // 光标移到内容末尾\r\n                    const selection = window.getSelection();\r\n                    selection.removeAllRanges();\r\n                    selection.addRange(range);\r\n\r\n                    // 在移动设备上触发虚拟键盘\r\n                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {\r\n                        content.click();\r\n                        setTimeout(() => content.focus(), 100);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    function updateLabelText(idx, e) {\r\n        if (textLabels.value[idx]) {\r\n            textLabels.value[idx].text = e.target.innerText;\r\n        }\r\n    }\r\n\r\n    function finishEditLabel(idx) {\r\n        if (textLabels.value[idx]) {\r\n            textLabels.value[idx].editing = false;\r\n            // 如果文本为空则删除标签\r\n            if (!textLabels.value[idx].text.trim()) {\r\n                textLabels.value.splice(idx, 1);\r\n            }\r\n        }\r\n\t\t\r\n    }\r\n\t\r\n\t\r\n\t\r\n\r\n    return {\r\n        textLabels,\r\n        movingLabel,\r\n        touchStartTime,\r\n        touchStartPos,\r\n        touchEndTime,\r\n        touchCount,\r\n        touchTimer,\r\n        labelOffset,\r\n        longPressDetected,\r\n        handleLabelTouchStart,\r\n        handleLabelTouchMove,\r\n        handleLabelTouchEnd,\r\n        handleLabelClick,\r\n        handleLabelDblClick,\r\n        addTextLabel,\r\n        editLabel,\r\n        updateLabelText,\r\n        finishEditLabel,\r\n        getLabelStyle\r\n    };\r\n}"],"names":["ref","nextTick"],"mappings":"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"}