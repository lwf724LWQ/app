"use strict";const e=require("../../common/vendor.js"),o=require("../../api/apis.js"),t=require("../../utils/request.js"),a=e.defineComponent({__name:"login",setup(a){const n=e.ref("0"),i=e.ref(""),s=e.ref(""),l=e.ref("");e.ref("");const c=e.ref(!0),r=e.ref(!1),u=e.reactive({type:"",account:"",password:""});e.watch([n,i,s,l],(([e,o,t])=>{u.type=e,u.account=o,u.password=t}),{immediate:!0});const d=async()=>{var a;if(c.value)if(i.value&&s.value){e.index.showLoading({title:"登录中..."});try{const s=await o.apilogin(u);if(e.index.hideLoading(),s){if(console.log("登录API返回的完整数据:",s),!(null==(a=s.data)?void 0:a.token))return void e.index.showModal({title:"登录失败",content:"未获取到token，请重试",showCancel:!1});if(t.setToken(s.data.token),!i.value)return void e.index.showModal({title:"登录失败",content:"账号信息异常，请重试",showCancel:!1});t.setAccount(i.value);try{const o=s.data||{};let t="http://video.caimizm.com/himg/user.png";o.himg&&(t=o.himg.startsWith("http")?o.himg:`http://video.caimizm.com/himg/${o.himg}`);const a={nickname:o.uname||"用户",avatar:t,phone:i.value};e.index.setStorageSync("userInfo",a),e.index.setStorageSync("loginData",{uname:o.uname,himg:t,account:i.value}),console.log("登录成功，用户信息已保存:",a),console.log("登录数据已保存:",{uname:o.uname,himg:t,account:i.value});try{const o=e.index.getStorageSync("userAvatars")||{};o[i.value]=t,e.index.setStorageSync("userAvatars",o),console.log("登录时自动保存用户头像:",i.value,t)}catch(n){console.error("保存用户头像到userAvatars失败:",n)}}catch(n){console.error("保存用户信息失败:",n);const o="http://video.caimizm.com/himg/user.png",t={nickname:"用户",avatar:o,phone:i.value};e.index.setStorageSync("userInfo",t),e.index.setStorageSync("loginData",{uname:"用户",himg:o,account:i.value})}e.index.showToast({title:"登录成功",icon:"success",duration:1500}),setTimeout((()=>{e.index.switchTab({url:"/pages/index/index"})}),1500)}else e.index.showModal({title:"登录失败",content:"用户名或密码错误，请重试",showCancel:!1})}catch(n){e.index.hideLoading(),e.index.showModal({title:"登录失败",content:"网络错误，请检查网络连接后重试",showCancel:!1})}}else e.index.showToast({title:"请输入手机号和密码",icon:"none",duration:2e3});else e.index.showToast({title:"请先同意用户协议",icon:"none",duration:2e3})},v=()=>{e.index.navigateTo({url:"/pages/reg/reg"})},g=()=>{e.index.navigateTo({url:"/pages/code-login/code-login?type=forgetPwd"})},h=()=>{e.index.navigateBack()},m=()=>{r.value=!r.value,console.log("密码显示状态:",r.value?"显示":"隐藏")},x=()=>{c.value=!c.value},w=()=>{e.index.showModal({title:"用户协议",content:"这里是用户协议的内容...",showCancel:!1})},p=()=>{e.index.showModal({title:"隐私授权",content:"这里是隐私政策的内容...",showCancel:!1})},f=()=>{c.value?e.index.showModal({title:"微信登录",content:"微信登录功能正在开发中，敬请期待",showCancel:!1,confirmText:"知道了"}):e.index.showToast({title:"请先同意用户协议",icon:"none",duration:2e3})};return(o,t)=>e.e({a:e.o(h),b:i.value,c:e.o((e=>i.value=e.detail.value)),d:r.value?"text":"password",e:s.value,f:e.o((e=>s.value=e.detail.value)),g:r.value?1:"",h:e.o(m),i:e.o(v),j:e.o(g),k:e.o(d),l:c.value},(c.value,{}),{m:c.value?1:"",n:e.o(x),o:e.o(w),p:e.o(p),q:e.o(f)})}}),n=e._export_sfc(a,[["__scopeId","data-v-71f27a27"]]);wx.createPage(n);
