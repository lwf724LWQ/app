"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/request.js"),t=require("../../api/apis.js"),l={__name:"orders",setup(l){const u=e.ref(""),v=e.ref(!1),n=e.ref([]),o=e.ref(!1),r=e.ref(1),i=e.ref(20),s=e.ref(!0),g=e.ref(0),c=e.ref([]),d=e.ref(!1),m=e.ref("month"),f=e.ref(2025),h=e.ref(9),p=e.ref(null),T=e.ref(null),w=["日","一","二","三","四","五","六"],D=e.ref(2023),S=e.ref(10),y=e.ref(0),x=e.ref(0),$=e.ref(0),M=e.ref(0),Y=e.ref(!0),F=e.computed((()=>{let e=n.value;return e=p.value&&T.value?e.filter((e=>{const a=e.updateTime||e.createTime;if(!a)return!1;const t=new Date(a),l=new Date(t.getFullYear(),t.getMonth(),t.getDate()),u=new Date(p.value.getFullYear(),p.value.getMonth(),p.value.getDate()),v=new Date(T.value.getFullYear(),T.value.getMonth(),T.value.getDate());return l.getTime()>=u.getTime()&&l.getTime()<=v.getTime()})):e.filter((e=>{const a=e.updateTime||e.createTime;if(!a)return!1;const t=new Date(a);return t.getFullYear()===f.value&&t.getMonth()+1===h.value})),u.value.trim()&&(e=e.filter((e=>e.orderNo.includes(u.value)||e.info&&e.info.includes(u.value)))),e})),b=e.computed((()=>{const e=f.value,a=h.value,t=new Date(e,a-1,1),l=new Date(e,a,0),u=t.getDay(),v=l.getDate(),n=[];for(let o=0;o<u;o++)n.push({date:"",isEmpty:!0});for(let o=1;o<=v;o++){const t=new Date(e,a-1,o),l=new Date,u=t.getFullYear()===l.getFullYear()&&t.getMonth()===l.getMonth()&&t.getDate()===l.getDate(),v=p.value&&t.getTime()===p.value.getTime(),r=T.value&&t.getTime()===T.value.getTime(),i=p.value&&T.value&&t.getTime()>=p.value.getTime()&&t.getTime()<=T.value.getTime();n.push({date:o,fullDate:t,isStart:v,isEnd:r,isInRange:i,isToday:u,isEmpty:!1})}return n})),N=e.computed((()=>{const e=(new Date).getFullYear(),a=[];for(let t=e-5;t<=e+2;t++)a.push(t);return a})),E=e.computed((()=>[1,2,3,4,5,6,7,8,9,10,11,12])),_=e.computed((()=>{if("range"===m.value&&p.value&&T.value){const e=H(p.value),a=H(T.value);return e===a?e:`${e} - ${a}`}return"range"===m.value&&p.value?H(p.value):`${f.value}年${h.value}月`}));e.computed((()=>"range"===m.value&&(p.value||T.value)));const k=()=>{e.index.navigateBack()},q=()=>{d.value=!0,D.value=f.value,S.value=h.value,"range"===m.value&&(p.value||(p.value=new Date(2025,8,3)),T.value||(T.value=new Date(2025,9,2)))},O=()=>{d.value=!1},j=e=>{m.value=e},A=e=>e.isEmpty?"empty":e.isStart?"start-date":e.isEnd?"end-date":e.isInRange?"in-range":"normal",H=e=>e?`${e.getFullYear()}年${e.getMonth()+1}月${e.getDate()}日`:"",I=e=>{if(!e)return"";return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`},Q=async()=>{"month"===m.value?(f.value=D.value,h.value=S.value,p.value=null,T.value=null):"range"===m.value&&(p.value&&!T.value&&(T.value=new Date(p.value)),p.value&&(f.value=p.value.getFullYear(),h.value=p.value.getMonth()+1)),O(),r.value=1,await G(!0)},R=()=>{1===h.value?(h.value=12,f.value-=1):h.value-=1},X=()=>{12===h.value?(h.value=1,f.value+=1):h.value+=1},B=()=>{m.value="month",D.value=f.value,S.value=h.value},C=e=>{if(!Y.value)return;const a=e.touches[0];$.value=a.clientY,M.value=a.clientX},P=e=>{},z=e=>{if(!Y.value)return;const a=e.changedTouches[0],t=a.clientY-$.value,l=a.clientX-M.value;Math.abs(t)>Math.abs(l)&&Math.abs(t)>50&&(t>0?R():X())},G=async(l=!1)=>{var v,c,d,m,w,D;try{o.value=!0;const S=a.getToken(),y=a.getAccount();if(!S)return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/login/login"})}),1500);if(!y){const a={account:S||"default_user",page:r.value.toString(),limit:i.value.toString()};u.value.trim()&&(a.orderNo=u.value.trim()),p.value&&T.value?(a.startDate=I(p.value),a.endDate=I(T.value)):(a.year=f.value.toString(),a.month=h.value.toString());const m=await t.apiOrderQuery(a);if(200===m.code){const e=(null==(v=m.data)?void 0:v.records)||[];l?(n.value=e,r.value=1):1===r.value?n.value=e:n.value=[...n.value,...e];const a=(null==(c=m.data)?void 0:c.pages)||1;s.value=r.value<a,g.value=(null==(d=m.data)?void 0:d.total)||0}else e.index.showToast({title:m.msg||"获取订单失败",icon:"none"});return void(o.value=!1)}const x={account:y,page:r.value.toString(),limit:i.value.toString()};u.value.trim()&&(x.orderNo=u.value.trim());const $=await t.apiOrderQuery(x);if(200===$.code){const e=(null==(m=$.data)?void 0:m.records)||[];l?(n.value=e,r.value=1):1===r.value?n.value=e:n.value=[...n.value,...e];const a=(null==(w=$.data)?void 0:w.pages)||1;s.value=r.value<a,g.value=(null==(D=$.data)?void 0:D.total)||0}else e.index.showToast({title:$.msg||"获取订单失败",icon:"none"})}catch(S){e.index.showToast({title:"网络错误，请重试",icon:"none"})}finally{o.value=!1}},J=e=>{if(!e)return"";const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},K=e=>({0:"待支付",1:"已支付",2:"已取消",3:"已完成"}[e]||"未知状态"),L=()=>{v.value=!0},U=()=>{setTimeout((()=>{u.value.trim()||(v.value=!1)}),200)},V=()=>{console.log("搜索关键词:",u.value),u.value.trim()||(r.value=1,G(!0))},W=()=>{u.value="",v.value=!1,r.value=1,G(!0)},Z=async()=>{u.value.trim()?(ee(u.value.trim()),console.log("执行订单搜索:",u.value.trim()),r.value=1,await G(!0)):e.index.showToast({title:"请输入订单号",icon:"none"})},ee=a=>{if(!a||a.length<3)return;const t=c.value.indexOf(a);t>-1&&c.value.splice(t,1),c.value.unshift(a),c.value.length>5&&(c.value=c.value.slice(0,5)),e.index.setStorageSync("orderSearchHistory",c.value)},ae=async()=>{s.value&&!o.value&&(r.value++,await G(!1))};return e.onMounted((async()=>{const t=a.getToken(),l=a.getAccount();t?l?((()=>{try{const a=e.index.getStorageSync("orderSearchHistory");a&&Array.isArray(a)&&(c.value=a)}catch(a){console.error("加载搜索历史失败:",a)}})(),await G()):(e.index.showToast({title:"用户信息异常，请重新登录",icon:"none"}),setTimeout((()=>{e.index.navigateTo({url:"/pages/login/login"})}),1500)):(e.index.showToast({title:"请先登录",icon:"none"}),setTimeout((()=>{e.index.navigateTo({url:"/pages/login/login"})}),1500))})),(a,t)=>e.e({a:e.o(k),b:v.value},v.value?{c:e.o(U),d:e.o([e=>u.value=e.detail.value,V]),e:e.o(Z),f:v.value,g:u.value}:{},{h:v.value&&u.value},v.value&&u.value?{i:e.o(W)}:{},{j:v.value},v.value?{k:e.o(Z)}:{},{l:e.o(L),m:v.value&&c.value.length>0&&!u.value},v.value&&c.value.length>0&&!u.value?{n:e.f(c.value,((a,t,l)=>({a:e.t(a),b:t,c:e.o((e=>{return t=a,u.value=t,void Z();var t}),t)})))}:{},{o:e.t(_.value),p:e.o(q),q:n.value.length>0},n.value.length>0?e.e({r:u.value.trim()},u.value.trim()?{s:e.t(u.value),t:e.t(F.value.length)}:p.value&&T.value?e.e({w:H(p.value)===H(T.value)},H(p.value)===H(T.value)?{x:e.t(H(p.value)),y:e.t(F.value.length)}:{z:e.t(H(p.value)),A:e.t(H(T.value)),B:e.t(F.value.length)}):{C:e.t(f.value),D:e.t(h.value),E:e.t(F.value.length)},{v:p.value&&T.value}):{},{F:n.value.length>0},n.value.length>0?{G:e.f(F.value,((a,t,l)=>{return{a:e.t(a.orderNo),b:e.t(J(a.updateTime||a.createTime)),c:e.t(K(a.status)),d:e.n((u=a.status,{0:"status-pending",1:"status-paid",2:"status-cancelled",3:"status-completed"}[u]||"status-unknown")),e:e.t(a.info||"订单详情"),f:e.t(a.amount),g:a.orderNo,h:e.o((t=>(a=>{e.index.showModal({title:"订单详情",content:`订单号：${a.orderNo}\n金额：¥${a.amount}\n状态：${K(a.status)}\n时间：${J(a.updateTime||a.createTime)}`,showCancel:!1})})(a)),a.orderNo)};var u}))}:o.value?{}:e.e({I:u.value.trim()},u.value.trim()?{}:p.value&&T.value?e.e({K:H(p.value)===H(T.value)},(H(p.value),H(T.value),{})):{},{J:p.value&&T.value,L:u.value.trim()},u.value.trim()?{}:p.value&&T.value?e.e({N:H(p.value)===H(T.value)},(H(p.value),H(T.value),{})):{},{M:p.value&&T.value}),{H:!o.value,O:n.value.length>0&&s.value},n.value.length>0&&s.value?{P:e.t(o.value?"加载中...":"加载更多"),Q:e.o(ae),R:o.value}:{},{S:o.value&&0===n.value.length},(o.value&&n.value.length,{}),{T:d.value},d.value?e.e({U:e.o(O),V:"month"===m.value?1:"",W:e.o((e=>j("month"))),X:"range"===m.value?1:"",Y:e.o((e=>j("range"))),Z:"range"===m.value},"range"===m.value?{aa:e.t(p.value?H(p.value):"请选择"),ab:e.t(T.value?H(T.value):"请选择")}:{},{ac:"month"===m.value},"month"===m.value?{ad:e.f(N.value,((a,t,l)=>({a:e.t(a),b:a,c:D.value===a?1:"",d:e.o((e=>(e=>{D.value=e;const a=N.value.indexOf(e);y.value=60*a})(a)),a)}))),ae:y.value,af:e.f(E.value,((a,t,l)=>({a:e.t(a),b:a,c:S.value===a?1:"",d:e.o((e=>(e=>{S.value=e;const a=E.value.indexOf(e);x.value=60*a})(a)),a)}))),ag:x.value}:{ah:e.o(R),ai:e.t(f.value),aj:e.t(h.value),ak:e.o(B),al:e.o(X),am:e.f(w,((a,t,l)=>({a:e.t(a),b:a}))),an:e.f(b.value,((a,t,l)=>e.e({a:e.t(a.date),b:a.isStart},(a.isStart,{}),{c:a.isToday},(a.isToday,{}),{d:t,e:e.n(A(a)),f:e.o((e=>(e=>{e.isEmpty||"range"===m.value&&(!p.value||p.value&&T.value?(p.value=e.fullDate,T.value=null):p.value&&!T.value&&(e.fullDate.getTime()>=p.value.getTime()?T.value=e.fullDate:(T.value=p.value,p.value=e.fullDate)))})(a)),t)}))),ao:e.o(C),ap:e.o(P),aq:e.o(z)},{ar:e.o(O),as:e.o(Q),at:e.o((()=>{})),av:e.o(O)}):{})}},u=e._export_sfc(l,[["__scopeId","data-v-04949608"]]);wx.createPage(u);
