"use strict";const e=require("../../common/vendor.js"),t=require("../../api/apis.js"),n=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const a={__name:"pattern-predict",setup(a){const i=e.ref(""),o=e.ref([]),s=e.ref([]),c=e.ref(null),l=e.ref([]),d=e.ref(!1),u=e.ref(!1),r=e.computed((()=>s.value.length>0&&o.value.length>0));e.onMounted((()=>{v(),g()})),e.onShow((()=>{g()}));const h=e=>{const t=e.data,n=[];if("二字现"===e.id||"三字现"===e.id)t.combinations&&t.combinations.length>0?n.push(`组合: ${t.combinations.join(",")}`):n.push("组合: 未选择");else{if(t.thousands&&t.thousands.length>0){let e=`千位: ${t.thousands.join("")}`;t.thousandsMainAttack&&t.thousandsMainAttack.length>0&&(e+=` 主攻${t.thousandsMainAttack.join("")}`),t.thousandsKeyPoint&&t.thousandsKeyPoint.length>0&&(e+=` 重点${t.thousandsKeyPoint.join("")}`),n.push(e)}if(t.hundreds&&t.hundreds.length>0){let e=`百位: ${t.hundreds.join("")}`;t.hundredsMainAttack&&t.hundredsMainAttack.length>0&&(e+=` 主攻${t.hundredsMainAttack.join("")}`),t.hundredsKeyPoint&&t.hundredsKeyPoint.length>0&&(e+=` 重点${t.hundredsKeyPoint.join("")}`),n.push(e)}if(t.tens&&t.tens.length>0){let e=`十位: ${t.tens.join("")}`;t.tensMainAttack&&t.tensMainAttack.length>0&&(e+=` 主攻${t.tensMainAttack.join("")}`),t.tensKeyPoint&&t.tensKeyPoint.length>0&&(e+=` 重点${t.tensKeyPoint.join("")}`),n.push(e)}if(t.units&&t.units.length>0){let e=`个位: ${t.units.join("")}`;t.unitsMainAttack&&t.unitsMainAttack.length>0&&(e+=` 主攻${t.unitsMainAttack.join("")}`),t.unitsKeyPoint&&t.unitsKeyPoint.length>0&&(e+=` 重点${t.unitsKeyPoint.join("")}`),n.push(e)}0===n.length&&n.push("未选择")}return n},g=()=>{try{const t=e.index.getStorageSync("predict_schemes_data");t&&t.addedSchemes&&Array.isArray(t.addedSchemes)?s.value=t.addedSchemes:s.value=[]}catch(t){s.value=[]}},v=async()=>{if(u.value)console.log("正在加载期号信息，跳过重复请求");else try{u.value=!0;const n=e.index.getStorageSync("currentLotteryType");if(c.value=n||{id:16,code:16,name:"排列三"},!c.value||!c.value.id)return;e.index.showLoading({title:"加载期号中..."});const a=await t.apiGetIssueNo({cpid:c.value.id});if(e.index.hideLoading(),200===a.code&&null!==a.data&&void 0!==a.data){let t=null,n="待开奖",o="今天 21:30";"number"==typeof a.data||"string"==typeof a.data?t=a.data.toString():"object"==typeof a.data&&(t=a.data.issueno||a.data.number||a.data.id,n=a.data.status||"待开奖",o=a.data.time||"今天 21:30"),i.value=t||"0",e.index.showToast({title:`期号加载成功: ${i.value}`,icon:"success"})}else i.value="0",e.index.showToast({title:"使用默认期号: 0",icon:"none"})}catch(n){e.index.hideLoading(),console.error("加载期号信息失败:",n),i.value="0",e.index.showToast({title:"期号加载异常，使用默认期号: 0",icon:"none"})}finally{u.value=!1}},p=()=>{e.index.navigateBack()},y=()=>{console.log("=== 规律帖跳转到方案页面 ==="),console.log("当前页面:","pages/pattern-predict/pattern-predict");const t={lotteryType:c.value,issueInfo:{id:i.value,number:i.value,status:"待开奖",time:"今天 21:30"},schemes:s.value};e.index.navigateTo({url:`/pages/predict-scheme/predict-scheme?data=${encodeURIComponent(JSON.stringify(t))}`,success:()=>{},fail:t=>{e.index.showToast({title:"跳转失败",icon:"none"})}})},m=async()=>{if(d.value)return void e.index.showToast({title:"图片正在上传中，请稍候",icon:"none"});const n=6-o.value.length;if(n<=0)e.index.showToast({title:"最多只能选择6张图片",icon:"none"});else try{const a=await e.index.chooseImage({count:n,sizeType:["compressed"],sourceType:["album","camera"]});if(a.tempFilePaths&&a.tempFilePaths.length>0){e.index.showLoading({title:"上传图片中..."}),d.value=!0;const n=a.tempFilePaths.map((async(e,n)=>{try{let a;if("undefined"!=typeof window){const t=await fetch(e),i=await t.blob();a=new File([i],`pattern-image-${n}.jpg`,{type:"image/jpeg"})}else a=e;return new Promise(((n,i)=>{(async(e,n)=>{try{let a=e.name||"";a.split(".").slice(0,a.split(".").length-1).join(".");const i=(new Date).getTime()+"."+a.split(".")[a.split(".").length-1];let o=await t.getCOSSecretKey({});if(200!==o.code)throw new Error("获取上传凭证失败");const s=await"../../common/vendor.js".then((e=>e.aliyunOssSdk)),c={region:o.data.region||"cn-guangzhou",accessKeyId:o.data.STSaccessKeyId,accessKeySecret:o.data.STSsecretAccessKey,stsToken:o.data.security_token,bucket:o.data.bucket||"cjvd",endpoint:"https://oss-cn-guangzhou.aliyuncs.com",refreshSTSToken:async()=>{const e=await t.getCOSSecretKey({});return{accessKeyId:e.data.STSaccessKeyId,accessKeySecret:e.data.STSsecretAccessKey,stsToken:e.data.security_token}},refreshSTSTokenInterval:3e5},l=new s.default(c),d=await l.put(`himg/${i}`,e);if(!d||!d.url)throw new Error("上传失败");n(`http://video.caimizm.com/himg/${i}`)}catch(a){throw a}})(a,(t=>{n({tempFilePath:e,url:t})}))}))}catch(a){throw a}})),i=await Promise.all(n);i.forEach((({tempFilePath:e,url:t})=>{o.value.push(e),l.value.push(t)})),e.index.hideLoading(),e.index.showToast({title:`成功上传${i.length}张图片`,icon:"success"}),d.value=!1}}catch(a){e.index.hideLoading(),d.value=!1,e.index.showToast({title:"图片上传失败",icon:"none"})}},f=()=>{let e="【规律预测】\n\n";s.value.length>0&&s.value.forEach(((t,n)=>{e+=`${n+1}. [${t.id}]\n`;h(t).forEach((t=>{e+=`   ${t}\n`})),e+="\n"}));const t=i.value||"0";return e+=`期号: 第${t}期\n`,e+=`发布时间: ${(new Date).toLocaleString()}`,e},w=async()=>{if(r.value)if(l.value&&0!==l.value.length)try{e.index.showLoading({title:"发布中..."});let s="";const d=e.index.getStorageSync("loginData")||{};d.himg&&(s=d.himg);const u={tname:c.value?`${c.value.name}-规律预测`:"规律预测",issueno:parseInt(i.value)||0,content:f(),account:n.getAccount()||"",pimg:l.value.join(","),flag:!1};if(!u.account)return void e.index.showToast({title:"账号信息缺失，请重新登录",icon:"none"});if(null===u.issueno||void 0===u.issueno||""===u.issueno)return void e.index.showToast({title:"期号信息缺失",icon:"none"});if(!u.content)return void e.index.showToast({title:"发帖内容为空",icon:"none"});if(!u.pimg||""===u.pimg.trim())return void e.index.showToast({title:"请至少上传一张图片",icon:"none"});const r=await t.apiPost(u);if(e.index.hideLoading(),200===r.code){try{const t=e.index.getStorageSync("userAvatars")||{};t[n.getAccount()]=s,e.index.setStorageSync("userAvatars",t)}catch(a){}e.index.showToast({title:"规律帖已提交审核",icon:"success"}),e.index.removeStorageSync("predict_schemes_data"),o.value=[],l.value=[],setTimeout((()=>{e.index.navigateBack()}),1500)}else e.index.showToast({title:r.msg||"发布失败",icon:"none"})}catch(a){e.index.hideLoading(),e.index.showToast({title:"发布失败，请重试",icon:"none"})}else e.index.showToast({title:"请等待图片上传完成",icon:"none"});else e.index.showToast({title:"请完善方案和图片",icon:"none"})};return(t,n)=>e.e({a:e.p({type:"left",size:"20",color:"#333"}),b:e.o(p),c:e.t(i.value),d:s.value.length>0},s.value.length>0?{e:e.t(i.value),f:e.f(s.value,((t,n,a)=>({a:e.t(t.id),b:e.f(h(t),((t,n,a)=>({a:e.t(t),b:n}))),c:n})))}:{},{g:e.o(y),h:o.value.length>0},o.value.length>0?{i:e.f(o.value,((t,n,a)=>({a:t,b:"740fe735-1-"+a,c:e.o((e=>(e=>{o.value.splice(e,1),l.value.splice(e,1)})(n)),n),d:n}))),j:e.p({type:"close",size:"16",color:"#fff"})}:{},{k:o.value.length<6},o.value.length<6?{l:e.p({type:"camera",size:"40",color:"#ccc"}),m:e.t(o.value.length),n:e.o(m)}:{},{o:e.o(y),p:r.value?"":1,q:e.o(w)})}},i=e._export_sfc(a,[["__scopeId","data-v-740fe735"]]);wx.createPage(i);
