"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/request.js"),n=require("../../api/apis.js"),o={__name:"predict-publish",setup(o){const a=e.ref([]),s=e.ref(""),i=e.ref(!1);e.ref("");const c=e.ref(!1),l=e.ref(null),d=e.ref({id:null,number:null,status:"待开奖",time:"今天 21:30"}),r=e.ref(!1),u=e.ref(!1),h=e.ref(!1),g=e=>{const t=e.data,n=[];if("二字现"===e.id||"三字现"===e.id)t.combinations&&t.combinations.length>0?n.push(t.combinations.join(",")):n.push("未选择");else{if(t.thousands&&t.thousands.length>0){let e=`千位: ${t.thousands.join("")}`;t.thousandsMainAttack&&t.thousandsMainAttack.length>0&&(e+=` 主攻${t.thousandsMainAttack.join("")}`),t.thousandsKeyPoint&&t.thousandsKeyPoint.length>0&&(e+=` 重点${t.thousandsKeyPoint.join("")}`),n.push(e)}if(t.hundreds&&t.hundreds.length>0){let e=`百位: ${t.hundreds.join("")}`;t.hundredsMainAttack&&t.hundredsMainAttack.length>0&&(e+=` 主攻${t.hundredsMainAttack.join("")}`),t.hundredsKeyPoint&&t.hundredsKeyPoint.length>0&&(e+=` 重点${t.hundredsKeyPoint.join("")}`),n.push(e)}if(t.tens&&t.tens.length>0){let e=`十位: ${t.tens.join("")}`;t.tensMainAttack&&t.tensMainAttack.length>0&&(e+=` 主攻${t.tensMainAttack.join("")}`),t.tensKeyPoint&&t.tensKeyPoint.length>0&&(e+=` 重点${t.tensKeyPoint.join("")}`),n.push(e)}if(t.units&&t.units.length>0){let e=`个位: ${t.units.join("")}`;t.unitsMainAttack&&t.unitsMainAttack.length>0&&(e+=` 主攻${t.unitsMainAttack.join("")}`),t.unitsKeyPoint&&t.unitsKeyPoint.length>0&&(e+=` 重点${t.unitsKeyPoint.join("")}`),n.push(e)}0===n.length&&n.push("未选择")}return n},v=()=>{e.index.navigateBack({delta:1,success:()=>{e.index.$emit("modifySchemes",a.value)}})},y=async()=>{e.index.showModal({title:"确认发布",content:"确定要发布这些方案吗？发布后将无法修改或删除。",success:async e=>{e.confirm&&await m()}})},f=async()=>{if(s.value)try{i.value=!0,e.index.showLoading({title:"追加中..."});const t=await p(),o=await n.apiPostUpdate({id:s.value,content:t});e.index.hideLoading(),200===o.code?(e.index.showToast({title:"追加成功",icon:"success"}),e.index.removeStorageSync("appendPostData"),e.index.removeStorageSync("currentAppendPostData"),e.index.removeStorageSync("appendModeTipShown"),setTimeout((()=>{e.index.reLaunch({url:"/pages/forum/forum"})}),1500)):e.index.showToast({title:o.msg||"追加失败",icon:"none"})}catch(t){e.index.hideLoading(),e.index.showToast({title:"追加失败，请重试",icon:"none"})}finally{i.value=!1}else e.index.showToast({title:"帖子ID缺失",icon:"none"})},p=async()=>{var t;try{let i="";if(s.value)try{const e=await n.apiPostListQuery({page:1,size:50,tname:(null==(t=currentLotteryType.value)?void 0:t.name)||"预测方案"});if(200===e.code&&e.data&&e.data.records&&Array.isArray(e.data.records)){const t=e.data.records.find((e=>e.id==s.value));t&&(i=t.content||"")}}catch(o){const t=e.index.getStorageSync("currentAppendPostData");t&&t.postContent&&(i=t.postContent)}let c="\n\n--- 追加内容 ---\n";c+=`追加时间: ${(new Date).toLocaleString()}\n`,a.value.length>0?(c+="\n追加方案:\n",a.value.forEach(((e,t)=>{c+=`${t+1}. [${e.id}]\n`;g(e).forEach((e=>{c+=`   ${e}\n`}))}))):c+="\n追加内容: 方案数据\n";return i+c}catch(o){let e="\n\n--- 追加内容 ---\n";return e+=`追加时间: ${(new Date).toLocaleString()}\n`,a.value.length>0&&(e+="\n追加方案:\n",a.value.forEach(((t,n)=>{e+=`${n+1}. [${t.id}]\n`;g(t).forEach((t=>{e+=`   ${t}\n`}))}))),e}},m=async()=>{try{e.index.showLoading({title:"发布中..."});const o={tname:l.value?l.value.name:"预测方案",issueno:x(),content:I(),account:t.getAccount()||"",pimg:"",flag:!0};console.log("发帖数据:",o);const a=await n.apiPost(o);e.index.hideLoading(),200===a.code?(a.data&&a.data.id&&(s.value=a.data.id,e.index.setStorageSync("currentPostId",a.data.id),P(a.data.id)),e.index.showToast({title:"发布成功",icon:"success"}),e.index.removeStorageSync("predict_schemes_data"),setTimeout((()=>{e.index.reLaunch({url:"/pages/forum/forum"})}),1500)):e.index.showToast({title:a.msg||"发布失败",icon:"none"})}catch(o){e.index.hideLoading(),e.index.showToast({title:"发布失败，请重试",icon:"none"})}},x=()=>d.value.number||d.value.id||"--",S=async e=>{if(u.value)console.log("正在加载帖子详情，跳过重复请求");else try{u.value=!0,console.log("=== 获取帖子详细信息 ==="),console.log("帖子ID:",e);const t=await n.apiPostListQuery({page:1,size:1,id:e});if(200===t.code&&t.data&&t.data.records&&t.data.records.length>0){const e=t.data.records[0];console.log("帖子详情:",e),e.content&&w(e.content)}}catch(t){console.error("获取帖子详情失败:",t)}finally{u.value=!1}},$=async t=>{if(h.value)console.log("正在加载用户帖子，跳过重复请求");else try{h.value=!0,console.log("=== 获取用户已发布帖子 ==="),console.log("方案ID:",t);const o=await n.apiPostListQuery({page:1,size:20,account:e.index.getStorageSync("account")||""});if(200===o.code&&o.data&&o.data.records){const e=o.data.records.find((e=>e.content&&e.content.includes(t)));e?(s.value=e.id,console.log(`找到方案 ${t} 对应的帖子:`,e.id),w(e.content)):console.log(`未找到包含方案 ${t} 的帖子`)}}catch(o){console.error("获取用户已发布帖子失败:",o)}finally{h.value=!1}},w=t=>{try{console.log("=== 解析帖子内容 ==="),console.log("帖子内容:",t);const n=e.index.getStorageSync("predict_schemes_data");if(console.log("本地存储的方案数据:",n),n&&n.schemeData){const e=Object.keys(n.schemeData).find((e=>t.includes(e)));if(e){const t={id:e,name:e,data:n.schemeData[e]};a.value=[t],console.log("解析出的方案数据:",t)}}}catch(n){console.error("解析帖子内容失败:",n)}},P=t=>{try{const n=(new Date).toDateString(),o=e.index.getStorageSync(`publishedSchemes_${n}`)||[],s=e.index.getStorageSync(`publishedPosts_${n}`)||{};a.value.forEach((e=>{const n=e.id;o.includes(n)||o.push(n),s[n]=t})),e.index.setStorageSync(`publishedSchemes_${n}`,o),e.index.setStorageSync(`publishedPosts_${n}`,s),console.log("已保存发布数据:",{publishedSchemes:o,publishedPosts:s,postId:t})}catch(n){console.error("保存已发布方案数据失败:",n)}},I=()=>{if(0===a.value.length)return"暂无方案数据";let e="【预测方案】\n\n";return a.value.forEach(((t,n)=>{e+=`${n+1}. ${t.name} (${t.id})\n`;g(t).forEach((t=>{e+=`   ${t}\n`})),e+="\n"})),e+=`期号: 第${x()}期\n`,e+=`发布时间: ${(new Date).toLocaleString()}`,e},b=()=>{e.index.showModal({title:"提示",content:"返回会清空内容,确定返回吗?",confirmText:"确定",cancelText:"取消",confirmColor:"#ff4757",success:t=>{if(t.confirm){try{e.index.removeStorageSync("predict_schemes_data")}catch(n){console.error("清除本地存储失败:",n)}e.index.reLaunch({url:"/pages/forum/forum"})}}})};return e.onMounted((()=>{const t=getCurrentPages(),o=t[t.length-1].options;if(console.log("=== 页面加载调试信息 ==="),console.log("页面参数:",o),o.postId)s.value=o.postId,e.index.setStorageSync("currentPostId",o.postId),console.log("接收到帖子ID，进入追帖模式:",o.postId),c.value=!0,console.log("追帖模式已设置:",c.value),o.schemeId&&(console.log("加载方案数据:",o.schemeId),(async t=>{try{console.log("=== 加载追帖方案数据 ==="),console.log("方案ID:",t);const n=(new Date).toDateString(),o=e.index.getStorageSync(`publishedPosts_${n}`)||{};console.log("已发布的帖子映射:",o);const a=o[t];a?(s.value=a,console.log(`加载方案 ${t} 对应的帖子ID:`,a),await S(a)):(console.log(`未找到方案 ${t} 对应的帖子ID`),await $(t))}catch(n){console.error("加载追帖方案数据失败:",n)}})(o.schemeId));else{const t=e.index.getStorageSync("currentPostId");if(t){const n=e.index.getStorageSync("appendPostData");n&&n.postId===t?(s.value=t,c.value=!0,console.log("从本地存储恢复追帖模式:",t)):(e.index.removeStorageSync("currentPostId"),console.log("清除残留的帖子ID，确保新帖模式"))}}if(console.log("最终状态 - 帖子ID:",s.value,"追帖模式:",c.value),o.data)try{const t=JSON.parse(decodeURIComponent(o.data));a.value=t.schemes||[],l.value=t.lotteryType||null,d.value=t.issueInfo||{id:null,number:null,status:"待开奖",time:"今天 21:30"},d.value.number||d.value.id||(async()=>{if(r.value)console.log("正在加载期号信息，跳过重复请求");else try{if(r.value=!0,!l.value||!l.value.id)return;e.index.showLoading({title:"加载期号中..."});const t=await n.apiGetIssueNo({cpid:l.value.id});if(e.index.hideLoading(),200===t.code&&null!==t.data&&void 0!==t.data){let n=null,o="待开奖",a="今天 21:30";"number"==typeof t.data||"string"==typeof t.data?n=t.data.toString():"object"==typeof t.data&&(n=t.data.issueno||t.data.number||t.data.id,o=t.data.status||"待开奖",a=t.data.time||"今天 21:30"),d.value={id:n,number:n,status:o,time:a},e.index.showToast({title:`期号加载成功: ${n}`,icon:"success"})}else e.index.showToast({title:"期号数据为空",icon:"none"})}catch(t){e.index.hideLoading(),console.error("加载期号信息失败:",t),e.index.showToast({title:"期号加载异常",icon:"none"})}finally{r.value=!1}})()}catch(i){e.index.showToast({title:"数据解析失败",icon:"none"})}else if(o.schemes)try{const e=decodeURIComponent(o.schemes);a.value=JSON.parse(e)}catch(i){e.index.showToast({title:"数据解析失败",icon:"none"})}else a.value=[],e.index.showToast({title:"没有方案数据",icon:"none"})})),(t,n)=>e.e({a:e.o(b),b:e.f(a.value,((t,n,o)=>({a:e.t(t.name),b:e.t(t.id),c:e.f(g(t),((t,n,o)=>({a:e.t(t),b:n}))),d:n}))),c:0===a.value.length},(a.value.length,{}),{d:e.t(l.value?l.value.name:"彩票类型"),e:e.t(x()),f:e.t(d.value.status),g:s.value||c.value},s.value||c.value?{h:e.t(s.value),i:e.t(i.value?"追加中...":"追加发帖"),j:i.value?1:"",k:e.o(f)}:{},{l:!c.value},c.value?{}:{m:e.o(v),n:e.o(y)},{o:c.value},(c.value,{}))}},a=e._export_sfc(o,[["__scopeId","data-v-b00b9307"]]);wx.createPage(a);
