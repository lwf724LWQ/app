"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/request.js"),t=require("../../api/apis.js"),o={__name:"recharge",setup(o){const l=e.ref("vfmumq"),n=e.ref(0),u=e.ref(10),i=e.ref(""),c=e.ref(!1),v=e.ref(!1),s=e.ref(200),r=e.ref(""),d=e.ref(""),h=e.ref(null),w=e.ref(!1),x=e.ref(!1),f=e.ref(""),g=e.ref(!1),p=e.computed((()=>i.value&&i.value>0?i.value:u.value)),y=e.computed((()=>c.value&&p.value>0)),m=()=>{e.index.navigateBack()},T=()=>{e.index.showModal({title:"充值说明",content:"1元=1金币，金币仅限平台内使用，充值后不可退还。",showCancel:!1})},U=e=>{u.value=e,i.value=""},$=()=>{i.value&&i.value>0&&(u.value=0)},q=()=>{c.value=!c.value},F=()=>{e.index.showModal({title:"充值服务协议",content:"这里是充值服务协议的内容...",showCancel:!1})},M=()=>{e.index.navigateTo({url:"/pages/transaction/transaction"})},_=()=>{y.value&&e.index.showModal({title:"确认支付",content:`确认支付 ¥${p.value}元 购买 ${p.value}个金币？`,success:e=>{e.confirm&&C()}})},C=async()=>{e.index.showLoading({title:"处理中..."});try{const o={info:`用户充值${p.value}元`,amount:p.value.toString(),type:0,account:a.getAccount()||l.value,payType:0,channel:0},n=await t.apiUserRecharge(o);e.index.hideLoading(),200===n.code?n.data&&n.data.coreUrl&&n.data.coreUrl.includes("weixin://wxpay")?(f.value=n.data.orderNo||`ORDER_${Date.now()}`,r.value=n.data.coreUrl,v.value=!0,setTimeout((()=>{I(n.data.coreUrl),A()}),100)):(e.index.showToast({title:n.msg||"充值成功",icon:"success"}),await D(),e.index.showModal({title:"支付成功",content:`恭喜您！成功充值${p.value}个金币`,showCancel:!1,success:()=>{k(),setTimeout((()=>{e.index.navigateTo({url:"/pages/orders/orders"})}),500)}}),u.value=10,i.value="",c.value=!1):e.index.showToast({title:n.msg||"充值失败",icon:"none"})}catch(o){e.index.hideLoading(),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},D=async()=>{if(g.value)console.log("正在加载用户信息，跳过重复请求");else try{g.value=!0;const e=a.getAccount();if(e){l.value=e;const a=await t.apiGetUserBalance({account:e});200===a.code&&(n.value=a.data||0)}}catch(e){console.error("获取用户信息失败:",e)}finally{g.value=!1}},I=e=>{try{"../../common/vendor.js".then((e=>e.browser)).then((a=>{a.toDataURL(e,{width:s.value,height:s.value,margin:2,color:{dark:"#000000",light:"#FFFFFF"}},((a,t)=>{a?j(e):d.value=t}))})).catch((a=>{j(e)}))}catch(a){j(e)}},j=a=>{try{const e=encodeURIComponent(a),t=`https://api.qrserver.com/v1/create-qr-code/?size=${s.value}x${s.value}&data=${e}`;d.value=t}catch(t){e.index.showToast({title:"二维码生成失败",icon:"none"})}},L=()=>{B(),v.value=!1,r.value="",d.value="",f.value=""},R=async()=>{try{x.value=!0,await D(),u.value=10,i.value="",c.value=!1,setTimeout((()=>{x.value=!1}),1e3)}catch(a){x.value=!1,e.index.showToast({title:"刷新失败",icon:"none",duration:2e3})}},k=async()=>{try{await D(),u.value=10,i.value="",c.value=!1}catch(e){}},G=async()=>{try{B(),await D(),e.index.showModal({title:"支付成功",content:`恭喜您！成功充值${p.value}个金币`,showCancel:!1,success:()=>{k(),setTimeout((()=>{e.index.navigateTo({url:"/pages/orders/orders"})}),500)}}),L(),u.value=10,i.value="",c.value=!1}catch(a){}},A=()=>{h.value&&clearInterval(h.value),w.value=!0;let a=0;const o=Date.now();h.value=setInterval((async()=>{try{a++;const n=await t.apiGetOrderPayStatus({orderNo:f.value});if(200===n.code){const t=n.data;if("success"===t||"paid"===t||1===t)return B(),void(await G());if(("failed"===t||"cancelled"===t||0===t)&&a>=5)return B(),e.index.showToast({title:"支付失败，请重试",icon:"none",duration:3e3}),void L()}if(Date.now()-o>=6e4){B();try{const a=await t.apiGetOrderPayStatus({orderNo:f.value});if(200===a.code){const t=a.data;"success"===t||"paid"===t||1===t?await G():(e.index.showToast({title:"支付失败，请重试",icon:"none",duration:3e3}),L())}else e.index.showToast({title:"支付失败，请重试",icon:"none",duration:3e3}),L()}catch(l){e.index.showToast({title:"支付失败，请重试",icon:"none",duration:3e3}),L()}return}}catch(l){a>=20&&(B(),e.index.showToast({title:"支付检查失败，请重试",icon:"none",duration:3e3}),L())}}),1e4)},B=()=>{h.value&&(clearInterval(h.value),h.value=null),w.value=!1};return e.onMounted((async()=>{a.getToken()?await D():(e.index.showToast({title:"请先登录",icon:"none"}),setTimeout((()=>{e.index.navigateTo({url:"/pages/login/login"})}),1500))})),e.onUnmounted((()=>{B()})),(a,t)=>e.e({a:e.o(m),b:e.o(T),c:e.t(l.value),d:e.t(n.value),e:e.o(M),f:10===u.value},(u.value,{}),{g:10===u.value?1:"",h:e.o((e=>U(10))),i:50===u.value},(u.value,{}),{j:50===u.value?1:"",k:e.o((e=>U(50))),l:100===u.value},(u.value,{}),{m:100===u.value?1:"",n:e.o((e=>U(100))),o:e.o([e=>i.value=e.detail.value,$]),p:i.value,q:e.t(i.value||0),r:c.value},(c.value,{}),{s:c.value?1:"",t:e.o(F),v:e.o(q),w:e.t(p.value),x:y.value?"":1,y:e.o(_),z:!y.value,A:x.value,B:e.o(R),C:v.value},v.value?e.e({D:e.o(L),E:d.value},d.value?{F:d.value,G:s.value+"px",H:s.value+"px"}:{},{I:e.t(p.value),J:w.value},(w.value,{}),{K:w.value},(w.value,{}),{L:e.o((()=>{})),M:e.o(L)}):{})}},l=e._export_sfc(o,[["__scopeId","data-v-afa36c35"]]);wx.createPage(l);
