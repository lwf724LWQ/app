"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/request.js"),n=require("../../api/apis.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const i={__name:"edit-profile",setup(i){const t=e.reactive({avatar:"http://video.caimizm.com/himg/user.png",nickname:"",phone:""}),o=e.ref(!1),c=()=>{e.index.navigateBack()},r=()=>{t.avatar="http://video.caimizm.com/himg/user.png"},m=async()=>{if((t.nickname.trim()||(e.index.showToast({title:"请输入昵称",icon:"none"}),0))&&!o.value)try{o.value=!0,e.index.showLoading({title:"保存中..."});const a={account:t.phone,uname:t.nickname};if(t.avatar&&"http://video.caimizm.com/himg/user.png"!==t.avatar){const e=t.avatar.replace("http://video.caimizm.com/himg/","");a.himg=e}const i=await n.apiUpdateUserProfile(a);if(e.index.hideLoading(),200!==i.code)throw new Error(i.msg||"保存失败");e.index.showToast({title:"保存成功",icon:"success"}),e.index.setStorageSync("userInfo",{nickname:t.nickname,avatar:t.avatar});const c=e.index.getStorageSync("loginData")||{};c.uname=t.nickname,c.himg=t.avatar,e.index.setStorageSync("loginData",c),e.index.$emit("userProfileUpdated",{nickname:t.nickname,avatar:t.avatar}),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(a){e.index.hideLoading(),console.error("保存失败:",a),e.index.showToast({title:"保存失败，请重试",icon:"none"})}finally{o.value=!1}};return e.onMounted((()=>{(async()=>{const n=a.getToken(),i=a.getAccount();if(!n)return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateBack()}),1500);try{const a=e.index.getStorageSync("userInfo")||{},n=e.index.getStorageSync("loginData")||{};n.uname||n.account?(t.nickname=n.uname||"用户",t.phone=n.account||i||"",t.avatar=n.himg||"http://video.caimizm.com/himg/user.png"):(t.nickname=a.nickname||"用户",t.phone=i||"13637666646",t.avatar=a.avatar||"http://video.caimizm.com/himg/user.png"),console.log("加载的用户信息:",{nickname:t.nickname,phone:t.phone,avatar:t.avatar,loginData:n})}catch(o){console.error("加载用户信息失败:",o),t.nickname=i||"用户",t.phone=i||"13637666646",t.avatar="http://video.caimizm.com/himg/user.png"}})()})),(a,n)=>e.e({a:e.o(c),b:e.o(m),c:t.avatar,d:e.o(r),e:e.p({type:"camera",size:"24",color:"#fff"}),f:t.nickname,g:e.o((e=>t.nickname=e.detail.value)),h:t.phone,i:e.o((e=>t.phone=e.detail.value)),j:o.value},o.value?{k:e.p({type:"spinner-cycle",size:"16",color:"#fff"})}:{l:e.t(o.value?"保存中...":"保存修改")},{m:e.o(m),n:o.value})}},t=e._export_sfc(i,[["__scopeId","data-v-e7d0d8c5"]]);wx.createPage(t);
