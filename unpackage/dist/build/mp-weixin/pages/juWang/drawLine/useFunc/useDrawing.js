"use strict";const e=require("../../../../common/vendor.js");Math;const t={onLaunch:function(){console.log("App Launch")},onShow:function(){console.log("App Show")},onHide:function(){console.log("App Hide")}},a=e.index.getSystemInfoSync().platform,n="web"===a||"windows"===a||"mac"===a,l="android"===a||"ios"===a||"mp-weixin"===a;function r(){const a=e.createSSRApp(t);return a.use(e.createPinia()),{app:a,Pinia:e.Pinia}}console.log(e.index$1),r().app.mount("#app"),console.log(l,n,e.index.getSystemInfoSync().platform),exports.createApp=r,exports.isApp=l,exports.isH5=n,exports.useDrawing=function(t,a,n,l,r,u,o){const s=e.ref("freeDraw"),i=e.ref(!1),v=e.ref(!1),c=e.ref("auto"),d=e.ref("#3B82F6"),h=e.ref(3),x=e.ref(null),p=e.ref(null),f=e.ref({w:0,h:0}),y=e.ref(1),g=e.ref({start:{x:0,y:0},end:{x:0,y:0},points:[]}),m=e.ref([]),w=e.ref(30),b=()=>{g.value={start:{x:0,y:0},end:{x:0,y:0},points:[]}},C=e=>{var t;const a=null==(t=x.value)?void 0:t.canvas.getBoundingClientRect();if(!a)return!1;const n=document.querySelector(".numbers-table");if(!n)return!1;const l=n.querySelectorAll(".col-1");if(!l.length)return!1;const r=l[0].getBoundingClientRect().width,u=n.getBoundingClientRect();return e.x+a.left-u.left<=r},I=e=>{var t;if(C(e))return null;if(!n.value||0===n.value.length)return null;for(let l=0;l<n.value.length;l++){let r=n.value[l];if(r&&r.$el&&(r=r.$el),r&&r instanceof HTMLElement&&r.getBoundingClientRect)try{const a=r.getBoundingClientRect(),n=null==(t=x.value)?void 0:t.canvas.getBoundingClientRect();if(!n)continue;const l=e.x+n.left,u=e.y+n.top;if(l>=a.left&&l<=a.right&&u>=a.top&&u<=a.bottom){const e=parseInt(r.dataset.groupIndex);return{groupIndex:e,numIndex:parseInt(r.dataset.numIndex)}}}catch(a){console.error("检查点在数字上时出错:",a);continue}}return null},S=()=>{p.value&&p.value.clearRect(0,0,f.value.w,f.value.h)},M=(e,t,a,n,l=x.value)=>{l&&(C(e)||C(t)||(l.beginPath(),l.moveTo(e.x,e.y),l.lineTo(t.x,t.y),l.strokeStyle=a,l.lineWidth=n,l.lineCap="round",l.lineJoin="round",l.stroke()))},k=(e,t,a,n=x.value)=>{if(!n||e.length<2)return;const l=e.filter((e=>!C(e)));if(!(l.length<2)){n.beginPath(),n.moveTo(l[0].x,l[0].y);for(let e=1;e<l.length;e++)n.lineTo(l[e].x,l[e].y);n.strokeStyle=t,n.lineWidth=a,n.lineCap="round",n.lineJoin="round",n.stroke()}},P=(e,t,a,n,l=x.value)=>{if(!l)return;if(C(e)||C(t))return;const r=Math.min(e.x,t.x),u=Math.min(e.y,t.y),o=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y);l.strokeStyle=a,l.lineWidth=6,l.strokeRect(r,u,o,s)},T=(e,t,a,n,l=x.value)=>{if(!l)return;if(C(e)||C(t))return;const r=Math.abs(t.x-e.x)/2,u=Math.abs(t.y-e.y)/2;((e,t,a,n,l)=>{const r=.5522848,u=n*r,o=l*r;e.beginPath(),e.moveTo(t+n,a),e.bezierCurveTo(t+n,a-o,t+u,a-l,t,a-l),e.bezierCurveTo(t-u,a-l,t-n,a-o,t-n,a),e.bezierCurveTo(t-n,a+o,t-u,a+l,t,a+l),e.bezierCurveTo(t+u,a+l,t+n,a+o,t+n,a),e.closePath()})(l,e.x+(t.x-e.x)/2,e.y+(t.y-e.y)/2,r,u),l.strokeStyle=a,l.lineWidth=n,l.stroke()},L=(e,n,l,r,u=x.value,o)=>{let s="#1a1ad9";if(!u)return;if(C(e)||C(n))return;const i=I(e);if(i){a.value.some((e=>e.groupIndex===i.groupIndex&&e.numIndex===i.numIndex))||a.value.push({groupIndex:i.groupIndex,numIndex:i.numIndex})}const v=e.x,c=e.y;f.value.h,t.value,u.beginPath(),u.moveTo(e.x,e.y),u.quadraticCurveTo(v,c,n.x,n.y),u.strokeStyle=s,u.lineWidth=r,u.lineCap="round",u.stroke(),u.fillStyle=s,u.beginPath(),u.arc(e.x,e.y,5,0,2*Math.PI),u.arc(n.x,n.y,5,0,2*Math.PI),u.fill()},E=(e,t,a)=>{const n=e.x-t.x,l=e.y-t.y,r=a.x-t.x,u=a.y-t.y,o=r*r+u*u;let s,i,v=-1;return 0!==o&&(v=(n*r+l*u)/o),v<0?(s=t.x,i=t.y):v>1?(s=a.x,i=a.y):(s=t.x+v*r,i=t.y+v*u),Math.hypot(e.x-s,e.y-i)},D=(e,t)=>{if(C(e))return!1;if("freeDraw"===t.type){for(let a=0;a<t.points.length-1;a++)if(E(e,t.points[a],t.points[a+1])<w.value/2)return!0;return!1}if("rectangle"===t.type||"straightLine"===t.type){const a=Math.min(t.start.x,t.end.x),n=Math.min(t.start.y,t.end.y),l=Math.abs(t.end.x-t.start.x),r=Math.abs(t.end.y-t.start.y);return e.x>=a-w.value/2&&e.x<=a+l+w.value/2&&e.y>=n-w.value/2&&e.y<=n+r+w.value/2}if("circle"===t.type){const a=Math.sqrt(Math.pow(t.end.x-t.start.x,2)+Math.pow(t.end.y-t.start.y,2)),n=Math.hypot(e.x-t.start.x,e.y-t.start.y);return Math.abs(n-a)<w.value/2||n<w.value/2}if("smart"===t.type){const a=(t.start.x+t.end.x)/2,n=(t.start.y+t.end.y)/2+Math.abs(t.start.x-t.end.x)/3,l=Math.hypot(e.x-t.start.x,e.y-t.start.y),r=Math.hypot(e.x-t.end.x,e.y-t.end.y),u=Math.hypot(e.x-a,e.y-n);return Math.min(l,r,u)<w.value/1.5}return!1},R=e=>{if(C(e))return;const t=I(e);if(t){const{groupIndex:e,numIndex:n}=t,l=a.value.findIndex((t=>t.groupIndex===e&&t.numIndex===n));l>-1&&a.value.splice(l,1)}for(let a=m.value.length-1;a>=0;a--)D(e,m.value[a])&&m.value.splice(a,1)},q=e=>{var t;const a=null==(t=x.value)?void 0:t.canvas;if(!a)return{x:0,y:0};const n=a.getBoundingClientRect();if(!n)return{x:0,y:0};let l,r;if(e.touches&&e.touches.length>0)l=e.touches[0].clientX,r=e.touches[0].clientY;else{if(void 0===e.clientX)return{x:0,y:0};l=e.clientX,console.log(l),r=e.clientY}return{x:l-n.left,y:r-n.top}};let A=null;const B=()=>{if(p.value){if("freeDraw"===s.value&&i.value&&g.value.points.length>1){const e=g.value.points,t=e[e.length-2],a=e[e.length-1];p.value.beginPath(),p.value.moveTo(t.x,t.y),p.value.lineTo(a.x,a.y),p.value.strokeStyle=d.value,p.value.lineWidth=h.value,p.value.lineCap="round",p.value.stroke()}else console.log(p),p.value&&(p.value.clearRect(0,0,f.value.w,f.value.h),m.value.forEach((e=>{switch(e.type){case"straightLine":M(e.start,e.end,e.color,e.width,p.value);break;case"freeDraw":k(e.points,e.color,e.width,p.value);break;case"rectangle":P(e.start,e.end,e.color,e.width,p.value);break;case"circle":T(e.start,e.end,e.color,e.width,p.value);break;case"smart":e.startNum&&e.endNum?L(e.start,e.end,e.color,e.width,p.value):k([e.start,e.end],e.color,e.width,p.value)}})));if(p.value)switch(s.value){case"straightLine":M(g.value.start,g.value.end,d.value,h.value,p.value);break;case"freeDraw":g.value.points.length>1&&k(g.value.points,d.value,h.value,p.value);break;case"rectangle":P(g.value.start,g.value.end,d.value,h.value,p.value);break;case"circle":T(g.value.start,g.value.end,d.value,h.value,p.value);break;case"smart":const e=I(g.value.start),t=I(g.value.end);e&&t?L(g.value.start,g.value.end,0,h.value,p.value):k([g.value.start,g.value.end],"#ff6688",h.value,p.value)}}},W=(e=!1)=>{x.value&&(x.value.clearRect(0,0,f.value.w,f.value.h),m.value.forEach((e=>{switch(e.type){case"straightLine":M(e.start,e.end,e.color,e.width);break;case"freeDraw":k(e.points,e.color,e.width);break;case"rectangle":P(e.start,e.end,e.color,e.width);break;case"circle":T(e.start,e.end,e.color,e.width);break;case"smart":e.startNum&&e.endNum?L(e.start,e.end,e.color,e.width):k([e.start,e.end],e.color,e.width)}})),"eraser"===s.value&&v.value&&$())},$=()=>{if(!x.value)return;const e=g.value.end;x.value.beginPath(),x.value.arc(e.x,e.y,w.value/2,0,2*Math.PI),x.value.strokeStyle="rgba(255, 0, 0, 0.5)",x.value.lineWidth=2,x.value.stroke(),x.value.fillStyle="rgba(255, 0, 0, 0.1)",x.value.fill()},z=(e,t,a)=>{e&&e.removeEventListener&&e.removeEventListener(t,a)},N=(e,t,a,n)=>{e&&e.addEventListener&&e.addEventListener(t,a,n)},H=()=>{var e;[document.querySelector(".numbers-table-container"),document.querySelector(".container"),null==(e=document.querySelector(".numbers-table"))?void 0:e.parentElement,document.scrollingElement,window].filter((e=>null!=e)).forEach((e=>{z(e,"scroll",F),N(e,"scroll",F)})),z(document,"touchmove",O),N(document,"touchmove",O,{passive:!0})},F=()=>{c.value="auto"},O=()=>{c.value="auto"};return e.nextTick$1().then((()=>{H()})),{currentMode:s,isDrawing:i,isErasing:v,canvasPointerEvents:c,strokeColor:d,lineWidth:h,canvasCtx:x,tempCanvasCtx:p,canvasSize:f,dpr:y,currentShape:g,shapes:m,eraserSize:w,onCanvasStart:e=>{console.log("Canvas 开始操作");const t=q(e);if(C(t))return void e.stopPropagation();c.value="none";let a=null;a&&(clearTimeout(a),a=null),a=setTimeout((()=>{c.value="auto",a=null}),300),"eraser"===s.value?(v.value=!0,R(t),W(!1)):["straightLine","freeDraw","rectangle","circle","smart"].includes(s.value)&&(i.value=!0,g.value.start={...t},g.value.end={...t},"freeDraw"===s.value&&(g.value.points=[t],console.log(g.value.points)))},onCanvasMove:e=>{A&&cancelAnimationFrame(A),A=requestAnimationFrame((()=>{const t=q(e);i.value&&(g.value.end={...t},"freeDraw"===s.value&&g.value.points.push(t),B()),A=null}));const t=q(e);C(t)||(e.preventDefault(),"eraser"===s.value&&v.value?(R(t),W(!1)):i.value&&(g.value.end={...t},"freeDraw"===s.value&&g.value.points.push(t),B()))},onCanvasEnd:()=>{const e=g.value.end,t=I(e);if(A&&(cancelAnimationFrame(A),A=null),t){const{groupIndex:e,numIndex:a}=t;console.log(e,a),"smart"===s.value&&e>=20&&e<=23&&0==a&&l&&l(e,a),"smart"===s.value&&e>=20&&e<=23&&1==a&&l&&l(e,a),"smart"===s.value&&e>=20&&e<=23&&2==a&&l&&l(e,a),"smart"===s.value&&e>=20&&e<=23&&3==a&&l&&l(e,a),"smart"===s.value&&e>=20&&e<=23&&4==a&&l&&l(e,a),"smart"===s.value&&e>=20&&e<=23&&5==a&&l&&l(e,a)}if("eraser"===s.value)v.value=!1;else if(i.value){if(C(g.value.start)||C(g.value.end))return i.value=!1,b(),void S();const e={type:s.value,start:{...g.value.start},end:{...g.value.end},points:[...g.value.points],color:d.value,width:h.value};if("freeDraw"===s.value&&e.points.length>1)e.points=e.points.filter((e=>!C(e))),e.points.length>1&&m.value.push(e);else if(["rectangle","straightLine","circle"].includes(s.value)){Math.hypot(e.end.x-e.start.x,e.end.y-e.start.y)>5&&m.value.push(e)}else if("smart"===s.value){const t=I(e.start),n=I(e.end);if(Math.hypot(e.end.x-e.start.x,e.end.y-e.start.y)>10&&(e.startNum=t,e.endNum=n,m.value.push(e),t&&n)){const e=(e,t)=>{a.value.some((a=>a.groupIndex===e&&a.numIndex===t))||a.value.push({groupIndex:e,numIndex:t})};e(t.groupIndex,t.numIndex),e(n.groupIndex,n.numIndex)}}i.value=!1,b(),S(),W(!1)}},redraw:W,initCanvas:async()=>{try{await e.nextTick$1(),"complete"!==document.readyState&&await new Promise((e=>{"complete"===document.readyState?e():document.addEventListener("DOMContentLoaded",e)}));let t=null,a=null;if(t=u&&u.value?u.value:document.querySelector(".draw-canvas"),a=o&&o.value?o.value:document.querySelector(".temp-canvas"),!t)return void console.error("主 Canvas 元素未找到");const n=document.querySelector(".numbers-table");let l=0;if(console.log(n.getBoundingClientRect().height),n&&(l=n.getBoundingClientRect().height),r){if(t instanceof HTMLCanvasElement)console.log("元素是 Canvas");else{console.warn("元素不是 Canvas，尝试查找内部的 Canvas");const e=t.querySelector("canvas");if(!e)return void console.error("元素内部也没有 Canvas");console.log("在元素内部找到 Canvas:",e),t=e}x.value=t.getContext("2d"),y.value=window.devicePixelRatio||1,f.value={w:window.innerWidth,h:l||.7*window.innerHeight},t.style.width=`${f.value.w}px`,t.style.height=`${f.value.h}px`,t.width=f.value.w*y.value,t.height=f.value.h*y.value,x.value&&x.value.scale(y.value,y.value),a&&a instanceof HTMLCanvasElement&&(p.value=a.getContext("2d"),a.style.width=`${f.value.w}px`,a.style.height=`${f.value.h}px`,a.width=f.value.w*y.value,a.height=f.value.h*y.value,p.value&&p.value.scale(y.value,y.value))}else{const t=e.index.createSelectorQuery(),a=await new Promise((e=>{t.select(".draw-canvas").fields({node:!0,size:!0}).exec((t=>e(t[0])))}));if(!a||!a.node)return void console.error("Canvas初始化失败");const n=a.node;x.value=n.getContext("2d");const r=e.index.getSystemInfoSync();y.value=r.pixelRatio||1,f.value={w:r.windowWidth,h:l},x.value.scale(y.value,y.value);const u=await new Promise((e=>{t.select(".temp-canvas").fields({node:!0,size:!0}).exec((t=>e(t[0])))}));if(u&&u.node){const e=u.node;p.value=e.getContext("2d"),e.style.width=f.value.w+"px",e.style.height=f.value.h+"px",e.width=f.value.w*y.value,e.height=f.value.h*y.value,p.value.scale(y.value,y.value)}}console.log("Canvas 初始化成功")}catch(t){console.error("Canvas 初始化过程中发生错误:",t)}},checkPointOnNumber:I,isPointInNonDrawableArea:C,checkPointOnTextLabel:e=>(C(e),-1),performErase:R,setupTableScrollListener:H}};
