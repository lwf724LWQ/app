"use strict";const e=require("../../common/vendor.js"),o=require("../../api/apis.js"),a=require("../../utils/request.js");Math||n();const n=()=>"../../components/VerificationCode.js",t=e.defineComponent({__name:"code-login",setup(n){const t=e.ref(!1),i=()=>{e.index.navigateBack()},s=()=>{e.index.navigateTo({url:"/pages/reg/reg"})},c=()=>{e.index.navigateTo({url:"/pages/login/login"})};e.onLoad((e=>{"forgetPwd"===e.type?t.value=!0:t.value=!1}));const l=e.ref(""),u=e.ref(""),d=e.ref(null),r=e=>{u.value=e},g=async()=>{if(l.value)try{const a=await o.apiSendCode({phone:l.value});200===a.code?(d.value.startCountdown(),e.index.showToast({title:"验证码已发送",icon:"success"})):e.index.showToast({title:a.errMsg||"发送失败",icon:"none"})}catch(a){e.index.showToast({title:"发送验证码失败",icon:"none"})}else e.index.showToast({title:"请输入手机号",icon:"none"})},h=async()=>{var n;if(l.value)if(u.value){e.index.showLoading({title:"登录中..."});try{const i={type:"1",account:l.value,code:u.value},s=await o.apilogin(i);if(e.index.hideLoading(),s){console.log("验证码登录API返回的完整数据:",s),(null==(n=s.data)?void 0:n.token)&&a.setToken(s.data.token),l.value&&a.setAccount(l.value);try{const o=s.data||{};let a="http://video.caimizm.com/himg/user.png";o.himg&&(a=o.himg.startsWith("http")?o.himg:`http://video.caimizm.com/himg/${o.himg}`);const n={nickname:o.uname||"用户",avatar:a,phone:l.value};e.index.setStorageSync("userInfo",n),e.index.setStorageSync("loginData",{uname:o.uname,himg:o.himg,account:l.value}),console.log("验证码登录成功，用户信息已保存:",n),console.log("登录数据已保存:",{uname:o.uname,himg:o.himg,account:l.value})}catch(t){console.error("保存用户信息失败:",t);const o={nickname:"用户",avatar:"http://video.caimizm.com/himg/user.png",phone:l.value};e.index.setStorageSync("userInfo",o),e.index.setStorageSync("loginData",{uname:"用户",himg:"http://video.caimizm.com/himg/user.png",account:l.value})}e.index.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/user/user"})}),1500)}else e.index.showModal({title:"登录失败",content:"验证码错误或已过期，请重试",showCancel:!1})}catch(t){e.index.hideLoading(),e.index.showModal({title:"登录失败",content:"网络错误，请检查网络连接后重试",showCancel:!1})}}else e.index.showToast({title:"请输入验证码",icon:"none"});else e.index.showToast({title:"请输入手机号",icon:"none"})};return(o,a)=>e.e({a:e.o(i),b:!t.value},(t.value,{}),{c:t.value},(t.value,{}),{d:l.value,e:e.o((e=>l.value=e.detail.value)),f:e.sr(d,"dbadf852-0",{k:"codeRef"}),g:e.o(g),h:e.o(r),i:e.p({placeholder:"请输入验证码"}),j:!t.value},t.value?{}:{k:e.o(c),l:e.o(s)},{m:e.t(t.value?"重置密码":"登录"),n:e.o(h)})}}),i=e._export_sfc(t,[["__scopeId","data-v-dbadf852"]]);wx.createPage(i);
