"use strict";const e=require("../../common/vendor.js"),t=require("../../api/apis.js"),a=require("../../utils/request.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"forum",setup(o){const n=e.ref("predict"),i=e.ref(0),s=e.ref(!1),l=e.ref(null),c=e.ref(!1),u=e.ref(""),r=e.ref(!1),d=e.ref(""),v=e.ref(""),m=e.ref(""),p=e.ref(!1),f=e.ref([]),h=e.ref([]),g=e.ref(!1),y=e.ref(!1),w=e.ref(!1),x=e.ref(["头尾","芝麻","定头","定百","定十","定尾","杀头","杀百","杀十","杀尾","稳码","中肚","头尾合","中肚合","千百合","千十合","百个合","十个合","ABXD","ABCX","AXCD","XBCD","ABXX","AXCX","XXCD","XBXD","死数","二字现","三字现","过滤王二定","过滤王三定","过滤王四定","头尾不合","中肚不合","千百不合","千十不合","百个不合","十个不合"]),k=e.ref(["大师帖子","靓规贴子","点赞最多","讨论最热"]),b=e.ref(["#全部","#大师","#靓规贴","#过滤王","#点赞最多"]),A=e.ref([{id:16,name:"排列三",code:"pl3",status:"待开奖",time:"今天 21:30"},{id:17,name:"排列五",code:"pl5",status:"待开奖",time:"今天 21:30"},{id:15,name:"七星彩",code:"qxc",status:"待开奖",time:"今天 21:30"},{id:12,name:"福彩3D",code:"fc3d",status:"待开奖",time:"今天 21:30"}]),L=e.ref(A.value[0]),T=e.ref([{id:1,title:"2024年彩票行业最新政策解读",content:"国家彩票管理中心发布最新政策，对彩票销售和兑奖流程进行了优化调整...",time:"2小时前",views:1256,likes:89},{id:2,title:"数字彩票中奖概率分析报告",content:"专业机构发布最新中奖概率分析，帮助彩民理性购彩...",time:"5小时前",views:892,likes:67},{id:3,title:"彩票公益金使用情况公示",content:"本年度彩票公益金主要用于教育、医疗、体育等公益事业...",time:"1天前",views:2156,likes:156}]),C=e.ref([{id:1,username:"彩友小王",avatar:"/static/images/defaultAvatar.png",time:"刚刚",content:"今天分享一个实用的选号技巧，希望对大家有帮助！"},{id:2,username:"幸运星",avatar:"/static/images/defaultAvatar.png",time:"30分钟前",content:"最近在研究号码走势，发现了一些有趣的规律"},{id:3,username:"数字达人",avatar:"/static/images/defaultAvatar.png",time:"1小时前",content:"新一期预测已发布，欢迎大家参考讨论"}]),S=e.ref([]),z=e.ref({id:null,number:null,status:"待开奖",time:"今天 21:30"}),X=e.ref([{id:1,username:"心灵导师",avatar:"/static/images/defaultAvatar.png",time:"1小时前",content:"生活就像彩票，不买永远没有中奖的机会，但买了也不一定中奖。重要的是保持一颗平常心，享受过程，期待美好。",likes:45,comments:12},{id:2,username:"正能量小王",avatar:"/static/images/defaultAvatar.png",time:"3小时前",content:"每一次失败都是成功的垫脚石，每一次尝试都是成长的机会。相信自己，坚持下去，好运总会降临。",likes:67,comments:23},{id:3,username:"励志达人",avatar:"/static/images/defaultAvatar.png",time:"6小时前",content:"人生就像选号，没有标准答案，但有无数种可能。勇敢尝试，坚持梦想，你就是自己的幸运星。",likes:89,comments:34}]),D=e.ref(!1);e.onMounted((()=>{if(D.value)console.log("页面已经初始化，跳过重复加载");else{try{const t=e.index.getStorageSync("currentLotteryType");t&&(L.value=t)}catch(t){}ie(),se(),I(L.value.code),D.value=!0}}));const B=e=>{n.value=e},$=()=>{s.value=!s.value},j=()=>{s.value=!1},I=async a=>{if(w.value)console.log("正在加载彩票数据，跳过重复请求");else try{w.value=!0;const n=A.value.find((e=>e.code===a));if(!n)return;e.index.showLoading({title:"加载中..."});const i=await t.apiGetIssueNo({cpid:n.id});if(e.index.hideLoading(),200===i.code&&null!==i.data&&void 0!==i.data){let t=null,s="待开奖",l="今天 21:30";"number"==typeof i.data||"string"==typeof i.data?t=i.data.toString():"object"==typeof i.data&&(t=i.data.issueno||i.data.number||i.data.id,s=i.data.status||"待开奖",l=i.data.time||"今天 21:30"),n.status=s,n.time=l,L.value.code===a&&(L.value.status=n.status,L.value.time=n.time),z.value={id:t,number:t,status:s,time:l};try{e.index.setStorageSync("currentIssueInfo",z.value)}catch(o){}Y()}else e.index.showToast({title:i.msg||"数据加载失败",icon:"none"})}catch(o){e.index.hideLoading(),e.index.showToast({title:"网络错误，请重试",icon:"none"})}finally{w.value=!1}},P=e=>e&&e.includes(","),_=e=>e?e.split(",").map((e=>e.trim())).filter((e=>e)):[],q=(t,a)=>{e.index.previewImage({current:t,urls:a})},E=()=>{l.value.open()},M=()=>{l.value.close()},G=()=>{c.value=!c.value},Q=t=>{if(c.value){switch(u.value=t,t){case"predict":e.index.navigateTo({url:"/pages/predict-scheme/predict-scheme",success:()=>{M()},fail:t=>{e.index.showToast({title:"跳转失败",icon:"none"})}});break;case"pattern":e.index.navigateTo({url:"/pages/pattern-predict/pattern-predict",success:()=>{M()},fail:t=>{e.index.showToast({title:"跳转失败",icon:"none"})}});break;case"filter":e.index.showToast({title:"跳转到过滤王帖发布",icon:"none"});break;case"soup":e.index.showToast({title:"跳转到老母鸡汤发布",icon:"none"})}M()}else e.index.showToast({title:"请先同意管理规范",icon:"none"})},W=()=>{r.value=!0},F=()=>{r.value=!1},N=()=>{m.value.trim()?(H(),K()):O()},H=()=>{const e=m.value.trim().toLowerCase(),t=[];x.value.forEach((a=>{a.toLowerCase().includes(e)&&t.push(a)})),k.value.forEach((a=>{a.toLowerCase().includes(e)&&t.push(a)})),f.value=t.slice(0,5)},J=()=>{m.value="",p.value=!1,i.value=-1,O()},K=()=>{const t=m.value.trim().toLowerCase();t?(g.value=!0,h.value=S.value.filter((e=>!(!e.username||!e.username.toLowerCase().includes(t))||(!(!e.content||!e.content.toLowerCase().includes(t))||(!(!e.period||!e.period.toString().includes(t))||("全部"===t||("大师"===t||"大师帖子"===t?e.content&&e.content.toLowerCase().includes("大师"):"靓规贴"===t||"靓规贴子"===t?e.content&&e.content.toLowerCase().includes("靓规"):"过滤王"===t?e.content&&e.content.toLowerCase().includes("过滤王"):"点赞最多"===t&&e.likes>0)))))),"点赞最多"===t&&h.value.sort(((e,t)=>t.likes-e.likes)),e.index.showToast({title:`找到${h.value.length}条结果`,icon:"success"})):O()},O=()=>{h.value=[],g.value=!1},R=()=>{const t=[];d.value&&t.push(d.value),v.value&&t.push(v.value),0!==t.length?(m.value=t.join("+"),U(),F(),i.value=-1,e.index.showToast({title:`搜索${t.join("+")}`,icon:"success"})):e.index.showToast({title:"请选择筛选条件",icon:"none"})},U=e=>{g.value=!0,h.value=S.value.filter((e=>{let t=!1;if(d.value){const a=d.value.toLowerCase();e.content&&e.content.toLowerCase().includes(a)&&(t=!0),"头尾"===a&&e.content&&(e.content.includes("头")||e.content.includes("尾"))&&(t=!0),"芝麻"===a&&e.content&&e.content.includes("芝麻")&&(t=!0),"中肚"===a&&e.content&&e.content.includes("中肚")&&(t=!0),a.includes("定")&&e.content&&e.content.includes("定")&&(t=!0),a.includes("杀")&&e.content&&e.content.includes("杀")&&(t=!0),a.includes("合")&&e.content&&e.content.includes("合")&&(t=!0),a.includes("过滤王")&&e.content&&e.content.includes("过滤王")&&(t=!0)}if(v.value){const a=v.value.toLowerCase();"大师帖子"===a&&e.content&&e.content.includes("大师")&&(t=!0),"靓规贴子"===a&&e.content&&e.content.includes("靓规")&&(t=!0),"点赞最多"===a&&e.likes>0&&(t=!0),"讨论最热"===a&&e.comments>0&&(t=!0)}return t})),"点赞最多"===v.value?h.value.sort(((e,t)=>t.likes-e.likes)):"讨论最热"===v.value&&h.value.sort(((e,t)=>t.comments-e.comments))},V=()=>{const e=[];return d.value&&e.push(d.value),v.value&&e.push(v.value),0===e.length?"搜索":e.join("+")},Y=async()=>{if(y.value)console.log("正在加载帖子，跳过重复请求");else try{y.value=!0;const e={tname:L.value.name,issueno:z.value.number||z.value.id||"--",page:"1",limit:"20"},o=await t.apiPostListQuery(e);let n=[];200===o.code&&o.data&&o.data.records&&Array.isArray(o.data.records)&&(n=[...o.data.records]);const i={tname:`${L.value.name}-规律预测`,issueno:z.value.number||z.value.id||"--",page:"1",limit:"20"},s=await t.apiPostListQuery(i);200===s.code&&s.data&&s.data.records&&Array.isArray(s.data.records)&&(n=[...n,...s.data.records]),n.length>0?S.value=n.map((e=>{const t=e.id;if(!t)return null;const o=a.getAccount(),n=Z(`${t}_${o}`),i=e.likeCount||0;let s="http://video.caimizm.com/himg/user.png";return s=ee(e.account),{id:t,username:e.account||"匿名用户",avatar:s,time:te(e.createTime),status:"预测中",period:e.issueno||z.value.number,content:e.content||"",image:e.pimg||"",likes:i,comments:e.comment||0,shares:0,isLiked:n,isLiking:!1}})).filter((e=>null!==e)):S.value=[]}catch(e){console.error("加载帖子失败:",e),S.value=[]}finally{y.value=!1}},Z=t=>{try{return(e.index.getStorageSync("likedPosts")||{})[t]||!1}catch(a){return!1}},ee=t=>{try{if(t===a.getAccount()){const t=e.index.getStorageSync("loginData")||{};if(t.himg)return t.himg}const o=e.index.getStorageSync("userAvatars")||{};return o[t]?o[t]:"http://video.caimizm.com/himg/user.png"}catch(o){return"http://video.caimizm.com/himg/user.png"}},te=e=>{if(!e)return"刚刚";try{const t=new Date(e),a=new Date-t;return a<6e4?"刚刚":a<36e5?`${Math.floor(a/6e4)}分钟前`:a<864e5?`${Math.floor(a/36e5)}小时前`:`${Math.floor(a/864e5)}天前`}catch(t){return"刚刚"}},ae=()=>{d.value="",v.value="",e.index.showToast({title:"已清空筛选条件",icon:"success"})},oe=async o=>{try{if(o.isLiking)return;const n=a.getAccount(),i=`${o.id}_${n}`;if(Z(i))return void e.index.showToast({title:"你已经点赞过了",icon:"none"});if(!o.id)return void e.index.showToast({title:"帖子数据异常，无法点赞",icon:"none"});o.isLiking=!0;const s={postId:o.id,account:n},l=await t.apiPostLike(s);200===l.code?(o.isLiked=!0,o.likes+=1,((t,a)=>{try{const o=e.index.getStorageSync("likedPosts")||{};o[t]=a,e.index.setStorageSync("likedPosts",o)}catch(o){}})(i,!0),e.index.showToast({title:l.msg||"点赞成功",icon:"success"}),ne(o)):e.index.showToast({title:l.msg||"点赞失败",icon:"none"})}catch(n){e.index.showToast({title:"网络错误，请重试",icon:"none"})}finally{o.isLiking=!1}},ne=e=>{const t=S.value.findIndex((t=>t.id===e.id));-1!==t&&(S.value[t]={...e});const a=h.value.findIndex((t=>t.id===e.id));-1!==a&&(h.value[a]={...e})},ie=()=>{try{const t=e.index.getStorageSync("loginData")||{},o=a.getAccount();if(t.himg&&o){const a=e.index.getStorageSync("userAvatars")||{};a[o]||(a[o]=t.himg,e.index.setStorageSync("userAvatars",a))}}catch(t){}},se=()=>{try{if("undefined"!=typeof window&&window.addEventListener){const e=(e,t,a)=>{e.addEventListener(t,a,{passive:!0})};document.querySelectorAll(".predict-list, .modal-content, .dropdown-list, .filter-dialog").forEach((t=>{e(t,"touchstart",(()=>{})),e(t,"touchmove",(()=>{})),e(t,"touchend",(()=>{}))}))}}catch(e){}},le=t=>{try{const a=ce(t.content),o={postId:t.id,schemeIds:a,postContent:t.content,period:t.period,lotteryType:L.value.name,timestamp:Date.now()};e.index.setStorageSync("appendPostData",o),e.index.navigateTo({url:"/pages/predict-scheme/predict-scheme",success:()=>{e.index.showToast({title:"请选择要追加的方案",icon:"success"})},fail:t=>{e.index.showToast({title:"跳转失败",icon:"none"})}})}catch(a){e.index.showToast({title:"跳转失败",icon:"none"})}},ce=e=>{try{if(!e)return[];const t=[];return["头尾","中肚","ABXX","AXCX","XBXD","XXCD","ABCX","ABXD","AXCD","XBCD","芝麻","二字现","三字现","定头","定百","定十","定尾","杀头","杀百","杀十","杀尾","稳码","头尾合","中肚合","千百合","千十合","百个合","十个合","死数","头尾不合","中肚不合","千百不合","千十不合","百个不合","十个不合","过滤王二定","过滤王三定","过滤王四定"].forEach((a=>{e.includes(a)&&t.push(a)})),t}catch(t){return[]}};return(t,o)=>e.e({a:e.p({type:"list",size:"20",color:"#fff"}),b:e.t(L.value.name),c:e.t(L.value.status),d:s.value?1:"",e:e.p({type:"arrowdown",size:"16",color:"#fff"}),f:e.o($),g:s.value},s.value?{h:e.o(j)}:{},{i:s.value},s.value?{j:e.p({type:"close",size:"16",color:"#999"}),k:e.o(j),l:e.f(A.value,((t,a,o)=>({a:e.t(t.name),b:e.t(t.status),c:e.t(t.time),d:t.id===L.value.id?1:"",e:t.id,f:e.o((a=>(t=>{if(L.value.code===t.code)return console.log("彩票类型未变化，跳过加载"),void(s.value=!1);L.value=t,s.value=!1;try{e.index.setStorageSync("currentLotteryType",t)}catch(a){}I(t.code)})(t)),t.id)}))),m:e.o((()=>{}))}:{},{n:e.p({type:"plus",size:"20",color:"#fff"}),o:e.o(E),p:"headlines"===n.value?1:"",q:e.o((e=>B("headlines"))),r:"follow"===n.value?1:"",s:e.o((e=>B("follow"))),t:"predict"===n.value?1:"",v:e.o((e=>B("predict"))),w:"soup"===n.value?1:"",x:e.o((e=>B("soup"))),y:e.p({type:"search",size:"16",color:"#999"}),z:e.o([e=>m.value=e.detail.value,N]),A:e.o((e=>p.value=!0)),B:m.value,C:m.value},m.value?{D:e.p({type:"clear",size:"16",color:"#999"}),E:e.o(J)}:{},{F:e.p({type:"tune",size:"16",color:"#999"}),G:e.o(W),H:p.value&&f.value.length>0},p.value&&f.value.length>0?{I:e.f(f.value,((t,a,o)=>({a:"debdd858-7-"+o,b:e.t(t),c:a,d:e.o((e=>(e=>{m.value=e,p.value=!1,K()})(t)),a)}))),J:e.p({type:"search",size:"14",color:"#999"})}:{},{K:e.f(b.value,((t,a,o)=>({a:e.t(t),b:i.value===a?1:"",c:a,d:e.o((e=>(e=>{i.value=e;const t=b.value[e].replace("#","");m.value=t,K(),p.value=!1})(a)),a)}))),L:"headlines"===n.value},"headlines"===n.value?{M:e.f(T.value,((t,a,o)=>({a:e.t(t.title),b:e.t(t.time),c:e.t(t.content),d:e.t(t.views),e:e.t(t.likes),f:a})))}:{},{N:"follow"===n.value},"follow"===n.value?{O:e.f(C.value,((t,a,o)=>({a:t.avatar,b:e.t(t.username),c:e.t(t.time),d:e.t(t.content),e:a})))}:{},{P:"predict"===n.value},"predict"===n.value?e.e({Q:g.value&&m.value},g.value&&m.value?{R:e.t(m.value),S:e.t(h.value.length)}:{},{T:e.f(g.value&&m.value?h.value:S.value,((t,o,n)=>e.e({a:t.avatar,b:e.t(t.username),c:"debdd858-8-"+n,d:e.t(t.period),e:e.t(t.time),f:e.t(t.content),g:t.image},t.image?e.e({h:!P(t.image)},P(t.image)?{k:e.f(_(t.image),((a,o,n)=>({a:a.startsWith("http")?a:`http://video.caimizm.com/himg/${a}`,b:e.o((e=>q(a,_(t.image))),o),c:o})))}:{i:t.image.startsWith("http")?t.image:`http://video.caimizm.com/himg/${t.image}`,j:e.o((e=>q(t.image,[t.image])),o)}):{},{l:"debdd858-9-"+n,m:e.p({type:"hand-up",size:"18",color:t.isLiked?"#ff4757":"#999"}),n:e.t(t.likes),o:t.isLiked?1:"",p:t.isLiked?1:"",q:e.o((e=>oe(t)),o),r:"debdd858-10-"+n,s:e.t(t.shares),t:"debdd858-11-"+n,v:e.t(t.comments),w:"debdd858-12-"+n,x:e.o((o=>(t=>{try{if(!t.id)return void e.index.showToast({title:"帖子数据异常，无法追帖",icon:"none"});const o=a.getAccount();t.username===o?e.index.showModal({title:"追帖确认",content:`确定要对帖子"第${t.period}期"进行追帖吗？`,confirmText:"确定追帖",cancelText:"取消",success:e=>{e.confirm&&le(t)}}):e.index.showToast({title:"只能追帖自己的帖子",icon:"none"})}catch(o){e.index.showToast({title:"操作失败，请重试",icon:"none"})}})(t)),o),y:o}))),U:e.p({type:"more-filled",size:"20",color:"#999"}),V:e.p({type:"redo",size:"18",color:"#999"}),W:e.p({type:"chatbubble",size:"18",color:"#999"}),X:e.p({type:"plus",size:"18",color:"#28B389"}),Y:0===S.value.length},(S.value.length,{})):{},{Z:"soup"===n.value},"soup"===n.value?{aa:e.f(X.value,((t,a,o)=>({a:t.avatar,b:e.t(t.username),c:e.t(t.time),d:e.t(t.content),e:"debdd858-13-"+o,f:e.t(t.likes),g:"debdd858-14-"+o,h:e.t(t.comments),i:a}))),ab:e.p({type:"heart",size:"14",color:"#999"}),ac:e.p({type:"chat",size:"14",color:"#999"})}:{},{ad:e.p({type:"plus",size:"20",color:"#fff"}),ae:e.o(E),af:e.p({type:"close",size:"20",color:"#999"}),ag:e.o(M),ah:c.value},(c.value,{}),{ai:c.value?1:"",aj:e.o(G),ak:e.o((e=>Q("predict"))),al:e.p({type:"redo",size:"24",color:"#fff"}),am:e.o((e=>Q("pattern"))),an:e.p({type:"gear",size:"24",color:"#fff"}),ao:e.o((e=>Q("filter"))),ap:e.p({type:"coffee",size:"24",color:"#fff"}),aq:e.o((e=>Q("soup"))),ar:e.o(M),as:e.sr(l,"debdd858-16",{k:"publishPopup"}),at:e.p({type:"bottom","safe-area":!1,"mask-click":!1,animation:!0,"mask-background-color":"rgba(0,0,0,0.5)",duration:300}),av:p.value},p.value?{aw:e.o((e=>p.value=!1))}:{},{ax:r.value},r.value?{ay:e.t(L.value.name),az:e.t(L.value.status),aA:e.f(x.value,((t,a,o)=>({a:e.t(t),b:d.value===t?1:"",c:t,d:e.o((e=>(e=>{d.value===e?d.value="":d.value=e})(t)),t)}))),aB:e.f(k.value,((t,a,o)=>({a:e.t(t),b:v.value===t?1:"",c:t,d:e.o((e=>(e=>{v.value===e?v.value="":v.value=e})(t)),t)}))),aC:e.o(ae),aD:e.t(V()),aE:e.o(R),aF:e.o((()=>{})),aG:e.o(F)}:{})}},n=e._export_sfc(o,[["__scopeId","data-v-debdd858"]]);wx.createPage(n);
