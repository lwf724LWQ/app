"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/request.js"),t=require("../../api/apis.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const l={__name:"dream-interpretation",setup(l){const n=e.ref([]),o=e.ref(!1),r=e.ref(!1),i=e.ref(""),u=e.ref([]),v=e.ref(!1),s=e.ref(1),c=e.ref(10),g=e.ref(0),d=e.ref(0),m=e.ref(!1),h=e.ref(!0),f=e.ref(["苍蝇幼虫","走私被捕","剪刀割手","跳楼","伯父死了","失踪少女"]),w=e.ref([]),p=(e,a)=>{if(!e||!a)return"";const t="http://video.caimizm.com";if(a.startsWith("http"))return a;if(a.startsWith("/"))return`${t}${a}`;const l=[`${t}/web/image/${e}/${a}`,`${t}/web/dream/image/${e}`,`${t}/api/image/${e}`,`${t}/images/${e}/${a}`,`${t}/static/images/${a}`],n=l[0];return console.log("构建图片URL:",{id:e,imgName:a,url:n,allPaths:l}),n},y=()=>!!a.getToken(),$=()=>new Promise((a=>{e.index.getNetworkType({success:e=>a("none"!==e.networkType),fail:()=>a(!0)})})),b=async(a,l="1",i="10",u=!1)=>{try{if(u?m.value=!0:o.value=!0,!y())return void e.index.showToast({title:"请先登录",icon:"none"});if(!(await $()))return void e.index.showToast({title:"网络连接不可用",icon:"none"});const v=await t.apiDreamQuery({content:a,page:l,limit:i}),f=v.data.records||[];u?n.value=[...n.value,...f]:(n.value=f,s.value=1),d.value=v.data.total||0,g.value=Math.ceil(d.value/c.value),s.value=parseInt(l),h.value=s.value<g.value,r.value=!0,console.log("API返回的数据:",v.data),console.log("梦境解析结果:",n.value),console.log("分页信息:",{currentPage:s.value,totalPages:g.value,totalRecords:d.value}),u||e.index.showToast({title:"查询成功",icon:"success"})}catch(v){e.index.showToast({title:v.errMsg||v.msg||"查询失败，请重试",icon:"none"})}finally{u?m.value=!1:o.value=!1}},x=async()=>{i.value.trim()?y()?(v.value=!1,await b(i.value,"1",c.value.toString(),!1),S(i.value)):e.index.showToast({title:"请先登录",icon:"none"}):e.index.showToast({title:"请输入梦境关键词",icon:"none"})},T=async()=>{if(!h.value||m.value)return;const e=s.value+1;await b(i.value,e.toString(),c.value.toString(),!0)},k=()=>{v.value=!0},S=a=>{const t=new Date,l=`${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${t.getMinutes().toString().padStart(2,"0")}`,n={keyword:a,time:l},o=u.value.findIndex((e=>e.keyword===a));o>-1&&u.value.splice(o,1),u.value.unshift(n),u.value.length>10&&(u.value=u.value.slice(0,10)),e.index.setStorageSync("dream_history",u.value)},P=()=>{e.index.showModal({title:"提示",content:"确定要清除所有历史记录吗？",success:a=>{a.confirm&&(u.value=[],e.index.removeStorageSync("dream_history"),e.index.showToast({title:"已清除历史记录",icon:"success"}))}})},I=()=>{e.index.navigateBack()};e.onMounted((async()=>{const a=e.index.getStorageSync("dream_history");a&&(u.value=a),await _()}));const _=async()=>{try{if(o.value=!0,!y())return void e.index.showToast({title:"请先登录",icon:"none"});if(!(await $()))return void e.index.showToast({title:"网络连接不可用",icon:"none"});const a=await t.apiDreamQuery({content:"",page:"1",limit:"4"});n.value=a.data.records||[],r.value=!0,console.log("默认加载的数据:",a.data),console.log("梦境解析结果:",n.value)}catch(a){console.log("默认数据加载失败:",a)}finally{o.value=!1}};return(a,t)=>e.e({a:e.o(I),b:e.p({type:"search",size:"16",color:"#999"}),c:e.o(x),d:e.o(k),e:i.value,f:e.o((e=>i.value=e.detail.value)),g:e.o(k),h:e.o(x),i:v.value},v.value?e.e({j:u.value.length>0},u.value.length>0?{k:e.p({type:"trash",size:"16",color:"#999"}),l:e.o(P),m:e.f(u.value,((a,t,l)=>({a:e.t(a.keyword),b:t,c:e.o((e=>{return t=a.keyword,i.value=t,v.value=!1,void x();var t}),t)})))}:{},{n:e.f(f.value,((a,t,l)=>({a:e.t(a),b:t,c:e.o((e=>{return t=a,i.value=t,v.value=!1,void x();var t}),t)})))}):{},{o:!v.value},v.value?{}:{p:e.f(w.value,((a,t,l)=>({a:e.t(a.icon),b:e.t(a.name),c:e.t(a.numbers[0]),d:e.t(a.numbers[1]),e:t,f:e.o((e=>(e=>{i.value=e.keyword,x()})(a)),t)})))},{q:n.value.length>0},n.value.length>0?e.e({r:r.value&&i.value},r.value&&i.value?{s:e.t(n.value.length)}:{},{t:e.f(n.value,((a,t,l)=>e.e({a:!a.imageError&&a.img},!a.imageError&&a.img?{b:a.currentImageUrl||p(a.id,a.img),c:e.o((e=>((e,a)=>{if(console.log("图片加载失败:",e.img),e.imageError=!0,e.currentImageUrl="",!e.triedAlternativePaths){e.triedAlternativePaths=!0;const a="http://video.caimizm.com",t=[`${a}/web/dream/image/${e.id}`,`${a}/api/image/${e.id}`,`${a}/images/${e.id}/${e.img}`,`${a}/static/images/${e.img}`],l=e.currentPathIndex||0;l<t.length&&(e.currentPathIndex=l+1,e.currentImageUrl=t[l],console.log("尝试备用图片路径:",t[l]))}})(a)),t),d:e.o((e=>((e,a)=>{e.imageLoaded=!0})(a)),t)}:{},{e:e.t(a.content),f:a.numberOne||a.numberTwo},a.numberOne||a.numberTwo?e.e({g:a.numberOne},a.numberOne?{h:e.t(a.numberOne)}:{},{i:a.numberTwo},a.numberTwo?{j:e.t(a.numberTwo)}:{}):{},{k:t})))}):{},{v:n.value.length>0&&h.value&&!o.value},n.value.length>0&&h.value&&!o.value?e.e({w:m.value},m.value?{x:e.p({type:"spinner-cycle",size:"16",color:"#28B389"})}:{},{y:e.t(s.value),z:e.t(g.value),A:e.o(T),B:m.value}):{},{C:n.value.length>0&&!h.value&&!o.value},n.value.length>0&&!h.value&&!o.value?{D:e.t(d.value)}:{},{E:o.value},o.value?{F:e.p({type:"spinner-cycle",size:"24",color:"#28B389"})}:{},{G:!o.value&&0===n.value.length&&r.value&&i.value},!o.value&&0===n.value.length&&r.value&&i.value?{H:e.p({type:"info",size:"48",color:"#ccc"})}:{})}},n=e._export_sfc(l,[["__scopeId","data-v-5be869dd"]]);wx.createPage(n);
