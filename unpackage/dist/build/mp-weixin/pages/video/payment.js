"use strict";const e=require("../../common/vendor.js"),a=require("../../api/apis.js"),o=require("../../utils/request.js"),t={__name:"payment",setup(t){const n=e.ref(!1),c=e.ref(200),i=e.ref(""),l=e.ref(""),u=e.ref(null),r=e.ref(!1);e.ref(!1);const s=e.ref({info:"",amount:"",type:2,account:"",payType:0,channel:1});e.ref(null),e.onLoad((e=>{e.info&&(s.value.info=decodeURIComponent(e.info)),e.amount&&(s.value.amount=e.amount),e.type&&(s.value.type=parseInt(e.type)),e.account&&(s.value.account=decodeURIComponent(e.account)),e.payType&&(s.value.payType=parseInt(e.payType)),e.channel&&(s.value.channel=parseInt(e.channel)),e.videoId&&(s.value.videoId=e.videoId),s.value.account||(s.value.account=o.getAccount())}));const d=e=>{s.value.payType=parseInt(e.detail.value)},v=()=>{e.index.navigateBack()},p=()=>{e.index.showModal({title:"确认支付",content:`确认支付 ¥${s.value.amount}元 购买 ${s.value.amount}个金币？`,success:e=>{e.confirm&&h()}})},h=async()=>{e.index.showLoading({title:"处理中..."});try{const t={info:`用户充值${s.value.amount}元`,amount:s.value.amount.toString(),type:s.value.type,account:o.getAccount()||currentUser.value,payType:s.value.payType};if(1===s.value.payType){const n=await a.apiGetUserBalance({account:o.getAccount()});if(200!==n.code)return e.index.hideLoading(),void e.index.showToast({title:n.msg||"查询余额失败",icon:"none"});const c=parseFloat(n.data||0),i=parseFloat(s.value.amount);if(c<i)return console.log(c,i),e.index.hideLoading(),e.index.showToast({title:"余额不足，请充值",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/recharge/recharge"})}),1500);const l=await a.apiRewardVideo(t);if(200!==l.code)return e.index.hideLoading(),void e.index.showToast({title:l.msg||"创建订单失败",icon:"none"});const u=l.data,r=await a.apigoldpay({account:o.getAccount(),orderNo:u,remark:s.value.videoId});return e.index.hideLoading(),void(200===r.code?e.index.showModal({title:"支付成功",content:`成功支付${s.value.amount}金币`,showCancel:!1,success:()=>{v()}}):e.index.showToast({title:r.msg||"余额支付失败",icon:"none"}))}const c=await a.apiRewardVideo(t);if(200===c.code&&c.data){const a=await y(c.data);200===a.code?m(a.data):e.index.showToast({title:a.msg||"微信支付请求失败",icon:"none"})}else e.index.showToast({title:c.msg||"充值失败",icon:"none"});e.index.hideLoading(),200===c.code?c.data&&c.data.includes("weixin://wxpay")&&(i.value=c.data,n.value=!0,setTimeout((()=>{g(c.data),x()}),100)):e.index.showToast({title:c.msg||"充值失败",icon:"none"})}catch(t){e.index.hideLoading(),console.error("充值接口调用失败:",t),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},y=async e=>{try{const t={account:o.getAccount(),orderNo:e,remark:s.value.videoId};return await a.apiWxpay(t)}catch(t){return console.error("微信支付接口调用失败:",t),{code:500,msg:"微信支付接口调用失败"}}},m=e=>{e&&e.includes("weixin://wxpay")&&(i.value=e,n.value=!0,setTimeout((()=>{g(e),x()}),100))},g=e=>{try{"../../common/vendor.js".then((e=>e.browser)).then((a=>{a.toDataURL(e,{width:c.value,height:c.value,margin:2,color:{dark:"#000000",light:"#FFFFFF"}},((a,o)=>{a?(console.error("二维码生成失败:",a),w(e)):l.value=o}))})).catch((a=>{console.error("导入qrcode库失败:",a),w(e)}))}catch(a){console.error("生成二维码失败:",a),w(e)}},w=a=>{try{const e=encodeURIComponent(a),o=`https://api.qrserver.com/v1/create-qr-code/?size=${c.value}x${c.value}&data=${e}`;l.value=o}catch(o){console.error("在线二维码生成失败:",o),e.index.showToast({title:"二维码生成失败",icon:"none"})}},x=()=>{u.value&&clearInterval(u.value),r.value=!0;let a=0;u.value=setInterval((async()=>{try{a++;const o=await f();if(!0===o)return void(await I());!1===o&&console.log("支付状态检查中..."),a>=20&&(console.log("支付检查超时，停止检查"),L(),e.index.showToast({title:"支付检查超时，请手动确认",icon:"none",duration:3e3}))}catch(o){console.error("检查支付状态失败:",o)}}),3e3)},f=async()=>{try{const e=await a.apiCheckVideoPayment({videoId:s.value.videoId,account:o.getAccount()});return 200===e.code&&e.data}catch(e){return console.error("支付状态检查API调用失败:",e),!1}},T=()=>{L(),v()},I=async()=>{try{T(),L(),e.index.showModal({title:"支付成功",content:`恭喜您！成功充值${s.value.amount}个金币`,showCancel:!1,success:()=>{}})}catch(a){console.error("处理支付成功失败:",a)}},L=()=>{u.value&&(clearInterval(u.value),u.value=null),r.value=!1,console.log("停止检查支付状态")};return(a,o)=>{return e.e({a:e.o(v),b:e.t(s.value.info),c:e.t(s.value.amount),d:e.t((i=s.value.type,{0:"充值",1:"提现",2:"打赏",3:"视频付费"}[i]||"未知类型")),e:e.t((t=s.value.channel,{0:"电脑端",1:"微信小程序",2:"APP"}[t]||"未知渠道")),f:0===s.value.payType,g:1===s.value.payType,h:e.o(d),i:e.o(p),j:n.value},n.value?e.e({k:e.o(T),l:l.value},l.value?{m:l.value,n:c.value+"px",o:c.value+"px"}:{},{p:e.t(s.value.amount),q:r.value},(r.value,{}),{r:r.value},(r.value,{}),{s:e.o((()=>{})),t:e.o(T)}):{});var t,i}}},n=e._export_sfc(t,[["__scopeId","data-v-1820e72e"]]);wx.createPage(n);
