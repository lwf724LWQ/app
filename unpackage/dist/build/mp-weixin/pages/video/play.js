"use strict";const e=require("../../common/vendor.js"),a=require("../../api/apis.js"),i=require("../../utils/request.js"),t=require("../../stores/video.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"play",setup(o){const l=t.useVideoStore(),n=e.ref({id:"",title:"",src:"",account:"",likeCount:0,isLiked:!1}),u=e.ref(!0),c=e.ref(!1),v=e.ref(null),r=e.computed((()=>!n.value.flag||0===n.value.price)),s=e.ref({uname:"",himg:""});e.onLoad((async e=>{if(e.id){const a=l.getCurrentVideo;a&&a.id===e.id&&(n.value={id:a.id,title:a.title,src:a.src,account:a.account,likeCount:a.likeCount||0,isLiked:a.isLiked||!1,flag:a.flag,price:a.price},await p(a.account))}})),e.onMounted((()=>{v.value=e.index.createVideoContext("videoPlayer")}));const d=()=>{e.index.navigateBack({delta:1})},p=async e=>{try{const t={account:e},o={},l=i.getToken();l&&(o.Authorization=l);const n=await a.apiUserimg(t,o);200===n.code?s.value={uname:n.data.uname,himg:n.data.himg}:(console.error("获取用户信息失败:",n.message),s.value={uname:e,himg:""})}catch(t){console.error("获取用户信息异常:",t),s.value={uname:e,himg:""}}},g=async()=>{if(!i.getToken())return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/login/login"})}),1500);if(n.value.flag&&0!==n.value.price)try{(await a.apiCheckVideoPayment({videoId:n.value.id,account:i.getAccount()})).data?v.value&&(v.value.play(),c.value=!0,u.value=!1):e.index.showModal({title:"付费视频",content:`观看此视频需要支付${n.value.price}金币`,confirmText:"立即支付",cancelText:"取消",success:async e=>{e.confirm&&await m()}})}catch(t){e.index.showToast({title:t.message||"查询失败",icon:"none"})}else v.value&&(v.value.play(),c.value=!0,u.value=!1)},m=async()=>{const a={info:`视频: ${n.value.title}`,amount:n.value.price,type:3,account:i.getAccount(),payType:0,channel:0,videoId:n.value.id};e.index.navigateTo({url:`/pages/video/payment?${k(a)}`})},k=e=>Object.keys(e).map((a=>`${encodeURIComponent(a)}=${encodeURIComponent(e[a])}`)).join("&"),f=()=>{c.value=!0,u.value=!1},y=()=>{c.value=!1,u.value=!0},h=async()=>{n.value.flag&&0!==n.value.price?await m():v.value&&(v.value.play(),c.value=!0,u.value=!1)},C=()=>{if(!i.getToken())return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/login/login"})}),1500);e.index.navigateTo({url:`/pages/video/reward?videoId=${n.value.id}&author=${encodeURIComponent(n.value.account)}&title=${encodeURIComponent(n.value.title)}&authorAvatar=${encodeURIComponent(s.value.himg)}&authorName=${encodeURIComponent(s.value.uname)}`})},L=async()=>{try{n.value.isLiked,n.value.likeCount;n.value.isLiked=!n.value.isLiked,n.value.likeCount=n.value.isLiked?n.value.likeCount+1:n.value.likeCount-1;await a.apiGetIsLike({id:n.value.id,account:i.getAccount(),isLiked:n.value.isLiked});console.log("点赞操作成功");const e=await a.apiGetLikelist(i.getAccount());console.log(e)}catch(t){console.error("点赞操作失败:",t),n.value.isLiked=originalIsLiked,n.value.likeCount=originalLikeCount,e.index.showToast({title:"操作失败，请重试",icon:"none"})}};return(a,i)=>{return e.e({a:e.p({type:"left",size:"30"}),b:e.o(d),c:e.t(n.value.title),d:n.value.src,e:c.value,f:e.o(f),g:e.o(y),h:u.value},u.value?{i:e.p({type:"play-filled",size:"60",color:"#fff"}),j:e.o(g)}:{},{k:n.value.price&&n.value.price>0},n.value.price&&n.value.price>0?{l:e.t(n.value.price),m:e.o(h)}:{},{n:e.p({type:"gift-filled",size:"20",color:"#FF9500"}),o:e.o(C),p:e.p({type:n.value.isLiked?"heart-filled":"heart",size:"20",color:n.value.isLiked?"#ff4757":"#FF9500"}),q:e.t(n.value.likeCount),r:n.value.isLiked?1:"",s:e.o(L),t:(t=s.value.himg,t?`http://video.caimizm.com/himg/${t}`:""),v:e.t(s.value.uname),w:n.value.price&&n.value.price>0},n.value.price&&n.value.price>0?{x:e.t(n.value.price)}:{},{y:e.t(n.value.title),z:e.p({type:"home",size:"24",color:"#FFD700"}),A:e.t(r.value?"开始学习":"点击购买"),B:e.o(h)});var t}}},l=e._export_sfc(o,[["__scopeId","data-v-b54eccd3"]]);wx.createPage(l);
