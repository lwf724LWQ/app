"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/tool.js"),l=require("../../api/apis.js"),u=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"oss",setup(t){const o=()=>{e.index.navigateBack({delta:1})},s=e.ref([]),v=e.ref([]),r=e.ref(0),n=e.ref("请选择要上传的文件"),i=e.ref(""),c=e.ref(""),m=e.ref(1),g=e.ref(""),p=e.ref(""),f=e.ref(null),d=()=>{e.index.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{e.tempFilePaths,console.log(e.tempFilePaths),s.value=e.tempFiles,n.value=`已选择${s.value.length}个文件，点击"开始上传"按钮上传`,i.value="status-warning"}})},h=()=>{e.index.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{const a=e.tempFilePaths[0];p.value=a,f.value=e.tempFiles[0]}})},y=async()=>{if(0===s.value.length)return n.value="请先选择文件",void(i.value="status-error");if(!c.value.trim())return n.value="请输入视频标题",void(i.value="status-error");if(2===m.value&&(!g.value||Number(g.value)<=0))return n.value="请输入有效的收费价格",void(i.value="status-error");n.value="正在上传...",i.value="status-warning",r.value=0;for(let t=0;t<s.value.length;t++){const o=s.value[t];try{const e=await a.tool.oss.upload(o,{folder:"videos",progress:e=>{r.value=Math.floor(100*e),n.value=`视频上传中: ${r.value}%`}});console.log("视频上传成功:",e.name);let t="";if(f.value){n.value="正在上传封面...";t=(await a.tool.oss.upload(f.value,{folder:"vimg",progress:()=>{}})).name,console.log("封面上传成功:",t)}const s={title:c.value,flag:2===m.value,price:2===m.value?Number(g.value):0,account:u.getAccount(),url:e.name,vimg:t},d=await l.apiSubmitVideo(s);console.log("视频信息提交成功:",d),v.value.push({name:o.name,size:o.size,url:e.url,coverUrl:t}),n.value=`文件"${o.name}"上传成功`,i.value="status-success",c.value="",m.value=1,g.value="",p.value="",f.value=null}catch(e){n.value=`文件"${o.name}"上传失败: ${e.message}`,i.value="status-error"}}},z=()=>{s.value=[],v.value=[],r.value=0,p.value="",f.value=null,n.value="已清空所有文件",i.value="status-warning"},b=e=>{if(0===e)return"0 Bytes";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["Bytes","KB","MB","GB"][a]};return(a,l)=>e.e({a:e.p({type:"left",size:"30"}),b:e.o(o),c:c.value,d:e.o((e=>c.value=e.detail.value)),e:1===m.value,f:e.o((e=>m.value=1)),g:2===m.value,h:e.o((e=>m.value=2)),i:2===m.value},2===m.value?{j:g.value,k:e.o((e=>g.value=e.detail.value))}:{},{l:e.p({name:"plus",size:"50",color:"#3498db"}),m:e.o(d),n:s.value.length>0},s.value.length>0?e.e({o:p.value},p.value?{p:p.value}:{q:e.p({name:"image",size:"40",color:"#ccc"})},{r:e.o(h)}):{},{s:r.value>0},r.value>0?{t:r.value}:{},{v:e.t(n.value),w:e.n(i.value),x:e.o(y),y:0===s.value.length,z:e.o(z),A:0===s.value.length,B:v.value.length>0},v.value.length>0?{C:e.f(v.value,((a,l,u)=>({a:"b55ec0d4-3-"+u,b:e.t(a.name),c:e.t(b(a.size)),d:e.t(a.url),e:l}))),D:e.p({name:"file",size:"24",color:"#409eff"})}:{})}};wx.createPage(t);
