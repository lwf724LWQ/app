"use strict";const e=require("../../common/vendor.js"),a=require("../../api/apis.js"),o=require("../../utils/request.js"),t={__name:"reward",setup(t){const n=e.ref([1.8,3.8,5.8,6.8,8.8,18,38,58,68]),l=e.ref(3.8),r=e.ref(""),i=e.ref(!1),u=e.ref("0"),c=e.ref("追梦人"),v=e.ref(""),s=e.ref("海南省 - 儋州市"),d=e.ref({videoId:"",author:"",title:"",authorAvatar:"",authorName:""}),h=e.ref(!1),m=e.ref(200),w=e.ref(""),g=e.ref(""),p=e.ref(null),x=e.ref(!1);e.onLoad((e=>{e.videoId&&(d.value.videoId=e.videoId),e.author&&(d.value.author=decodeURIComponent(e.author)),e.title&&(d.value.title=decodeURIComponent(e.title)),e.authorAvatar&&(v.value=decodeURIComponent(e.authorAvatar)),e.authorName&&(c.value=decodeURIComponent(e.authorName))}));const f=e=>{u.value=e.detail.value},y=()=>{e.index.navigateBack()},I=()=>{r.value<0&&(r.value="")},T=()=>{if(!r.value)return void e.index.showToast({title:"请输入金额",icon:"none"});const a=parseFloat(r.value);isNaN(a)||a<=0?e.index.showToast({title:"请输入有效金额",icon:"none"}):(l.value=a,i.value=!0,e.index.showToast({title:"已选择自定义金额",icon:"success"}))},q=async()=>{if(!o.getToken())return e.index.showToast({title:"请先登录",icon:"none"}),void setTimeout((()=>{e.index.navigateTo({url:"/pages/login/login"})}),1500);"1"!==u.value?e.index.showModal({title:"确认支付",content:`确认支付 ¥${l.value}元 打赏作者？`,success:e=>{e.confirm&&k()}}):await k()},k=async()=>{e.index.showLoading({title:"处理中..."});try{const t={info:`打赏视频: ${d.value.title}`,amount:l.value.toString(),type:2,account:o.getAccount(),payType:u.value,channel:1},n=await a.apiRewardVideo(t);if(200===n.code&&n.data){const a=await A(n.data);200===a.code?C(a.data):e.index.showToast({title:a.msg||"微信支付请求失败",icon:"none"})}else e.index.showToast({title:n.msg||"打赏失败",icon:"none"});e.index.hideLoading()}catch(t){e.index.hideLoading(),console.error("打赏接口调用失败:",t),e.index.showToast({title:"网络错误，请重试",icon:"none"})}},A=async e=>{try{const t={account:o.getAccount(),orderNo:e,remark:d.value.videoId};return await a.apiWxpay(t)}catch(t){return console.error("微信支付接口调用失败:",t),{code:500,msg:"微信支付接口调用失败"}}},C=e=>{e&&e.includes("weixin://wxpay")&&(w.value=e,h.value=!0,setTimeout((()=>{F(e),$()}),100))},F=e=>{try{"../../common/vendor.js".then((e=>e.browser)).then((a=>{a.toDataURL(e,{width:m.value,height:m.value,margin:2,color:{dark:"#000000",light:"#FFFFFF"}},((a,o)=>{a?(console.error("二维码生成失败:",a),R(e)):g.value=o}))})).catch((a=>{console.error("导入qrcode库失败:",a),R(e)}))}catch(a){console.error("生成二维码失败:",a),R(e)}},R=a=>{try{const e=encodeURIComponent(a),o=`https://api.qrserver.com/v1/create-qr-code/?size=${m.value}x${m.value}&data=${e}`;g.value=o}catch(o){console.error("在线二维码生成失败:",o),e.index.showToast({title:"二维码生成失败",icon:"none"})}},$=()=>{p.value&&clearInterval(p.value),x.value=!0;let a=0;p.value=setInterval((async()=>{try{a++;const o=await N();if(!0===o)return void(await U());!1===o&&console.log("支付状态检查中..."),a>=20&&(console.log("支付检查超时，停止检查"),j(),e.index.showToast({title:"支付检查超时，请手动确认",icon:"none",duration:3e3}))}catch(o){console.error("检查支付状态失败:",o)}}),3e3)},N=async()=>{try{const e=await a.apiCheckVideoPayment({videoId:d.value.videoId,account:o.getAccount()});return 200===e.code&&e.data}catch(e){return console.error("支付状态检查API调用失败:",e),!1}},U=async()=>{try{j(),e.index.showModal({title:"支付成功",content:`恭喜您！成功打赏${l.value}金币`,showCancel:!1,success:()=>{_(),setTimeout((()=>{e.index.navigateBack()}),500)}})}catch(a){console.error("处理支付成功失败:",a)}},_=()=>{j(),h.value=!1,w.value="",g.value=""},j=()=>{p.value&&(clearInterval(p.value),p.value=null),x.value=!1,console.log("停止检查支付状态")};return(a,o)=>{return e.e({a:e.o(y),b:(t=v.value,t?`http://video.caimizm.com/himg/${t}`:"/static/default-avatar.png"),c:e.t(c.value),d:e.t(s.value),e:e.f(n.value,((a,o,t)=>({a:e.t(a),b:o,c:l.value===a?1:"",d:e.o((e=>(e=>{l.value=e,i.value=!1})(a)),o)}))),f:e.o([e=>r.value=e.detail.value,I]),g:r.value,h:e.o(T),i:"0"===u.value,j:"1"===u.value,k:e.o(f),l:e.t(l.value),m:e.o(q),n:h.value},h.value?e.e({o:e.o(_),p:g.value},g.value?{q:g.value,r:m.value+"px",s:m.value+"px"}:{},{t:e.t(l.value),v:x.value},(x.value,{}),{w:x.value},(x.value,{}),{x:e.o((()=>{})),y:e.o(_)}):{});var t}}},n=e._export_sfc(t,[["__scopeId","data-v-edb93c9d"]]);wx.createPage(n);
