import{r as e,C as a,R as l,_ as t,G as i,c as s,b as o,u,o as c,e as n,f as r,x as d,g as v,n as f,q as p,s as m,p as y,j as _,a0 as k,t as g,A as h,v as C}from"./index-D0AdlXYI.js";import{_ as b}from"./uni-icons.E5IxVglq.js";import{o as L,r as w}from"./uni-app.es.DeTReHEE.js";import{g as j,i as I,j as $,f as x,k as z,l as R}from"./apis.BsLnrVmb.js";import{u as F}from"./video.xuvhOoAH.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";const T=U({__name:"play",setup(U){const T=F(),P=e({id:"",title:"",src:"",account:"",likeCount:0,isLiked:!1}),A=e(!0),q=e(!1),D=e(null),G=a((()=>!P.value.flag||0===P.value.price)),N=e({uname:"",himg:""});L((async e=>{if(e.id){const a=T.getCurrentVideo;a&&a.id===e.id&&(P.value={id:a.id,title:a.title,src:a.src,account:a.account,likeCount:a.likeCount||0,isLiked:a.isLiked||!1,flag:a.flag,price:a.price},await V(a.account))}})),l((()=>{D.value=t("videoPlayer")}));const O=()=>{p({delta:1})},V=async e=>{try{const a={account:e},l={},t=j();t&&(l.Authorization=t);const i=await I(a,l);200===i.code?N.value={uname:i.data.uname,himg:i.data.himg}:(console.error("获取用户信息失败:",i.message),N.value={uname:e,himg:""})}catch(a){console.error("获取用户信息异常:",a),N.value={uname:e,himg:""}}},B=async()=>{if(!j())return m({title:"请先登录",icon:"none"}),void setTimeout((()=>{y({url:"/pages/login/login"})}),1500);if(P.value.flag&&0!==P.value.price)try{(await $({videoId:P.value.id,account:x()})).data?D.value&&(D.value.play(),q.value=!0,A.value=!1):_({title:"付费视频",content:`观看此视频需要支付${P.value.price}金币`,confirmText:"立即支付",cancelText:"取消",success:async e=>{e.confirm&&await E()}})}catch(e){m({title:e.message||"查询失败",icon:"none"})}else D.value&&(D.value.play(),q.value=!0,A.value=!1)},E=async()=>{const e={info:`视频: ${P.value.title}`,amount:P.value.price,type:3,account:x(),payType:0,channel:0,videoId:P.value.id};y({url:`/pages/video/payment?${H(e)}`})},H=e=>Object.keys(e).map((a=>`${encodeURIComponent(a)}=${encodeURIComponent(e[a])}`)).join("&"),J=()=>{q.value=!0,A.value=!1},K=()=>{q.value=!1,A.value=!0},M=async()=>{P.value.flag&&0!==P.value.price?await E():D.value&&(D.value.play(),q.value=!0,A.value=!1)},Q=()=>{if(!j())return m({title:"请先登录",icon:"none"}),void setTimeout((()=>{y({url:"/pages/login/login"})}),1500);y({url:`/pages/video/reward?videoId=${P.value.id}&author=${encodeURIComponent(P.value.account)}&title=${encodeURIComponent(P.value.title)}&authorAvatar=${encodeURIComponent(N.value.himg)}&authorName=${encodeURIComponent(N.value.uname)}`})},S=async()=>{try{P.value.isLiked,P.value.likeCount;P.value.isLiked=!P.value.isLiked,P.value.likeCount=P.value.isLiked?P.value.likeCount+1:P.value.likeCount-1;await z({id:P.value.id,account:x(),isLiked:P.value.isLiked});console.log("点赞操作成功");const e=await R(x());console.log(e)}catch(e){console.error("点赞操作失败:",e),P.value.isLiked=originalIsLiked,P.value.likeCount=originalLikeCount,m({title:"操作失败，请重试",icon:"none"})}};return(e,a)=>{const l=w(i("uni-icons"),b),t=u,p=k,m=g,y=h,_=C;return c(),s(t,{class:"container"},{default:o((()=>[n(t,{class:"wrapper"},{default:o((()=>[n(t,{class:"navbar"},{default:o((()=>[n(t,{class:"navbar-left",onClick:O},{default:o((()=>[n(l,{type:"left",size:"30"})])),_:1}),n(t,{class:"navbar-title"},{default:o((()=>[r(d(P.value.title),1)])),_:1})])),_:1}),n(t,{class:"video-container"},{default:o((()=>[n(p,{src:P.value.src,controls:q.value,autoplay:!1,"object-fit":"cover",class:"video-player",id:"videoPlayer",onPlay:J,onPause:K},null,8,["src","controls"]),A.value?(c(),s(t,{key:0,class:"play-overlay",onClick:B},{default:o((()=>[n(t,{class:"play-button"},{default:o((()=>[n(l,{type:"play-filled",size:"60",color:"#fff"})])),_:1})])),_:1})):v("",!0),P.value.price&&P.value.price>0?(c(),s(t,{key:1,class:"buy-overlay",onClick:M},{default:o((()=>[n(t,{class:"buy-button"},{default:o((()=>[n(m,{class:"buy-text"},{default:o((()=>[r("¥"+d(P.value.price)+"购买",1)])),_:1})])),_:1})])),_:1})):v("",!0)])),_:1}),n(t,{class:"interaction-bar"},{default:o((()=>[n(t,{class:"reward-interaction",onClick:Q},{default:o((()=>[n(l,{type:"gift-filled",size:"20",color:"#FF9500"}),n(m,{class:"interaction-text"},{default:o((()=>[r("打赏 0")])),_:1})])),_:1}),n(t,{class:f(["like-interaction",{liked:P.value.isLiked}]),onClick:S},{default:o((()=>[n(l,{type:P.value.isLiked?"heart-filled":"heart",size:"20",color:P.value.isLiked?"#ff4757":"#FF9500"},null,8,["type","color"]),n(m,{class:"interaction-text"},{default:o((()=>[r("点赞 "+d(P.value.likeCount),1)])),_:1})])),_:1},8,["class"])])),_:1}),n(t,{class:"video-info-card"},{default:o((()=>[n(t,{class:"info-header"},{default:o((()=>{return[n(y,{src:(e=N.value.himg,e?`http://video.caimizm.com/himg/${e}`:""),class:"author-avatar"},null,8,["src"]),n(t,{class:"author-info"},{default:o((()=>[n(m,{class:"author-name"},{default:o((()=>[r(d(N.value.uname)+"出品",1)])),_:1}),n(m,{class:"video-count"},{default:o((()=>[r("视频")])),_:1})])),_:1}),n(t,{class:"header-actions"},{default:o((()=>[n(_,{class:"teacher-btn"},{default:o((()=>[r("讲师主页")])),_:1}),n(_,{class:"follow-btn"},{default:o((()=>[r("+ 关注")])),_:1})])),_:1})];var e})),_:1}),n(t,{class:"video-title-section"},{default:o((()=>[P.value.price&&P.value.price>0?(c(),s(t,{key:0,class:"price-tag"},{default:o((()=>[n(m,null,{default:o((()=>[r("¥"+d(P.value.price),1)])),_:1})])),_:1})):v("",!0),n(m,{class:"video-title-text"},{default:o((()=>[r(d(P.value.title),1)])),_:1})])),_:1})])),_:1}),n(t,{class:"bottom-bar"},{default:o((()=>[n(t,{class:"bottom-left"},{default:o((()=>[n(t,{class:"icon-item"},{default:o((()=>[n(l,{type:"home",size:"24",color:"#FFD700"}),n(m,{class:"icon-label"},{default:o((()=>[r("首页")])),_:1})])),_:1})])),_:1}),n(_,{class:"bottom-buy-btn",onClick:M},{default:o((()=>[r(d(G.value?"开始学习":"点击购买"),1)])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-b54eccd3"]]);export{T as default};
