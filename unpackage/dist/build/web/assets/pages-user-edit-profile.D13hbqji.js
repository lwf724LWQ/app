import{a,r as e,R as t,G as s,c as n,b as c,s as o,q as i,l,u as r,o as m,e as u,f as d,z as p,a7 as f,h,i as v,k as g,a8 as k,t as y,A as _,I as S,v as w,a1 as T}from"./index-BgH6xnyV.js";import{_ as b}from"./uni-icons.C97tYrvo.js";import{r as I}from"./uni-app.es.wmAOsoD-.js";import{f as z,g as K,q as j,t as x}from"./apis.BPdXt_sA.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const V=D({__name:"edit-profile",setup(D){const V=a({avatar:"http://video.caimizm.com/himg/user.png",nickname:"",phone:""}),E=e(!1),F=()=>{i()},P=()=>{V.avatar="http://video.caimizm.com/himg/user.png"},A=async()=>{try{const a=await f({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(a.tempFilePaths&&a.tempFilePaths.length>0){const e=a.tempFilePaths[0];let t;if(h({title:"上传头像中..."}),"undefined"!=typeof window){const a=await fetch(e),s=await a.blob();t=new File([s],"avatar.jpg",{type:"image/jpeg"})}else t=e;await(async(a,e)=>{try{let t=a.name||"";t.split(".").slice(0,t.split(".").length-1).join(".");const s=(new Date).getTime()+"."+t.split(".")[t.split(".").length-1];let n=await x({});if(console.log("STS接口返回数据:",n),console.log("STS接口返回的data字段:",n.data),200!==n.code)throw new Error("获取上传凭证失败");const c=await T((()=>import("./aliyun-oss-sdk.ehYCrfZk.js").then((a=>a.a))),[]),o={region:n.data.region||"cn-guangzhou",accessKeyId:n.data.STSaccessKeyId,accessKeySecret:n.data.STSsecretAccessKey,stsToken:n.data.security_token,bucket:n.data.bucket||"cjvd",endpoint:"https://oss-cn-guangzhou.aliyuncs.com",refreshSTSToken:async()=>{const a=await x({});return{accessKeyId:a.data.STSaccessKeyId,accessKeySecret:a.data.STSsecretAccessKey,stsToken:a.data.security_token}},refreshSTSTokenInterval:3e5};console.log("OSS配置:",{region:o.region,bucket:o.bucket,endpoint:o.endpoint,accessKeyId:o.accessKeyId?"***":"MISSING",accessKeySecret:o.accessKeySecret?"***":"MISSING",stsToken:o.stsToken?"***":"MISSING"});const i=new c.default(o);console.log("开始上传文件:",s);const l=await i.put(`himg/${s}`,a);if(!l||!l.url)throw new Error("上传失败");{const a=`http://video.caimizm.com/himg/${s}`;console.log("上传成功，生成的自定义URL:",a),e(a)}}catch(t){throw console.error("OSS上传失败:",t),t}})(t,(a=>{V.avatar=a,v(),o({title:"头像上传成功",icon:"success"}),g("userInfo",{nickname:V.nickname,avatar:V.avatar});const e=l("loginData")||{};e.himg=V.avatar,g("loginData",e)}))}}catch(a){v(),console.error("头像上传失败:",a),o({title:"头像上传失败",icon:"none"})}},C=async()=>{if((V.nickname.trim()||(o({title:"请输入昵称",icon:"none"}),0))&&!E.value)try{E.value=!0,h({title:"保存中..."});const a={account:V.phone,uname:V.nickname};if(V.avatar&&"http://video.caimizm.com/himg/user.png"!==V.avatar){const e=V.avatar.replace("http://video.caimizm.com/himg/","");a.himg=e}const e=await j(a);if(v(),200!==e.code)throw new Error(e.msg||"保存失败");o({title:"保存成功",icon:"success"}),g("userInfo",{nickname:V.nickname,avatar:V.avatar});const t=l("loginData")||{};t.uname=V.nickname,t.himg=V.avatar,g("loginData",t),k("userProfileUpdated",{nickname:V.nickname,avatar:V.avatar}),setTimeout((()=>{i()}),1500)}catch(a){v(),console.error("保存失败:",a),o({title:"保存失败，请重试",icon:"none"})}finally{E.value=!1}};return t((()=>{(async()=>{const a=z(),e=K();if(!a)return o({title:"请先登录",icon:"none"}),void setTimeout((()=>{i()}),1500);try{const a=l("userInfo")||{},t=l("loginData")||{};t.uname||t.account?(V.nickname=t.uname||"用户",V.phone=t.account||e||"",V.avatar=t.himg||"http://video.caimizm.com/himg/user.png"):(V.nickname=a.nickname||"用户",V.phone=e||"13637666646",V.avatar=a.avatar||"http://video.caimizm.com/himg/user.png"),console.log("加载的用户信息:",{nickname:V.nickname,phone:V.phone,avatar:V.avatar,loginData:t})}catch(t){console.error("加载用户信息失败:",t),V.nickname=e||"用户",V.phone=e||"13637666646",V.avatar="http://video.caimizm.com/himg/user.png"}})()})),(a,e)=>{const t=y,o=r,i=_,l=I(s("uni-icons"),b),f=S,h=w;return m(),n(o,{class:"edit-profile-container"},{default:c((()=>[u(o,{class:"navbar"},{default:c((()=>[u(o,{class:"nav-content"},{default:c((()=>[u(o,{class:"nav-left",onClick:F},{default:c((()=>[u(t,{class:"back-arrow"},{default:c((()=>[d("‹")])),_:1})])),_:1}),u(t,{class:"nav-title"},{default:c((()=>[d("编辑资料")])),_:1}),u(o,{class:"nav-right",onClick:C},{default:c((()=>[u(t,{class:"save-text"},{default:c((()=>[d("保存")])),_:1})])),_:1})])),_:1})])),_:1}),u(o,{class:"main-content"},{default:c((()=>[u(o,{class:"avatar-section"},{default:c((()=>[u(o,{class:"avatar-container",onClick:A},{default:c((()=>[u(i,{src:V.avatar,mode:"aspectFill",class:"avatar-image",onError:P},null,8,["src"]),u(o,{class:"avatar-overlay"},{default:c((()=>[u(l,{type:"camera",size:"24",color:"#fff"}),u(t,{class:"avatar-text"},{default:c((()=>[d("点击上传头像")])),_:1})])),_:1})])),_:1})])),_:1}),u(o,{class:"form-section"},{default:c((()=>[u(o,{class:"form-item"},{default:c((()=>[u(t,{class:"form-label"},{default:c((()=>[d("昵称")])),_:1}),u(f,{type:"text",modelValue:V.nickname,"onUpdate:modelValue":e[0]||(e[0]=a=>V.nickname=a),placeholder:"请输入昵称",class:"form-input",maxlength:"20"},null,8,["modelValue"])])),_:1}),u(o,{class:"form-item"},{default:c((()=>[u(t,{class:"form-label"},{default:c((()=>[d("手机号")])),_:1}),u(f,{type:"text",modelValue:V.phone,"onUpdate:modelValue":e[1]||(e[1]=a=>V.phone=a),placeholder:"手机号",class:"form-input disabled",maxlength:"11",disabled:""},null,8,["modelValue"])])),_:1})])),_:1}),u(o,{class:"save-section"},{default:c((()=>[u(h,{class:"save-btn",onClick:C,disabled:E.value},{default:c((()=>[E.value?(m(),n(l,{key:0,type:"spinner-cycle",size:"16",color:"#fff"})):(m(),n(t,{key:1,class:"save-btn-text"},{default:c((()=>[d(p(E.value?"保存中...":"保存修改"),1)])),_:1}))])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-dfba4ed5"]]);export{V as default};
