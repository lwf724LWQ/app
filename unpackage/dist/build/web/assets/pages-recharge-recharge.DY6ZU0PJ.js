import{r as e,C as a,R as t,s as l,p as s,al as c,c as u,b as n,u as o,o as r,e as i,f as d,x as v,H as f,n as _,g as p,K as h,q as m,j as y,t as k,v as g,I as w,ao as x,A as b,h as C,i as q,a1 as I}from"./index-D0AdlXYI.js";import{g as $,f as F,h as R,I as T,J as U}from"./apis.BsLnrVmb.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=D({__name:"recharge",setup(D){const j=e("vfmumq"),V=e(0),E=e(10),N=e(""),z=e(!1),A=e(!1),L=e(200),O=e(""),H=e(""),J=e(null),K=e(!1),P=e(!1),S=e(""),B=e(!1),G=a((()=>N.value&&N.value>0?N.value:E.value)),M=a((()=>z.value&&G.value>0)),Q=()=>{m()},W=()=>{y({title:"充值说明",content:"1元=1金币，金币仅限平台内使用，充值后不可退还。",showCancel:!1})},X=e=>{E.value=e,N.value=""},Y=()=>{N.value&&N.value>0&&(E.value=0)},Z=()=>{z.value=!z.value},ee=()=>{y({title:"充值服务协议",content:"这里是充值服务协议的内容...",showCancel:!1})},ae=()=>{s({url:"/pages/transaction/transaction"})},te=()=>{M.value&&y({title:"确认支付",content:`确认支付 ¥${G.value}元 购买 ${G.value}个金币？`,success:e=>{e.confirm&&le()}})},le=async()=>{C({title:"处理中..."});try{const e={info:`用户充值${G.value}元`,amount:G.value.toString(),type:0,account:F()||j.value,payType:0,channel:0},a=await T(e);q(),200===a.code?a.data&&a.data.coreUrl&&a.data.coreUrl.includes("weixin://wxpay")?(S.value=a.data.orderNo||`ORDER_${Date.now()}`,O.value=a.data.coreUrl,A.value=!0,setTimeout((()=>{ce(a.data.coreUrl),de()}),100)):(l({title:a.msg||"充值成功",icon:"success"}),await se(),y({title:"支付成功",content:`恭喜您！成功充值${G.value}个金币`,showCancel:!1,success:()=>{re(),setTimeout((()=>{s({url:"/pages/orders/orders"})}),500)}}),E.value=10,N.value="",z.value=!1):l({title:a.msg||"充值失败",icon:"none"})}catch(e){q(),l({title:"网络错误，请重试",icon:"none"})}},se=async()=>{if(B.value)console.log("正在加载用户信息，跳过重复请求");else try{B.value=!0;const e=F();if(e){j.value=e;const a=await R({account:e});200===a.code&&(V.value=a.data||0)}}catch(e){console.error("获取用户信息失败:",e)}finally{B.value=!1}},ce=e=>{try{I((()=>import("./browser.BBL8EhVO.js").then((e=>e.b))),[]).then((a=>{a.toDataURL(e,{width:L.value,height:L.value,margin:2,color:{dark:"#000000",light:"#FFFFFF"}},((a,t)=>{a?ue(e):H.value=t}))})).catch((a=>{ue(e)}))}catch(a){ue(e)}},ue=e=>{try{const a=encodeURIComponent(e),t=`https://api.qrserver.com/v1/create-qr-code/?size=${L.value}x${L.value}&data=${a}`;H.value=t}catch(a){l({title:"二维码生成失败",icon:"none"})}},ne=()=>{ve(),A.value=!1,O.value="",H.value="",S.value=""},oe=async()=>{try{P.value=!0,await se(),E.value=10,N.value="",z.value=!1,setTimeout((()=>{P.value=!1}),1e3)}catch(e){P.value=!1,l({title:"刷新失败",icon:"none",duration:2e3})}},re=async()=>{try{await se(),E.value=10,N.value="",z.value=!1}catch(e){}},ie=async()=>{try{ve(),await se(),y({title:"支付成功",content:`恭喜您！成功充值${G.value}个金币`,showCancel:!1,success:()=>{re(),setTimeout((()=>{s({url:"/pages/orders/orders"})}),500)}}),ne(),E.value=10,N.value="",z.value=!1}catch(e){}},de=()=>{J.value&&clearInterval(J.value),K.value=!0;let e=0;const a=Date.now();J.value=setInterval((async()=>{try{e++;const s=await U({orderNo:S.value});if(200===s.code){const a=s.data;if("success"===a||"paid"===a||1===a)return ve(),void(await ie());if(("failed"===a||"cancelled"===a||0===a)&&e>=5)return ve(),l({title:"支付失败，请重试",icon:"none",duration:3e3}),void ne()}if(Date.now()-a>=6e4){ve();try{const e=await U({orderNo:S.value});if(200===e.code){const a=e.data;"success"===a||"paid"===a||1===a?await ie():(l({title:"支付失败，请重试",icon:"none",duration:3e3}),ne())}else l({title:"支付失败，请重试",icon:"none",duration:3e3}),ne()}catch(t){l({title:"支付失败，请重试",icon:"none",duration:3e3}),ne()}return}}catch(t){e>=20&&(ve(),l({title:"支付检查失败，请重试",icon:"none",duration:3e3}),ne())}}),1e4)},ve=()=>{J.value&&(clearInterval(J.value),J.value=null),K.value=!1};return t((async()=>{$()?await se():(l({title:"请先登录",icon:"none"}),setTimeout((()=>{s({url:"/pages/login/login"})}),1500))})),c((()=>{ve()})),(e,a)=>{const t=k,l=o,s=g,c=w,m=x,y=b;return r(),u(l,{class:"recharge-container"},{default:n((()=>[i(l,{class:"navbar"},{default:n((()=>[i(l,{class:"nav-content"},{default:n((()=>[i(l,{class:"nav-left",onClick:Q},{default:n((()=>[i(t,{class:"back-arrow"},{default:n((()=>[d("‹")])),_:1})])),_:1}),i(t,{class:"nav-title"},{default:n((()=>[d("我的金币")])),_:1}),i(l,{class:"nav-right",onClick:W},{default:n((()=>[i(t,{class:"help-text"},{default:n((()=>[d("说明")])),_:1})])),_:1})])),_:1})])),_:1}),i(m,{class:"main-content","scroll-y":"true","refresher-enabled":"true","refresher-triggered":P.value,onRefresherrefresh:oe,"refresher-threshold":100,"refresher-default-style":"black","refresher-background":"#f5f5f5","enable-passive":!0},{default:n((()=>[i(l,{class:"user-info-section"},{default:n((()=>[i(t,{class:"user-text"},{default:n((()=>[d("当前用户: "+v(j.value),1)])),_:1}),i(l,{class:"balance-section"},{default:n((()=>[i(t,{class:"balance-text"},{default:n((()=>[d("我的余额: ")])),_:1}),i(t,{class:"balance-amount"},{default:n((()=>[d(v(V.value)+"金币",1)])),_:1}),i(s,{class:"record-btn",onClick:f(ae,["stop"])},{default:n((()=>[d("金币交易记录")])),_:1})])),_:1})])),_:1}),i(l,{class:"recharge-section"},{default:n((()=>[i(t,{class:"section-title"},{default:n((()=>[d("充值金币")])),_:1}),i(l,{class:"amount-options"},{default:n((()=>[i(l,{class:_(["amount-option",{active:10===E.value}]),onClick:a[0]||(a[0]=f((e=>X(10)),["stop"]))},{default:n((()=>[i(t,{class:"amount-text"},{default:n((()=>[d("10个金币")])),_:1}),i(t,{class:"price-text"},{default:n((()=>[d("10元")])),_:1}),10===E.value?(r(),u(l,{key:0,class:"check-icon"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"]),i(l,{class:_(["amount-option",{active:50===E.value}]),onClick:a[1]||(a[1]=f((e=>X(50)),["stop"]))},{default:n((()=>[i(t,{class:"amount-text"},{default:n((()=>[d("50个金币")])),_:1}),i(t,{class:"price-text"},{default:n((()=>[d("50元")])),_:1}),50===E.value?(r(),u(l,{key:0,class:"check-icon"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"]),i(l,{class:_(["amount-option",{active:100===E.value}]),onClick:a[2]||(a[2]=f((e=>X(100)),["stop"]))},{default:n((()=>[i(t,{class:"amount-text"},{default:n((()=>[d("100个金币")])),_:1}),i(t,{class:"price-text"},{default:n((()=>[d("100元")])),_:1}),100===E.value?(r(),u(l,{key:0,class:"check-icon"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"])])),_:1}),i(l,{class:"custom-amount-section"},{default:n((()=>[i(c,{type:"number",placeholder:"自定义金额",class:"custom-input",modelValue:N.value,"onUpdate:modelValue":a[3]||(a[3]=e=>N.value=e),onInput:Y},null,8,["modelValue"]),i(t,{class:"conversion-text"},{default:n((()=>[d("元="+v(N.value||0)+"金币",1)])),_:1})])),_:1}),i(l,{class:"agreement-section"},{default:n((()=>[i(l,{class:"agreement-checkbox",onClick:f(Z,["stop"])},{default:n((()=>[i(l,{class:_(["checkbox",{checked:z.value}])},{default:n((()=>[z.value?(r(),u(t,{key:0,class:"check-mark"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"]),i(t,{class:"agreement-text"},{default:n((()=>[d(" 我已阅读并同意 "),i(t,{class:"link-text",onClick:f(ee,["stop","prevent"])},{default:n((()=>[d("《充值服务协议》")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),i(l,{class:"rules-section"},{default:n((()=>[i(t,{class:"rule-item"},{default:n((()=>[d("1、1元=1金币")])),_:1}),i(t,{class:"rule-item"},{default:n((()=>[d("2、金币仅限于平台内部使用,充值后不可退还,不可兑换,不可提现")])),_:1}),i(t,{class:"rule-item"},{default:n((()=>[d("3、若有疑问、请联系管理员")])),_:1})])),_:1}),i(l,{class:"payment-section"},{default:n((()=>[i(s,{class:_(["payment-btn",{disabled:!M.value}]),onClick:f(te,["stop"]),disabled:!M.value},{default:n((()=>[d(" 支付 ¥"+v(G.value)+"元 ",1)])),_:1},8,["class","disabled"])])),_:1})])),_:1},8,["refresher-triggered"]),A.value?(r(),u(l,{key:0,class:"qr-modal",onClick:ne},{default:n((()=>[i(l,{class:"qr-content",onClick:a[4]||(a[4]=f((()=>{}),["stop"]))},{default:n((()=>[i(l,{class:"qr-header"},{default:n((()=>[i(t,{class:"qr-title"},{default:n((()=>[d("扫码支付")])),_:1}),i(t,{class:"close-btn",onClick:ne},{default:n((()=>[d("×")])),_:1})])),_:1}),i(l,{class:"qr-body"},{default:n((()=>[i(l,{class:"qr-code-container"},{default:n((()=>[H.value?(r(),u(y,{key:0,src:H.value,class:"qr-image",style:h({width:L.value+"px",height:L.value+"px"}),mode:"aspectFit"},null,8,["src","style"])):(r(),u(l,{key:1,class:"qr-loading"},{default:n((()=>[i(t,{class:"loading-text"},{default:n((()=>[d("生成二维码中...")])),_:1})])),_:1}))])),_:1}),i(t,{class:"qr-tip"},{default:n((()=>[d("请使用微信扫描二维码完成支付")])),_:1}),i(t,{class:"qr-amount"},{default:n((()=>[d("支付金额：¥"+v(G.value)+"元",1)])),_:1}),K.value?(r(),u(t,{key:0,class:"qr-status"},{default:n((()=>[d("正在检查支付状态...")])),_:1})):p("",!0),K.value?(r(),u(t,{key:1,class:"qr-hint"},{default:n((()=>[d("请在1分钟内完成支付，请耐心等待系统检查")])),_:1})):p("",!0)])),_:1})])),_:1})])),_:1})):p("",!0)])),_:1})}}},[["__scopeId","data-v-afa36c35"]]);export{j as default};
