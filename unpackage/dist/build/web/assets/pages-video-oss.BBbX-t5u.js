import{r as e,G as a,c as l,b as s,u as t,o as u,e as o,f as r,g as c,x as n,n as i,y as d,z as v,F as f,q as m,a7 as p,t as _,I as g,a2 as h,a3 as y,A as b,a9 as k,v as w}from"./index-D0AdlXYI.js";import{_ as z}from"./uni-icons.E5IxVglq.js";import{r as S}from"./uni-app.es.DeTReHEE.js";import{O as M}from"./aliyun-oss-sdk.ehYCrfZk.js";import{v as x,f as F,w as T}from"./apis.BsLnrVmb.js";import{_ as $}from"./_plugin-vue_export-helper.BCo6x5W8.js";let j=null,B=!1;const C={oss:{async upload(e,a={}){try{let l=j;l||(l=await async function(){if(B)return new Promise((e=>{const a=setInterval((()=>{j&&(clearInterval(a),e(j))}),100)}));B=!0;try{const e=await x();return console.log("STS获取成功:",e),j=new M({accessKeyId:e.data.STSaccessKeyId,accessKeySecret:e.data.STSsecretAccessKey,stsToken:e.data.security_token,bucket:"cjvd",region:"oss-cn-guangzhou"}),console.log("OSS客户端初始化成功"),B=!1,j}catch(e){throw console.error("OSS客户端初始化失败:",e),B=!1,e}}());const s=a.folder||"uploads",t=a.prefix||"";let u="";if(e&&e.name)u=e.name;else{if(!e||!e.path)throw new Error("文件对象格式不正确，缺少 name 或 path 属性");{const a=e.path.split("/");u=a[a.length-1]}}const o=u.lastIndexOf(".");if(-1===o)throw new Error("文件名不包含扩展名");const r=u.substring(o+1),c=`${s}/${t}${((e=21)=>{let a="",l=0|e;for(;l--;)a+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return a})()}.${r}`;return console.log("上传文件信息:",{"原始文件名":u,"远程文件名":c}),await l.put(c,e,{progress:a.progress||function(e){console.log("上传进度:",Math.round(100*e)+"%")}})}catch(l){throw console.error("上传文件时发生错误:",l),l}}}},I=$({__name:"oss",setup(M){const x=()=>{m({delta:1})},$=e([]),j=e([]),B=e(0),I=e("请选择要上传的文件"),V=e(""),K=e(""),O=e(1),P=e(""),U=e(""),A=e(null),E=()=>{p({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{e.tempFilePaths,console.log(e.tempFilePaths),$.value=e.tempFiles,I.value=`已选择${$.value.length}个文件，点击"开始上传"按钮上传`,V.value="status-warning"}})},G=()=>{p({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{const a=e.tempFilePaths[0];U.value=a,A.value=e.tempFiles[0]}})},N=async()=>{if(0===$.value.length)return I.value="请先选择文件",void(V.value="status-error");if(!K.value.trim())return I.value="请输入视频标题",void(V.value="status-error");if(2===O.value&&(!P.value||Number(P.value)<=0))return I.value="请输入有效的收费价格",void(V.value="status-error");I.value="正在上传...",V.value="status-warning",B.value=0;for(let a=0;a<$.value.length;a++){const l=$.value[a];try{const e=await C.oss.upload(l,{folder:"videos",progress:e=>{B.value=Math.floor(100*e),I.value=`视频上传中: ${B.value}%`}});console.log("视频上传成功:",e.name);let a="";if(A.value){I.value="正在上传封面...";a=(await C.oss.upload(A.value,{folder:"vimg",progress:()=>{}})).name,console.log("封面上传成功:",a)}const s={title:K.value,flag:2===O.value,price:2===O.value?Number(P.value):0,account:F(),url:e.name,vimg:a},t=await T(s);console.log("视频信息提交成功:",t),j.value.push({name:l.name,size:l.size,url:e.url,coverUrl:a}),I.value=`文件"${l.name}"上传成功`,V.value="status-success",K.value="",O.value=1,P.value="",U.value="",A.value=null}catch(e){I.value=`文件"${l.name}"上传失败: ${e.message}`,V.value="status-error"}}},q=()=>{$.value=[],j.value=[],B.value=0,U.value="",A.value=null,I.value="已清空所有文件",V.value="status-warning"},D=e=>{if(0===e)return"0 Bytes";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["Bytes","KB","MB","GB"][a]};return(e,m)=>{const p=S(a("uni-icons"),z),M=t,F=_,T=g,C=h,A=y,H=b,J=k,L=w;return u(),l(M,{class:"container"},{default:s((()=>[o(M,{class:"navbar"},{default:s((()=>[o(M,{class:"navbar-left",onClick:x},{default:s((()=>[o(p,{type:"left",size:"30"})])),_:1}),o(M,{class:"navbar-title"},{default:s((()=>[r("上传视频")])),_:1})])),_:1}),o(M,{class:"form-area"},{default:s((()=>[o(M,{class:"form-item"},{default:s((()=>[o(F,{class:"form-label"},{default:s((()=>[r("视频标题")])),_:1}),o(T,{class:"form-input",modelValue:K.value,"onUpdate:modelValue":m[0]||(m[0]=e=>K.value=e),placeholder:"请输入视频标题"},null,8,["modelValue"])])),_:1}),o(M,{class:"form-item"},{default:s((()=>[o(F,{class:"form-label"},{default:s((()=>[r("是否收费")])),_:1}),o(M,{class:"radio-group"},{default:s((()=>[o(A,{class:"radio-label"},{default:s((()=>[o(C,{value:"1",checked:1===O.value,onClick:m[1]||(m[1]=e=>O.value=1)},{default:s((()=>[r("免费")])),_:1},8,["checked"])])),_:1}),o(A,{class:"radio-label"},{default:s((()=>[o(C,{value:"2",checked:2===O.value,onClick:m[2]||(m[2]=e=>O.value=2)},{default:s((()=>[r("收费")])),_:1},8,["checked"])])),_:1})])),_:1})])),_:1}),2===O.value?(u(),l(M,{key:0,class:"form-item"},{default:s((()=>[o(F,{class:"form-label"},{default:s((()=>[r("收费价格")])),_:1}),o(T,{class:"form-input",modelValue:P.value,"onUpdate:modelValue":m[3]||(m[3]=e=>P.value=e),type:"number",placeholder:"请输入价格"},null,8,["modelValue"]),o(F,{class:"price-unit"},{default:s((()=>[r("元")])),_:1})])),_:1})):c("",!0)])),_:1}),o(M,{class:"upload-area",onClick:E},{default:s((()=>[o(p,{name:"plus",size:"50",color:"#3498db"}),o(M,{class:"upload-text"},{default:s((()=>[r("点击选择视频文件")])),_:1}),o(M,{class:"upload-hint"},{default:s((()=>[r("支持上传所有类型文件，大小不超过5MB")])),_:1})])),_:1}),$.value.length>0?(u(),l(M,{key:0,class:"cover-area"},{default:s((()=>[o(F,{class:"section-title"},{default:s((()=>[r("视频封面")])),_:1}),o(M,{class:"cover-preview",onClick:G},{default:s((()=>[U.value?(u(),l(H,{key:0,src:U.value,class:"cover-image"},null,8,["src"])):(u(),l(M,{key:1,class:"cover-placeholder"},{default:s((()=>[o(p,{name:"image",size:"40",color:"#ccc"}),o(F,null,{default:s((()=>[r("点击选择封面")])),_:1})])),_:1}))])),_:1})])),_:1})):c("",!0),B.value>0?(u(),l(M,{key:1,class:"progress-area"},{default:s((()=>[o(J,{percent:B.value,"active-color":"#3498db","show-info":""},null,8,["percent"])])),_:1})):c("",!0),o(M,{class:i(["status-message",V.value])},{default:s((()=>[r(n(I.value),1)])),_:1},8,["class"]),o(M,{class:"action-buttons"},{default:s((()=>[o(L,{type:"primary",onClick:N,disabled:0===$.value.length},{default:s((()=>[r(" 开始上传 ")])),_:1},8,["disabled"]),o(L,{type:"default",onClick:q,disabled:0===$.value.length},{default:s((()=>[r(" 清空文件 ")])),_:1},8,["disabled"])])),_:1}),j.value.length>0?(u(),l(M,{key:2,class:"result-area"},{default:s((()=>[o(M,{class:"file-list"},{default:s((()=>[(u(!0),d(f,null,v(j.value,((e,a)=>(u(),l(M,{key:a,class:"file-item"},{default:s((()=>[o(M,{class:"file-icon"},{default:s((()=>[o(p,{name:"file",size:"24",color:"#409eff"})])),_:1}),o(M,{class:"file-info"},{default:s((()=>[o(F,{class:"file-name"},{default:s((()=>[r(n(e.name),1)])),_:2},1024),o(F,{class:"file-size"},{default:s((()=>[r(n(D(e.size)),1)])),_:2},1024)])),_:2},1024),o(M,{class:"file-url"},{default:s((()=>[o(F,null,{default:s((()=>[r(n(e.url),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):c("",!0)])),_:1})}}},[["__scopeId","data-v-b0b8ce69"]]);export{I as default};
