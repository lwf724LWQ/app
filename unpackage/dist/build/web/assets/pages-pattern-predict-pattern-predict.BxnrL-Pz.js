import{r as e,C as t,R as a,l as s,h as n,i as l,s as i,G as c,c as o,b as u,u as d,o as r,e as h,f as m,z as f,x as p,y as g,F as v,g as y,n as _,q as k,p as j,a7 as $,k as b,a6 as w,t as A,A as K,v as P,a1 as S}from"./index-BgH6xnyV.js";import{_ as T}from"./uni-icons.C97tYrvo.js";import{f as M,r as I}from"./uni-app.es.wmAOsoD-.js";import{B as C,g as F,F as x,t as z}from"./apis.BPdXt_sA.js";import{_ as E}from"./_plugin-vue_export-helper.BCo6x5W8.js";const D=E({__name:"pattern-predict",setup(E){const D=e(""),L=e([]),R=e([]),B=e(null),O=e([]),q=e(!1),G=t((()=>R.value.length>0&&L.value.length>0));a((()=>{U(),N()})),M((()=>{N()}));const J=e=>{const t=e.data,a=[];if("二字现"===e.id||"三字现"===e.id)t.combinations&&t.combinations.length>0?a.push(`组合: ${t.combinations.join(",")}`):a.push("组合: 未选择");else{if(t.thousands&&t.thousands.length>0){let e=`千位: ${t.thousands.join("")}`;t.thousandsMainAttack&&t.thousandsMainAttack.length>0&&(e+=` 主攻${t.thousandsMainAttack.join("")}`),t.thousandsKeyPoint&&t.thousandsKeyPoint.length>0&&(e+=` 重点${t.thousandsKeyPoint.join("")}`),a.push(e)}if(t.hundreds&&t.hundreds.length>0){let e=`百位: ${t.hundreds.join("")}`;t.hundredsMainAttack&&t.hundredsMainAttack.length>0&&(e+=` 主攻${t.hundredsMainAttack.join("")}`),t.hundredsKeyPoint&&t.hundredsKeyPoint.length>0&&(e+=` 重点${t.hundredsKeyPoint.join("")}`),a.push(e)}if(t.tens&&t.tens.length>0){let e=`十位: ${t.tens.join("")}`;t.tensMainAttack&&t.tensMainAttack.length>0&&(e+=` 主攻${t.tensMainAttack.join("")}`),t.tensKeyPoint&&t.tensKeyPoint.length>0&&(e+=` 重点${t.tensKeyPoint.join("")}`),a.push(e)}if(t.units&&t.units.length>0){let e=`个位: ${t.units.join("")}`;t.unitsMainAttack&&t.unitsMainAttack.length>0&&(e+=` 主攻${t.unitsMainAttack.join("")}`),t.unitsKeyPoint&&t.unitsKeyPoint.length>0&&(e+=` 重点${t.unitsKeyPoint.join("")}`),a.push(e)}0===a.length&&a.push("未选择")}return a},N=()=>{try{const e=s("predict_schemes_data");e&&e.addedSchemes&&Array.isArray(e.addedSchemes)?R.value=e.addedSchemes:R.value=[]}catch(e){R.value=[]}},U=async()=>{try{const e=s("currentLotteryType");if(B.value=e||{id:16,code:16,name:"排列三"},!B.value||!B.value.id)return;n({title:"加载期号中..."});const t=await C({cpid:B.value.id});if(l(),200===t.code&&null!==t.data&&void 0!==t.data){let e=null,a="待开奖",s="今天 21:30";"number"==typeof t.data||"string"==typeof t.data?e=t.data.toString():"object"==typeof t.data&&(e=t.data.issueno||t.data.number||t.data.id,a=t.data.status||"待开奖",s=t.data.time||"今天 21:30"),D.value=e||"0",i({title:`期号加载成功: ${D.value}`,icon:"success"})}else D.value="0",i({title:"使用默认期号: 0",icon:"none"})}catch(e){l(),D.value="0",i({title:"期号加载异常，使用默认期号: 0",icon:"none"})}},V=()=>{k()},H=()=>{console.log("=== 规律帖跳转到方案页面 ==="),console.log("当前页面:","pages/pattern-predict/pattern-predict");const e={lotteryType:B.value,issueInfo:{id:D.value,number:D.value,status:"待开奖",time:"今天 21:30"},schemes:R.value};j({url:`/pages/predict-scheme/predict-scheme?data=${encodeURIComponent(JSON.stringify(e))}`,success:()=>{},fail:e=>{i({title:"跳转失败",icon:"none"})}})},Q=async()=>{if(q.value)return void i({title:"图片正在上传中，请稍候",icon:"none"});const e=6-L.value.length;if(e<=0)i({title:"最多只能选择6张图片",icon:"none"});else try{const t=await $({count:e,sizeType:["compressed"],sourceType:["album","camera"]});if(t.tempFilePaths&&t.tempFilePaths.length>0){n({title:"上传图片中..."}),q.value=!0;const e=t.tempFilePaths.map((async(e,t)=>{try{let a;if("undefined"!=typeof window){const s=await fetch(e),n=await s.blob();a=new File([n],`pattern-image-${t}.jpg`,{type:"image/jpeg"})}else a=e;return new Promise(((t,s)=>{(async(e,t)=>{try{let a=e.name||"";a.split(".").slice(0,a.split(".").length-1).join(".");const s=(new Date).getTime()+"."+a.split(".")[a.split(".").length-1];let n=await z({});if(200!==n.code)throw new Error("获取上传凭证失败");const l=await S((()=>import("./aliyun-oss-sdk.ehYCrfZk.js").then((e=>e.a))),[]),i={region:n.data.region||"cn-guangzhou",accessKeyId:n.data.STSaccessKeyId,accessKeySecret:n.data.STSsecretAccessKey,stsToken:n.data.security_token,bucket:n.data.bucket||"cjvd",endpoint:"https://oss-cn-guangzhou.aliyuncs.com",refreshSTSToken:async()=>{const e=await z({});return{accessKeyId:e.data.STSaccessKeyId,accessKeySecret:e.data.STSsecretAccessKey,stsToken:e.data.security_token}},refreshSTSTokenInterval:3e5},c=new l.default(i),o=await c.put(`himg/${s}`,e);if(!o||!o.url)throw new Error("上传失败");t(`http://video.caimizm.com/himg/${s}`)}catch(a){throw a}})(a,(a=>{t({tempFilePath:e,url:a})}))}))}catch(a){throw a}})),a=await Promise.all(e);a.forEach((({tempFilePath:e,url:t})=>{L.value.push(e),O.value.push(t)})),l(),i({title:`成功上传${a.length}张图片`,icon:"success"}),q.value=!1}}catch(t){l(),q.value=!1,i({title:"图片上传失败",icon:"none"})}},W=()=>{let e="【规律预测】\n\n";R.value.length>0&&R.value.forEach(((t,a)=>{e+=`${a+1}. [${t.id}]\n`;J(t).forEach((t=>{e+=`   ${t}\n`})),e+="\n"}));const t=D.value||"0";return e+=`期号: 第${t}期\n`,e+=`发布时间: ${(new Date).toLocaleString()}`,e},X=async()=>{if(G.value)if(O.value&&0!==O.value.length)try{n({title:"发布中..."});let t="";const a=s("loginData")||{};a.himg&&(t=a.himg);const c={tname:B.value?`${B.value.name}-规律预测`:"规律预测",issueno:parseInt(D.value)||0,content:W(),account:F()||"",pimg:O.value.join(","),flag:!1};if(!c.account)return void i({title:"账号信息缺失，请重新登录",icon:"none"});if(null===c.issueno||void 0===c.issueno||""===c.issueno)return void i({title:"期号信息缺失",icon:"none"});if(!c.content)return void i({title:"发帖内容为空",icon:"none"});if(!c.pimg||""===c.pimg.trim())return void i({title:"请至少上传一张图片",icon:"none"});const o=await x(c);if(l(),200===o.code){try{const e=s("userAvatars")||{};e[F()]=t,b("userAvatars",e)}catch(e){}i({title:"规律帖已提交审核",icon:"success"}),w("predict_schemes_data"),L.value=[],O.value=[],setTimeout((()=>{k()}),1500)}else i({title:o.msg||"发布失败",icon:"none"})}catch(e){l(),i({title:"发布失败，请重试",icon:"none"})}else i({title:"请等待图片上传完成",icon:"none"});else i({title:"请完善方案和图片",icon:"none"})};return(e,t)=>{const a=I(c("uni-icons"),T),s=d,n=A,l=K,i=P;return r(),o(s,{class:"pattern-predict-container"},{default:u((()=>[h(s,{class:"nav-bar"},{default:u((()=>[h(s,{class:"nav-left",onClick:V},{default:u((()=>[h(a,{type:"left",size:"20",color:"#333"})])),_:1}),h(s,{class:"nav-title"},{default:u((()=>[m("规律预测")])),_:1}),h(s,{class:"nav-right"})])),_:1}),h(s,{class:"main-content"},{default:u((()=>[h(s,{class:"scheme-section"},{default:u((()=>[h(s,{class:"section-title"},{default:u((()=>[m("我的方案 (必选)")])),_:1}),h(s,{class:"scheme-input",onClick:H},{default:u((()=>[h(s,{class:"issue-info"},{default:u((()=>[h(n,{class:"issue-number"},{default:u((()=>[m("第"+f(D.value)+"期",1)])),_:1})])),_:1}),R.value.length>0?(r(),o(s,{key:0,class:"scheme-display"},{default:u((()=>[h(s,{class:"scheme-content"},{default:u((()=>[h(n,{class:"issue-number"},{default:u((()=>[m("第"+f(D.value)+"期",1)])),_:1}),(r(!0),p(v,null,g(R.value,((e,t)=>(r(),o(s,{key:t,class:"scheme-item"},{default:u((()=>[h(n,{class:"scheme-name"},{default:u((()=>[m("["+f(e.id)+"]",1)])),_:2},1024),h(s,{class:"scheme-details"},{default:u((()=>[(r(!0),p(v,null,g(J(e),((e,t)=>(r(),o(n,{key:t,class:"scheme-detail"},{default:u((()=>[m(f(e),1)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):(r(),o(s,{key:1,class:"scheme-placeholder"},{default:u((()=>[h(n,{class:"placeholder-text"},{default:u((()=>[m("还没有添加方案噢,点击可添加方案 >")])),_:1})])),_:1}))])),_:1})])),_:1}),h(s,{class:"image-section"},{default:u((()=>[h(s,{class:"section-title"},{default:u((()=>[m("添加规律图片 (必选，最多6张)")])),_:1}),h(s,{class:"image-upload-container"},{default:u((()=>[L.value.length>0?(r(),o(s,{key:0,class:"selected-images"},{default:u((()=>[(r(!0),p(v,null,g(L.value,((e,t)=>(r(),o(s,{key:t,class:"image-item"},{default:u((()=>[h(l,{src:e,class:"uploaded-image",mode:"aspectFit"},null,8,["src"]),h(s,{class:"image-delete",onClick:e=>(e=>{L.value.splice(e,1),O.value.splice(e,1)})(t)},{default:u((()=>[h(a,{type:"close",size:"16",color:"#fff"})])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1})):y("",!0),L.value.length<6?(r(),o(s,{key:1,class:"add-image-btn",onClick:Q},{default:u((()=>[h(a,{type:"camera",size:"40",color:"#ccc"}),h(n,{class:"add-text"},{default:u((()=>[m("添加图片")])),_:1}),h(n,{class:"count-text"},{default:u((()=>[m(f(L.value.length)+"/6",1)])),_:1})])),_:1})):y("",!0)])),_:1})])),_:1}),h(s,{class:"disclaimer"},{default:u((()=>[h(n,{class:"disclaimer-text"},{default:u((()=>[m("注: 帖子一旦发布, 将不能进行修改或删除操作")])),_:1})])),_:1}),h(s,{class:"bottom-buttons"},{default:u((()=>[h(i,{class:"modify-btn",onClick:H},{default:u((()=>[m("修改")])),_:1}),h(i,{class:_(["publish-btn",{disabled:!G.value}]),onClick:X},{default:u((()=>[m(" 发布 ")])),_:1},8,["class"])])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-3b3aff3f"]]);export{D as default};
