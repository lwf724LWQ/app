import{r as e,R as t,ag as a,k as s,l as n,a6 as o,s as l,c,b as i,h as u,i as d,u as r,o as f,e as h,f as p,y as m,z as g,x as v,F as y,g as _,n as $,q as b,a8 as I,j as k,aj as D,t as P,v as w}from"./index-D0AdlXYI.js";import{C as j,D as A,F as x,f as M,G as S}from"./apis.BsLnrVmb.js";import{_ as K}from"./_plugin-vue_export-helper.BCo6x5W8.js";const C=K({__name:"predict-publish",setup(K){const C=e([]),E=e(""),T=e(!1);e("");const z=e(!1),L=e(null),O=e({id:null,number:null,status:"待开奖",time:"今天 21:30"}),R=e(!1),F=e(!1),J=e(!1),N=e=>{const t=e.data,a=[];if("二字现"===e.id||"三字现"===e.id)t.combinations&&t.combinations.length>0?a.push(t.combinations.join(",")):a.push("未选择");else{if(t.thousands&&t.thousands.length>0){let e=`千位: ${t.thousands.join("")}`;t.thousandsMainAttack&&t.thousandsMainAttack.length>0&&(e+=` 主攻${t.thousandsMainAttack.join("")}`),t.thousandsKeyPoint&&t.thousandsKeyPoint.length>0&&(e+=` 重点${t.thousandsKeyPoint.join("")}`),a.push(e)}if(t.hundreds&&t.hundreds.length>0){let e=`百位: ${t.hundreds.join("")}`;t.hundredsMainAttack&&t.hundredsMainAttack.length>0&&(e+=` 主攻${t.hundredsMainAttack.join("")}`),t.hundredsKeyPoint&&t.hundredsKeyPoint.length>0&&(e+=` 重点${t.hundredsKeyPoint.join("")}`),a.push(e)}if(t.tens&&t.tens.length>0){let e=`十位: ${t.tens.join("")}`;t.tensMainAttack&&t.tensMainAttack.length>0&&(e+=` 主攻${t.tensMainAttack.join("")}`),t.tensKeyPoint&&t.tensKeyPoint.length>0&&(e+=` 重点${t.tensKeyPoint.join("")}`),a.push(e)}if(t.units&&t.units.length>0){let e=`个位: ${t.units.join("")}`;t.unitsMainAttack&&t.unitsMainAttack.length>0&&(e+=` 主攻${t.unitsMainAttack.join("")}`),t.unitsKeyPoint&&t.unitsKeyPoint.length>0&&(e+=` 重点${t.unitsKeyPoint.join("")}`),a.push(e)}0===a.length&&a.push("未选择")}return a},U=()=>{b({delta:1,success:()=>{I("modifySchemes",C.value)}})},q=async()=>{k({title:"确认发布",content:"确定要发布这些方案吗？发布后将无法修改或删除。",success:async e=>{e.confirm&&await H()}})},G=async()=>{if(E.value)try{T.value=!0,u({title:"追加中..."});const e=await B(),t=await x({id:E.value,content:e});d(),200===t.code?(l({title:"追加成功",icon:"success"}),o("appendPostData"),o("currentAppendPostData"),o("appendModeTipShown"),setTimeout((()=>{D({url:"/pages/forum/forum"})}),1500)):l({title:t.msg||"追加失败",icon:"none"})}catch(e){d(),l({title:"追加失败，请重试",icon:"none"})}finally{T.value=!1}else l({title:"帖子ID缺失",icon:"none"})},B=async()=>{var e;try{let a="";if(E.value)try{const t=await A({page:1,size:50,tname:(null==(e=currentLotteryType.value)?void 0:e.name)||"预测方案"});if(200===t.code&&t.data&&t.data.records&&Array.isArray(t.data.records)){const e=t.data.records.find((e=>e.id==E.value));e&&(a=e.content||"")}}catch(t){const e=n("currentAppendPostData");e&&e.postContent&&(a=e.postContent)}let s="\n\n--- 追加内容 ---\n";s+=`追加时间: ${(new Date).toLocaleString()}\n`,C.value.length>0?(s+="\n追加方案:\n",C.value.forEach(((e,t)=>{s+=`${t+1}. [${e.id}]\n`;N(e).forEach((e=>{s+=`   ${e}\n`}))}))):s+="\n追加内容: 方案数据\n";return a+s}catch(t){let e="\n\n--- 追加内容 ---\n";return e+=`追加时间: ${(new Date).toLocaleString()}\n`,C.value.length>0&&(e+="\n追加方案:\n",C.value.forEach(((t,a)=>{e+=`${a+1}. [${t.id}]\n`;N(t).forEach((t=>{e+=`   ${t}\n`}))}))),e}},H=async()=>{try{u({title:"发布中..."});const e={tname:L.value?L.value.name:"预测方案",issueno:Q(),content:Z(),account:M()||"",pimg:"",flag:!0};console.log("发帖数据:",e);const t=await S(e);d(),200===t.code?(t.data&&t.data.id&&(E.value=t.data.id,s("currentPostId",t.data.id),Y(t.data.id)),l({title:"发布成功",icon:"success"}),o("predict_schemes_data"),setTimeout((()=>{D({url:"/pages/forum/forum"})}),1500)):l({title:t.msg||"发布失败",icon:"none"})}catch(e){d(),l({title:"发布失败，请重试",icon:"none"})}},Q=()=>O.value.number||O.value.id||"--",V=async e=>{if(F.value)console.log("正在加载帖子详情，跳过重复请求");else try{F.value=!0,console.log("=== 获取帖子详细信息 ==="),console.log("帖子ID:",e);const t=await A({page:1,size:1,id:e});if(200===t.code&&t.data&&t.data.records&&t.data.records.length>0){const e=t.data.records[0];console.log("帖子详情:",e),e.content&&X(e.content)}}catch(t){console.error("获取帖子详情失败:",t)}finally{F.value=!1}},W=async e=>{if(J.value)console.log("正在加载用户帖子，跳过重复请求");else try{J.value=!0,console.log("=== 获取用户已发布帖子 ==="),console.log("方案ID:",e);const t=await A({page:1,size:20,account:n("account")||""});if(200===t.code&&t.data&&t.data.records){const a=t.data.records.find((t=>t.content&&t.content.includes(e)));a?(E.value=a.id,console.log(`找到方案 ${e} 对应的帖子:`,a.id),X(a.content)):console.log(`未找到包含方案 ${e} 的帖子`)}}catch(t){console.error("获取用户已发布帖子失败:",t)}finally{J.value=!1}},X=e=>{try{console.log("=== 解析帖子内容 ==="),console.log("帖子内容:",e);const t=n("predict_schemes_data");if(console.log("本地存储的方案数据:",t),t&&t.schemeData){const a=Object.keys(t.schemeData).find((t=>e.includes(t)));if(a){const e={id:a,name:a,data:t.schemeData[a]};C.value=[e],console.log("解析出的方案数据:",e)}}}catch(t){console.error("解析帖子内容失败:",t)}},Y=e=>{try{const t=(new Date).toDateString(),a=n(`publishedSchemes_${t}`)||[],o=n(`publishedPosts_${t}`)||{};C.value.forEach((t=>{const s=t.id;a.includes(s)||a.push(s),o[s]=e})),s(`publishedSchemes_${t}`,a),s(`publishedPosts_${t}`,o),console.log("已保存发布数据:",{publishedSchemes:a,publishedPosts:o,postId:e})}catch(t){console.error("保存已发布方案数据失败:",t)}},Z=()=>{if(0===C.value.length)return"暂无方案数据";let e="【预测方案】\n\n";return C.value.forEach(((t,a)=>{e+=`${a+1}. ${t.name} (${t.id})\n`;N(t).forEach((t=>{e+=`   ${t}\n`})),e+="\n"})),e+=`期号: 第${Q()}期\n`,e+=`发布时间: ${(new Date).toLocaleString()}`,e},ee=()=>{k({title:"提示",content:"返回会清空内容,确定返回吗?",confirmText:"确定",cancelText:"取消",confirmColor:"#ff4757",success:e=>{if(e.confirm){try{o("predict_schemes_data")}catch(t){console.error("清除本地存储失败:",t)}D({url:"/pages/forum/forum"})}}})};return t((()=>{const e=a(),t=e[e.length-1].options;if(console.log("=== 页面加载调试信息 ==="),console.log("页面参数:",t),t.postId)E.value=t.postId,s("currentPostId",t.postId),console.log("接收到帖子ID，进入追帖模式:",t.postId),z.value=!0,console.log("追帖模式已设置:",z.value),t.schemeId&&(console.log("加载方案数据:",t.schemeId),(async e=>{try{console.log("=== 加载追帖方案数据 ==="),console.log("方案ID:",e);const t=(new Date).toDateString(),a=n(`publishedPosts_${t}`)||{};console.log("已发布的帖子映射:",a);const s=a[e];s?(E.value=s,console.log(`加载方案 ${e} 对应的帖子ID:`,s),await V(s)):(console.log(`未找到方案 ${e} 对应的帖子ID`),await W(e))}catch(t){console.error("加载追帖方案数据失败:",t)}})(t.schemeId));else{const e=n("currentPostId");if(e){const t=n("appendPostData");t&&t.postId===e?(E.value=e,z.value=!0,console.log("从本地存储恢复追帖模式:",e)):(o("currentPostId"),console.log("清除残留的帖子ID，确保新帖模式"))}}if(console.log("最终状态 - 帖子ID:",E.value,"追帖模式:",z.value),t.data)try{const e=JSON.parse(decodeURIComponent(t.data));C.value=e.schemes||[],L.value=e.lotteryType||null,O.value=e.issueInfo||{id:null,number:null,status:"待开奖",time:"今天 21:30"},O.value.number||O.value.id||(async()=>{if(R.value)console.log("正在加载期号信息，跳过重复请求");else try{if(R.value=!0,!L.value||!L.value.id)return;u({title:"加载期号中..."});const e=await j({cpid:L.value.id});if(d(),200===e.code&&null!==e.data&&void 0!==e.data){let t=null,a="待开奖",s="今天 21:30";"number"==typeof e.data||"string"==typeof e.data?t=e.data.toString():"object"==typeof e.data&&(t=e.data.issueno||e.data.number||e.data.id,a=e.data.status||"待开奖",s=e.data.time||"今天 21:30"),O.value={id:t,number:t,status:a,time:s},l({title:`期号加载成功: ${t}`,icon:"success"})}else l({title:"期号数据为空",icon:"none"})}catch(e){d(),console.error("加载期号信息失败:",e),l({title:"期号加载异常",icon:"none"})}finally{R.value=!1}})()}catch(c){l({title:"数据解析失败",icon:"none"})}else if(t.schemes)try{const e=decodeURIComponent(t.schemes);C.value=JSON.parse(e)}catch(c){l({title:"数据解析失败",icon:"none"})}else C.value=[],l({title:"没有方案数据",icon:"none"})})),(e,t)=>{const a=P,s=r,n=w;return f(),c(s,{class:"publish-container"},{default:i((()=>[h(s,{class:"navbar"},{default:i((()=>[h(s,{class:"nav-content"},{default:i((()=>[h(s,{class:"nav-left",onClick:ee},{default:i((()=>[h(a,{class:"back-arrow"},{default:i((()=>[p("‹")])),_:1})])),_:1}),h(a,{class:"nav-title"},{default:i((()=>[p("预测")])),_:1}),h(s,{class:"nav-right"})])),_:1})])),_:1}),h(s,{class:"main-content"},{default:i((()=>[h(s,{class:"title-section"},{default:i((()=>[h(a,{class:"title-text"},{default:i((()=>[p("我的方案")])),_:1})])),_:1}),h(s,{class:"scheme-list"},{default:i((()=>[(f(!0),m(y,null,g(C.value,((e,t)=>(f(),c(s,{class:"scheme-item",key:t},{default:i((()=>[h(s,{class:"scheme-content"},{default:i((()=>[h(s,{class:"scheme-header"},{default:i((()=>[h(a,{class:"scheme-name"},{default:i((()=>[p(v(e.name),1)])),_:2},1024),h(s,{class:"scheme-type"},{default:i((()=>[p(v(e.id),1)])),_:2},1024)])),_:2},1024),h(s,{class:"scheme-details"},{default:i((()=>[h(s,{class:"scheme-data"},{default:i((()=>[(f(!0),m(y,null,g(N(e),((e,t)=>(f(),c(s,{class:"position-info",key:t},{default:i((()=>[p(v(e),1)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),0===C.value.length?(f(),c(s,{key:0,class:"empty-state"},{default:i((()=>[h(a,{class:"empty-text"},{default:i((()=>[p("暂无方案数据")])),_:1})])),_:1})):_("",!0)])),_:1}),h(s,{class:"period-info"},{default:i((()=>[h(a,{class:"period-text"},{default:i((()=>[p(v(L.value?L.value.name:"彩票类型")+" 第"+v(Q())+"期",1)])),_:1}),h(a,{class:"period-status"},{default:i((()=>[p(v(O.value.status),1)])),_:1})])),_:1}),E.value||z.value?(f(),c(s,{key:0,class:"append-section"},{default:i((()=>[h(s,{class:"append-title"},{default:i((()=>[h(a,{class:"append-title-text"},{default:i((()=>[p("追加内容")])),_:1}),h(a,{class:"append-post-id"},{default:i((()=>[p("帖子ID: "+v(E.value),1)])),_:1})])),_:1}),h(s,{class:"append-info"},{default:i((()=>[h(a,{class:"append-info-text"},{default:i((()=>[p("将自动追加当前选择的方案到原帖子")])),_:1})])),_:1}),h(s,{class:"append-buttons"},{default:i((()=>[h(n,{class:$(["append-btn",{disabled:T.value}]),onClick:G},{default:i((()=>[p(v(T.value?"追加中...":"追加发帖"),1)])),_:1},8,["class"])])),_:1})])),_:1})):_("",!0)])),_:1}),z.value?_("",!0):(f(),c(s,{key:0,class:"bottom-section"},{default:i((()=>[h(s,{class:"warning-section"},{default:i((()=>[h(a,{class:"warning-text"},{default:i((()=>[p("注:帖子一旦发布,将不能进行修改或删除操作")])),_:1})])),_:1}),h(s,{class:"action-buttons"},{default:i((()=>[h(n,{class:"modify-btn",onClick:U},{default:i((()=>[p("修改")])),_:1}),h(n,{class:"publish-btn",onClick:q},{default:i((()=>[p("发布")])),_:1})])),_:1})])),_:1})),z.value?(f(),c(s,{key:1,class:"bottom-section"},{default:i((()=>[h(s,{class:"warning-section"},{default:i((()=>[h(a,{class:"warning-text"},{default:i((()=>[p("追帖模式：追加内容到已发布的帖子")])),_:1})])),_:1})])),_:1})):_("",!0)])),_:1})}}},[["__scopeId","data-v-b00b9307"]]);export{C as default};
