import{r as a,R as e,_ as l,G as t,x as i,e as s,b as o,F as n,u,o as c,f as r,z as d,c as v,g as f,n as p,q as m,s as k,p as y,j as g,a0 as _,A as h,t as C,v as L}from"./index-BgH6xnyV.js";import{_ as b}from"./uni-icons.C97tYrvo.js";import{o as j,r as w}from"./uni-app.es.wmAOsoD-.js";import{f as I,h as $,i as x,g as z,j as R,k as U}from"./apis.BPdXt_sA.js";import{u as T}from"./video.BFhzdTnD.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";const A=P({__name:"play",setup(P){const A=T(),V=a({id:"",title:"",src:"",account:"",likeCount:0,isLiked:!1}),q=a(!0),F=a(!1),G=a(null),N=a({uname:"",himg:""});j((async a=>{if(a.id){const e=A.getCurrentVideo;e&&e.id===a.id&&(V.value={id:e.id,title:e.title,src:e.src,account:e.account,likeCount:e.likeCount||0,isLiked:e.isLiked||!1,flag:e.flag,price:e.price},await B(e.account))}})),e((()=>{G.value=l("videoPlayer")}));const O=()=>{m({delta:1})},B=async a=>{try{const e={account:a},l={},t=I();t&&(l.Authorization=t);const i=await $(e,l);200===i.code?N.value={uname:i.data.uname,himg:i.data.himg}:(console.error("获取用户信息失败:",i.message),N.value={uname:a,himg:""})}catch(e){console.error("获取用户信息异常:",e),N.value={uname:a,himg:""}}},D=async()=>{if(!I())return k({title:"请先登录",icon:"none"}),void setTimeout((()=>{y({url:"/pages/login/login"})}),1500);if(V.value.flag&&0!==V.value.price)try{(await x({videoId:V.value.id,account:z()})).data?G.value&&(G.value.play(),F.value=!0,q.value=!1):g({title:"付费视频",content:`观看此视频需要支付${V.value.price}金币`,confirmText:"立即支付",cancelText:"取消",success:async a=>{a.confirm&&await E()}})}catch(a){k({title:a.message||"查询失败",icon:"none"})}else G.value&&(G.value.play(),F.value=!0,q.value=!1)},E=async()=>{const a={info:`视频: ${V.value.title}`,amount:V.value.price,type:3,account:z(),payType:0,channel:0,videoId:V.value.id};y({url:`/pages/video/payment?${H(a)}`})},H=a=>Object.keys(a).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(a[e])}`)).join("&"),J=()=>{F.value=!0,q.value=!1},K=()=>{F.value=!1,q.value=!0},M=()=>{if(!I())return k({title:"请先登录",icon:"none"}),void setTimeout((()=>{y({url:"/pages/login/login"})}),1500);y({url:`/pages/video/reward?videoId=${V.value.id}&author=${encodeURIComponent(V.value.account)}&title=${encodeURIComponent(V.value.title)}&authorAvatar=${encodeURIComponent(N.value.himg)}&authorName=${encodeURIComponent(N.value.uname)}`})},Q=async()=>{try{V.value.isLiked,V.value.likeCount;V.value.isLiked=!V.value.isLiked,V.value.likeCount=V.value.isLiked?V.value.likeCount+1:V.value.likeCount-1;await R({id:V.value.id,account:z(),isLiked:V.value.isLiked});console.log("点赞操作成功");const a=await U(z());console.log(a)}catch(a){console.error("点赞操作失败:",a),V.value.isLiked=originalIsLiked,V.value.likeCount=originalLikeCount,k({title:"操作失败，请重试",icon:"none"})}};return(a,e)=>{const l=w(t("uni-icons"),b),m=u,k=_,y=h,g=C,j=L;return c(),i(n,null,[s(m,{class:"navbar"},{default:o((()=>[s(m,{class:"navbar-left",onClick:O},{default:o((()=>[s(l,{type:"left",size:"30"})])),_:1}),s(m,{class:"navbar-title"},{default:o((()=>[r(d(V.value.title),1)])),_:1})])),_:1}),s(m,{class:"container"},{default:o((()=>[s(m,{class:"video-container"},{default:o((()=>[s(k,{src:V.value.src,controls:F.value,autoplay:!1,"object-fit":"cover",class:"video-player",id:"videoPlayer",onPlay:J,onPause:K},null,8,["src","controls"]),q.value?(c(),v(m,{key:0,class:"play-overlay",onClick:D},{default:o((()=>[s(m,{class:"play-button"},{default:o((()=>[s(l,{type:"play-filled",size:"60",color:"#fff"})])),_:1})])),_:1})):f("",!0)])),_:1}),s(m,{class:"author-info"},{default:o((()=>[s(m,{class:"author-avatar"},{default:o((()=>{return[s(y,{src:(a=N.value.himg,a?`http://video.caimizm.com/himg/${a}`:""),class:"avatar"},null,8,["src"]),s(m,{class:"v-badge"},{default:o((()=>[r("V")])),_:1})];var a})),_:1}),s(m,{class:"author-details"},{default:o((()=>[s(g,{class:"author-name"},{default:o((()=>[r(d(N.value.uname),1)])),_:1})])),_:1})])),_:1}),s(m,{class:"action-bar"},{default:o((()=>[s(m,{class:"like-section"},{default:o((()=>[s(j,{class:p(["like-btn",{liked:V.value.isLiked}]),onClick:Q},{default:o((()=>[s(l,{type:V.value.isLiked?"heart-filled":"heart",size:"24",color:V.value.isLiked?"#ff4757":"#666"},null,8,["type","color"]),s(g,{class:"like-count"},{default:o((()=>[r(d(V.value.likeCount),1)])),_:1})])),_:1},8,["class"])])),_:1}),s(m,{class:"reward-section"},{default:o((()=>[s(j,{class:"reward-btn",onClick:M},{default:o((()=>[s(l,{type:"gift-filled",size:"24",color:"#aa0000"}),s(g,{class:"reward-text"},{default:o((()=>[r("打赏")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})],64)}}},[["__scopeId","data-v-d3c1badc"]]);export{A as default};
