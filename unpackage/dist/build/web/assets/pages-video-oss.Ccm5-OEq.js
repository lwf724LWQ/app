import{r as e,G as a,Y as l,c as s,b as t,u,o,e as r,f as c,g as n,z as i,n as d,x as v,y as f,F as m,q as p,a7 as _,t as g,I as h,a2 as y,a3 as b,A as k,v as w}from"./index-BgH6xnyV.js";import{_ as z}from"./uni-icons.C97tYrvo.js";import{r as S}from"./uni-app.es.wmAOsoD-.js";import{O as $}from"./aliyun-oss-sdk.ehYCrfZk.js";import{u as x,g as F,v as M}from"./apis.BPdXt_sA.js";import{_ as T}from"./_plugin-vue_export-helper.BCo6x5W8.js";let j=null,B=!1;const C={oss:{async upload(e,a={}){try{let l=j;l||(l=await async function(){if(B)return new Promise((e=>{const a=setInterval((()=>{j&&(clearInterval(a),e(j))}),100)}));B=!0;try{const e=await x();return console.log("STS获取成功:",e),j=new $({accessKeyId:e.data.STSaccessKeyId,accessKeySecret:e.data.STSsecretAccessKey,stsToken:e.data.security_token,bucket:"cjvd",region:"oss-cn-guangzhou"}),console.log("OSS客户端初始化成功"),B=!1,j}catch(e){throw console.error("OSS客户端初始化失败:",e),B=!1,e}}());const s=a.folder||"uploads",t=a.prefix||"";let u="";if(e&&e.name)u=e.name;else{if(!e||!e.path)throw new Error("文件对象格式不正确，缺少 name 或 path 属性");{const a=e.path.split("/");u=a[a.length-1]}}const o=u.lastIndexOf(".");if(-1===o)throw new Error("文件名不包含扩展名");const r=u.substring(o+1),c=`${s}/${t}${((e=21)=>{let a="",l=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)a+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&l[e]];return a})()}.${r}`;return console.log("上传文件信息:",{"原始文件名":u,"远程文件名":c}),await l.put(c,e,{progress:a.progress||function(e){console.log("上传进度:",Math.round(100*e)+"%")}})}catch(l){throw console.error("上传文件时发生错误:",l),l}}}},I=T({__name:"oss",setup($){const x=()=>{p({delta:1})},T=e([]),j=e([]),B=e(0),I=e("请选择要上传的文件"),V=e(""),K=e(""),O=e(1),P=e(""),U=e(""),A=e(null),E=()=>{_({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{if(e.tempFilePaths,console.log(e.tempFilePaths),T.value=e.tempFiles,I.value=`已选择${T.value.length}个文件，点击"开始上传"按钮上传`,V.value="status-warning",!K.value&&T.value.length>0){const e=T.value[0].name;K.value=e.replace(/\.[^/.]+$/,"")}}})},G=()=>{_({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{const a=e.tempFilePaths[0];U.value=a,A.value=e.tempFiles[0]}})},N=async()=>{if(0===T.value.length)return I.value="请先选择文件",void(V.value="status-error");if(!K.value.trim())return I.value="请输入视频标题",void(V.value="status-error");if(2===O.value&&(!P.value||Number(P.value)<=0))return I.value="请输入有效的收费价格",void(V.value="status-error");I.value="正在上传...",V.value="status-warning",B.value=0;for(let a=0;a<T.value.length;a++){const l=T.value[a];try{const e=await C.oss.upload(l,{folder:"videos",progress:e=>{B.value=Math.floor(100*e),I.value=`视频上传中: ${B.value}%`}});console.log("视频上传成功:",e.name);let a="";if(A.value){I.value="正在上传封面...";a=(await C.oss.upload(A.value,{folder:"vimg",progress:()=>{}})).name,console.log("封面上传成功:",a)}const s={title:K.value,flag:2===O.value,price:2===O.value?Number(P.value):0,account:F(),url:e.name,vimg:a},t=await M(s);console.log("视频信息提交成功:",t),j.value.push({name:l.name,size:l.size,url:e.url,coverUrl:a}),I.value=`文件"${l.name}"上传成功`,V.value="status-success",K.value="",O.value=1,P.value="",U.value="",A.value=null}catch(e){I.value=`文件"${l.name}"上传失败: ${e.message}`,V.value="status-error"}}},q=()=>{T.value=[],j.value=[],B.value=0,U.value="",A.value=null,I.value="已清空所有文件",V.value="status-warning"},R=e=>{if(0===e)return"0 Bytes";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["Bytes","KB","MB","GB"][a]};return(e,p)=>{const _=S(a("uni-icons"),z),$=u,F=g,M=h,C=y,A=b,Y=l("u-icon"),D=k,H=l("u-line-progress"),J=w;return o(),s($,{class:"container"},{default:t((()=>[r($,{class:"navbar"},{default:t((()=>[r($,{class:"navbar-left",onClick:x},{default:t((()=>[r(_,{type:"left",size:"30"})])),_:1}),r($,{class:"navbar-title"},{default:t((()=>[c("上传视频")])),_:1})])),_:1}),r($,{class:"form-area"},{default:t((()=>[r($,{class:"form-item"},{default:t((()=>[r(F,{class:"form-label"},{default:t((()=>[c("视频标题")])),_:1}),r(M,{class:"form-input",modelValue:K.value,"onUpdate:modelValue":p[0]||(p[0]=e=>K.value=e),placeholder:"请输入视频标题"},null,8,["modelValue"])])),_:1}),r($,{class:"form-item"},{default:t((()=>[r(F,{class:"form-label"},{default:t((()=>[c("是否收费")])),_:1}),r($,{class:"radio-group"},{default:t((()=>[r(A,{class:"radio-label"},{default:t((()=>[r(C,{value:"1",checked:1===O.value,onClick:p[1]||(p[1]=e=>O.value=1)},{default:t((()=>[c("免费")])),_:1},8,["checked"])])),_:1}),r(A,{class:"radio-label"},{default:t((()=>[r(C,{value:"2",checked:2===O.value,onClick:p[2]||(p[2]=e=>O.value=2)},{default:t((()=>[c("收费")])),_:1},8,["checked"])])),_:1})])),_:1})])),_:1}),2===O.value?(o(),s($,{key:0,class:"form-item"},{default:t((()=>[r(F,{class:"form-label"},{default:t((()=>[c("收费价格")])),_:1}),r(M,{class:"form-input",modelValue:P.value,"onUpdate:modelValue":p[3]||(p[3]=e=>P.value=e),type:"number",placeholder:"请输入价格"},null,8,["modelValue"]),r(F,{class:"price-unit"},{default:t((()=>[c("元")])),_:1})])),_:1})):n("",!0)])),_:1}),r($,{class:"upload-area",onClick:E},{default:t((()=>[r(Y,{name:"plus",size:"50",color:"#3498db"}),r($,{class:"upload-text"},{default:t((()=>[c("点击选择视频文件")])),_:1}),r($,{class:"upload-hint"},{default:t((()=>[c("支持上传所有类型文件，大小不超过5MB")])),_:1})])),_:1}),T.value.length>0?(o(),s($,{key:0,class:"cover-area"},{default:t((()=>[r(F,{class:"section-title"},{default:t((()=>[c("视频封面")])),_:1}),r($,{class:"cover-preview",onClick:G},{default:t((()=>[U.value?(o(),s(D,{key:0,src:U.value,class:"cover-image"},null,8,["src"])):(o(),s($,{key:1,class:"cover-placeholder"},{default:t((()=>[r(Y,{name:"image",size:"40",color:"#ccc"}),r(F,null,{default:t((()=>[c("点击选择封面")])),_:1})])),_:1}))])),_:1})])),_:1})):n("",!0),B.value>0?(o(),s($,{key:1,class:"progress-area"},{default:t((()=>[r(H,{percent:B.value,"active-color":"#3498db","show-percent":!0},null,8,["percent"])])),_:1})):n("",!0),r($,{class:d(["status-message",V.value])},{default:t((()=>[c(i(I.value),1)])),_:1},8,["class"]),r($,{class:"action-buttons"},{default:t((()=>[r(J,{type:"primary",onClick:N,disabled:0===T.value.length},{default:t((()=>[c(" 开始上传 ")])),_:1},8,["disabled"]),r(J,{type:"default",onClick:q,disabled:0===T.value.length},{default:t((()=>[c(" 清空文件 ")])),_:1},8,["disabled"])])),_:1}),j.value.length>0?(o(),s($,{key:2,class:"result-area"},{default:t((()=>[r($,{class:"file-list"},{default:t((()=>[(o(!0),v(m,null,f(j.value,((e,a)=>(o(),s($,{key:a,class:"file-item"},{default:t((()=>[r($,{class:"file-icon"},{default:t((()=>[r(Y,{name:"file",size:"24",color:"#409eff"})])),_:1}),r($,{class:"file-info"},{default:t((()=>[r(F,{class:"file-name"},{default:t((()=>[c(i(e.name),1)])),_:2},1024),r(F,{class:"file-size"},{default:t((()=>[c(i(R(e.size)),1)])),_:2},1024)])),_:2},1024),r($,{class:"file-url"},{default:t((()=>[r(F,null,{default:t((()=>[c(i(e.url),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})):n("",!0)])),_:1})}}},[["__scopeId","data-v-191777ae"]]);export{I as default};
