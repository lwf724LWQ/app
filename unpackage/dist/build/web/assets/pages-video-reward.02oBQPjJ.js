import{r as a,c as e,b as t,u as l,o as s,e as o,f as c,z as u,x as n,y as r,n as d,F as i,K as v,g as m,H as f,q as _,s as h,p,j as y,h as g,i as k,a1 as I,t as w,A as q,I as C,v as b,a2 as x,a3 as F,a4 as R}from"./index-BgH6xnyV.js";import{o as U}from"./uni-app.es.wmAOsoD-.js";import{f as $,g as j,l as A,m as N,i as T}from"./apis.BPdXt_sA.js";import{_ as V}from"./_plugin-vue_export-helper.BCo6x5W8.js";const z=V({__name:"reward",setup(V){const z=a([1.8,3.8,5.8,6.8,8.8,18,38,58,68]),D=a(3.8),E=a(""),L=a(!1),P=a("0"),H=a("追梦人"),K=a(""),O=a("海南省 - 儋州市"),S=a({videoId:"",author:"",title:"",authorAvatar:"",authorName:""}),B=a(!1),G=a(200),J=a(""),M=a(""),Q=a(null),W=a(!1);U((a=>{a.videoId&&(S.value.videoId=a.videoId),a.author&&(S.value.author=decodeURIComponent(a.author)),a.title&&(S.value.title=decodeURIComponent(a.title)),a.authorAvatar&&(K.value=decodeURIComponent(a.authorAvatar)),a.authorName&&(H.value=decodeURIComponent(a.authorName))}));const X=a=>{P.value=a.detail.value},Y=()=>{_()},Z=()=>{E.value<0&&(E.value="")},aa=()=>{if(!E.value)return void h({title:"请输入金额",icon:"none"});const a=parseFloat(E.value);isNaN(a)||a<=0?h({title:"请输入有效金额",icon:"none"}):(D.value=a,L.value=!0,h({title:"已选择自定义金额",icon:"success"}))},ea=async()=>{if(!$())return h({title:"请先登录",icon:"none"}),void setTimeout((()=>{p({url:"/pages/login/login"})}),1500);"1"!==P.value?y({title:"确认支付",content:`确认支付 ¥${D.value}元 打赏作者？`,success:a=>{a.confirm&&ta()}}):await ta()},ta=async()=>{g({title:"处理中..."});try{const a={info:`打赏视频: ${S.value.title}`,amount:D.value.toString(),type:2,account:j(),payType:P.value,channel:1},e=await A(a);if(200===e.code&&e.data){const a=await la(e.data);200===a.code?sa(a.data):h({title:a.msg||"微信支付请求失败",icon:"none"})}else h({title:e.msg||"打赏失败",icon:"none"});k()}catch(a){k(),console.error("打赏接口调用失败:",a),h({title:"网络错误，请重试",icon:"none"})}},la=async a=>{try{const e={account:j(),orderNo:a,remark:S.value.videoId};return await N(e)}catch(e){return console.error("微信支付接口调用失败:",e),{code:500,msg:"微信支付接口调用失败"}}},sa=a=>{a&&a.includes("weixin://wxpay")&&(J.value=a,B.value=!0,setTimeout((()=>{oa(a),ua()}),100))},oa=a=>{try{I((()=>import("./browser.BBL8EhVO.js").then((a=>a.b))),[]).then((e=>{e.toDataURL(a,{width:G.value,height:G.value,margin:2,color:{dark:"#000000",light:"#FFFFFF"}},((e,t)=>{e?(console.error("二维码生成失败:",e),ca(a)):M.value=t}))})).catch((e=>{console.error("导入qrcode库失败:",e),ca(a)}))}catch(e){console.error("生成二维码失败:",e),ca(a)}},ca=a=>{try{const e=encodeURIComponent(a),t=`https://api.qrserver.com/v1/create-qr-code/?size=${G.value}x${G.value}&data=${e}`;M.value=t}catch(e){console.error("在线二维码生成失败:",e),h({title:"二维码生成失败",icon:"none"})}},ua=()=>{Q.value&&clearInterval(Q.value),W.value=!0;let a=0;Q.value=setInterval((async()=>{try{a++;const e=await na();if(!0===e)return void(await ra());!1===e&&console.log("支付状态检查中..."),a>=20&&(console.log("支付检查超时，停止检查"),ia(),h({title:"支付检查超时，请手动确认",icon:"none",duration:3e3}))}catch(e){console.error("检查支付状态失败:",e)}}),3e3)},na=async()=>{try{const a=await T({videoId:S.value.videoId,account:j()});return 200===a.code&&a.data}catch(a){return console.error("支付状态检查API调用失败:",a),!1}},ra=async()=>{try{ia(),y({title:"支付成功",content:`恭喜您！成功打赏${D.value}金币`,showCancel:!1,success:()=>{da(),setTimeout((()=>{_()}),500)}})}catch(a){console.error("处理支付成功失败:",a)}},da=()=>{ia(),B.value=!1,J.value="",M.value=""},ia=()=>{Q.value&&(clearInterval(Q.value),Q.value=null),W.value=!1,console.log("停止检查支付状态")};return(a,_)=>{const h=w,p=l,y=q,g=C,k=b,I=x,U=F,$=R;return s(),e(p,{class:"reward-container"},{default:t((()=>[o(p,{class:"navbar"},{default:t((()=>[o(p,{class:"nav-content"},{default:t((()=>[o(p,{class:"nav-left",onClick:Y},{default:t((()=>[o(h,{class:"back-arrow"},{default:t((()=>[c("‹")])),_:1})])),_:1}),o(p,{class:"nav-center"},{default:t((()=>[o(h,{class:"nav-title"},{default:t((()=>[c("打赏作者")])),_:1})])),_:1})])),_:1})])),_:1}),o(p,{class:"author-info"},{default:t((()=>[o(p,{class:"author-avatar"},{default:t((()=>{return[o(y,{src:(a=K.value,a?`http://video.caimizm.com/himg/${a}`:"/static/default-avatar.png"),class:"avatar"},null,8,["src"]),o(p,{class:"v-badge"},{default:t((()=>[c("V")])),_:1})];var a})),_:1}),o(p,{class:"author-details"},{default:t((()=>[o(h,{class:"author-name"},{default:t((()=>[c(u(H.value),1)])),_:1}),o(h,{class:"author-location"},{default:t((()=>[c(u(O.value),1)])),_:1})])),_:1})])),_:1}),o(p,{class:"reward-options"},{default:t((()=>[o(h,{class:"section-title"},{default:t((()=>[c("选择打赏金额")])),_:1}),o(p,{class:"amount-grid"},{default:t((()=>[(s(!0),n(i,null,r(z.value,((a,l)=>(s(),e(p,{key:l,class:d(["amount-option",{active:D.value===a}]),onClick:e=>(a=>{D.value=a,L.value=!1})(a)},{default:t((()=>[o(h,{class:"amount-text"},{default:t((()=>[c("¥"+u(a),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1}),o(p,{class:"custom-amount-section"},{default:t((()=>[o(h,{class:"custom-title"},{default:t((()=>[c("自定义金额")])),_:1}),o(p,{class:"custom-input-container"},{default:t((()=>[o(h,{class:"currency-symbol"},{default:t((()=>[c("¥")])),_:1}),o(g,{type:"number",class:"custom-input",placeholder:"输入金额",modelValue:E.value,"onUpdate:modelValue":_[0]||(_[0]=a=>E.value=a),onInput:Z},null,8,["modelValue"]),o(k,{class:"confirm-custom-btn",onClick:aa},{default:t((()=>[c("确定")])),_:1})])),_:1})])),_:1})])),_:1}),o(p,{class:"payment-methods"},{default:t((()=>[o(h,{class:"section-title"},{default:t((()=>[c("支付方式")])),_:1}),o($,{onChange:X},{default:t((()=>[o(U,{class:"payment-method"},{default:t((()=>[o(I,{value:"0",checked:"0"===P.value},null,8,["checked"]),o(h,{class:"method-text"},{default:t((()=>[c("微信支付")])),_:1})])),_:1}),o(U,{class:"payment-method"},{default:t((()=>[o(I,{value:"1",checked:"1"===P.value},null,8,["checked"]),o(h,{class:"method-text"},{default:t((()=>[c("账户余额")])),_:1})])),_:1})])),_:1})])),_:1}),o(p,{class:"payment-btn-container"},{default:t((()=>[o(k,{class:"payment-btn",onClick:ea},{default:t((()=>[c("支付 ¥"+u(D.value)+"元",1)])),_:1})])),_:1}),B.value?(s(),e(p,{key:0,class:"qr-modal",onClick:da},{default:t((()=>[o(p,{class:"qr-content",onClick:_[1]||(_[1]=f((()=>{}),["stop"]))},{default:t((()=>[o(p,{class:"qr-header"},{default:t((()=>[o(h,{class:"qr-title"},{default:t((()=>[c("扫码支付")])),_:1}),o(h,{class:"close-btn",onClick:da},{default:t((()=>[c("×")])),_:1})])),_:1}),o(p,{class:"qr-body"},{default:t((()=>[o(p,{class:"qr-code-container"},{default:t((()=>[M.value?(s(),e(y,{key:0,src:M.value,class:"qr-image",style:v({width:G.value+"px",height:G.value+"px"}),mode:"aspectFit"},null,8,["src","style"])):(s(),e(p,{key:1,class:"qr-loading"},{default:t((()=>[o(h,{class:"loading-text"},{default:t((()=>[c("生成二维码中...")])),_:1})])),_:1}))])),_:1}),o(h,{class:"qr-tip"},{default:t((()=>[c("请使用微信扫描二维码完成支付")])),_:1}),o(h,{class:"qr-amount"},{default:t((()=>[c("支付金额：¥"+u(D.value)+"元",1)])),_:1}),W.value?(s(),e(h,{key:0,class:"qr-status"},{default:t((()=>[c("正在检查支付状态...")])),_:1})):m("",!0),W.value?(s(),e(h,{key:1,class:"qr-hint"},{default:t((()=>[c('如已支付完成，可点击下方"支付完成"按钮')])),_:1})):m("",!0)])),_:1})])),_:1})])),_:1})):m("",!0)])),_:1})}}},[["__scopeId","data-v-edb93c9d"]]);export{z as default};
