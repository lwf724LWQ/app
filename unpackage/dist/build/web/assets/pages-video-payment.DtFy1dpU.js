import{r as a,c as e,b as t,u as l,o,e as n,f as s,z as c,K as u,g as r,H as i,q as d,j as v,h as f,i as p,s as m,p as y,a1 as _,t as h,a2 as g,a3 as w,a4 as I,v as k,A as q}from"./index-BgH6xnyV.js";import{o as T}from"./uni-app.es.wmAOsoD-.js";import{g as b,e as x,l as C,n as F,m as $,i as j}from"./apis.BPdXt_sA.js";import{_ as R}from"./_plugin-vue_export-helper.BCo6x5W8.js";const U=R({__name:"payment",setup(R){const U=a(!1),A=a(200),P=a(""),z=a(""),D=a(null),E=a(!1);a(!1);const L=a({info:"",amount:"",type:2,account:"",payType:0,channel:1});a(null),T((a=>{a.info&&(L.value.info=decodeURIComponent(a.info)),a.amount&&(L.value.amount=a.amount),a.type&&(L.value.type=parseInt(a.type)),a.account&&(L.value.account=decodeURIComponent(a.account)),a.payType&&(L.value.payType=parseInt(a.payType)),a.channel&&(L.value.channel=parseInt(a.channel)),a.videoId&&(L.value.videoId=a.videoId),L.value.account||(L.value.account=b())}));const N=a=>{L.value.payType=parseInt(a.detail.value)},H=()=>{d()},K=()=>{v({title:"确认支付",content:`确认支付 ¥${L.value.amount}元 购买 ${L.value.amount}个金币？`,success:a=>{a.confirm&&O()}})},O=async()=>{f({title:"处理中..."});try{const a={info:`用户充值${L.value.amount}元`,amount:L.value.amount.toString(),type:L.value.type,account:b()||currentUser.value,payType:L.value.payType};if(1===L.value.payType){const e=await x({account:b()});if(200!==e.code)return p(),void m({title:e.msg||"查询余额失败",icon:"none"});const t=parseFloat(e.data||0),l=parseFloat(L.value.amount);if(t<l)return console.log(t,l),p(),m({title:"余额不足，请充值",icon:"none"}),void setTimeout((()=>{y({url:"/pages/recharge/recharge"})}),1500);const o=await C(a);if(200!==o.code)return p(),void m({title:o.msg||"创建订单失败",icon:"none"});const n=o.data,s=await F({account:b(),orderNo:n,remark:L.value.videoId});return p(),void(200===s.code?v({title:"支付成功",content:`成功支付${L.value.amount}金币`,showCancel:!1,success:()=>{H()}}):m({title:s.msg||"余额支付失败",icon:"none"}))}const e=await C(a);if(200===e.code&&e.data){const a=await S(e.data);200===a.code?V(a.data):m({title:a.msg||"微信支付请求失败",icon:"none"})}else m({title:e.msg||"充值失败",icon:"none"});p(),200===e.code?e.data&&e.data.includes("weixin://wxpay")&&(P.value=e.data,U.value=!0,setTimeout((()=>{B(e.data),J()}),100)):m({title:e.msg||"充值失败",icon:"none"})}catch(a){p(),console.error("充值接口调用失败:",a),m({title:"网络错误，请重试",icon:"none"})}},S=async a=>{try{const e={account:b(),orderNo:a,remark:L.value.videoId};return await $(e)}catch(e){return console.error("微信支付接口调用失败:",e),{code:500,msg:"微信支付接口调用失败"}}},V=a=>{a&&a.includes("weixin://wxpay")&&(P.value=a,U.value=!0,setTimeout((()=>{B(a),J()}),100))},B=a=>{try{_((()=>import("./browser.BBL8EhVO.js").then((a=>a.b))),[]).then((e=>{e.toDataURL(a,{width:A.value,height:A.value,margin:2,color:{dark:"#000000",light:"#FFFFFF"}},((e,t)=>{e?(console.error("二维码生成失败:",e),G(a)):z.value=t}))})).catch((e=>{console.error("导入qrcode库失败:",e),G(a)}))}catch(e){console.error("生成二维码失败:",e),G(a)}},G=a=>{try{const e=encodeURIComponent(a),t=`https://api.qrserver.com/v1/create-qr-code/?size=${A.value}x${A.value}&data=${e}`;z.value=t}catch(e){console.error("在线二维码生成失败:",e),m({title:"二维码生成失败",icon:"none"})}},J=()=>{D.value&&clearInterval(D.value),E.value=!0;let a=0;D.value=setInterval((async()=>{try{a++;const e=await M();if(!0===e)return void(await W());!1===e&&console.log("支付状态检查中..."),a>=20&&(console.log("支付检查超时，停止检查"),X(),m({title:"支付检查超时，请手动确认",icon:"none",duration:3e3}))}catch(e){console.error("检查支付状态失败:",e)}}),3e3)},M=async()=>{try{const a=await j({videoId:L.value.videoId,account:b()});return 200===a.code&&a.data}catch(a){return console.error("支付状态检查API调用失败:",a),!1}},Q=()=>{X(),H()},W=async()=>{try{Q(),X(),v({title:"支付成功",content:`恭喜您！成功充值${L.value.amount}个金币`,showCancel:!1,success:()=>{}})}catch(a){console.error("处理支付成功失败:",a)}},X=()=>{D.value&&(clearInterval(D.value),D.value=null),E.value=!1,console.log("停止检查支付状态")};return(a,d)=>{const v=h,f=l,p=g,m=w,y=I,_=k,T=q;return o(),e(f,{class:"payment-container"},{default:t((()=>[n(f,{class:"navbar"},{default:t((()=>[n(f,{class:"nav-content"},{default:t((()=>[n(f,{class:"nav-left",onClick:H},{default:t((()=>[n(v,{class:"back-arrow"},{default:t((()=>[s("‹")])),_:1})])),_:1}),n(f,{class:"nav-center"},{default:t((()=>[n(v,{class:"nav-title"},{default:t((()=>[s("订单支付")])),_:1})])),_:1})])),_:1})])),_:1}),n(f,{class:"order-info"},{default:t((()=>[n(f,{class:"info-item"},{default:t((()=>[n(v,{class:"info-label"},{default:t((()=>[s("订单信息:")])),_:1}),n(v,{class:"info-value"},{default:t((()=>[s(c(L.value.info),1)])),_:1})])),_:1}),n(f,{class:"info-item"},{default:t((()=>[n(v,{class:"info-label"},{default:t((()=>[s("订单金额:")])),_:1}),n(v,{class:"info-value"},{default:t((()=>[s(c(L.value.amount)+"金币",1)])),_:1})])),_:1}),n(f,{class:"info-item"},{default:t((()=>[n(v,{class:"info-label"},{default:t((()=>[s("订单类型:")])),_:1}),n(v,{class:"info-value"},{default:t((()=>{return[s(c((a=L.value.type,{0:"充值",1:"提现",2:"打赏",3:"视频付费"}[a]||"未知类型")),1)];var a})),_:1})])),_:1}),n(f,{class:"info-item"},{default:t((()=>[n(v,{class:"info-label"},{default:t((()=>[s("下单渠道:")])),_:1}),n(v,{class:"info-value"},{default:t((()=>{return[s(c((a=L.value.channel,{0:"电脑端",1:"微信小程序",2:"APP"}[a]||"未知渠道")),1)];var a})),_:1})])),_:1})])),_:1}),n(f,{class:"payment-methods"},{default:t((()=>[n(v,{class:"section-title"},{default:t((()=>[s("支付方式")])),_:1}),n(y,{onChange:N},{default:t((()=>[n(m,{class:"payment-method"},{default:t((()=>[n(p,{value:"0",checked:0===L.value.payType},null,8,["checked"]),n(v,{class:"method-text"},{default:t((()=>[s("微信支付")])),_:1})])),_:1}),n(m,{class:"payment-method"},{default:t((()=>[n(p,{value:"1",checked:1===L.value.payType},null,8,["checked"]),n(v,{class:"method-text"},{default:t((()=>[s("账户余额")])),_:1})])),_:1})])),_:1})])),_:1}),n(f,{class:"payment-btn-container"},{default:t((()=>[n(_,{class:"payment-btn",onClick:K},{default:t((()=>[s("确认支付")])),_:1})])),_:1}),U.value?(o(),e(f,{key:0,class:"qr-modal",onClick:Q},{default:t((()=>[n(f,{class:"qr-content",onClick:d[0]||(d[0]=i((()=>{}),["stop"]))},{default:t((()=>[n(f,{class:"qr-header"},{default:t((()=>[n(v,{class:"qr-title"},{default:t((()=>[s("扫码支付")])),_:1}),n(v,{class:"close-btn",onClick:Q},{default:t((()=>[s("×")])),_:1})])),_:1}),n(f,{class:"qr-body"},{default:t((()=>[n(f,{class:"qr-code-container"},{default:t((()=>[z.value?(o(),e(T,{key:0,src:z.value,class:"qr-image",style:u({width:A.value+"px",height:A.value+"px"}),mode:"aspectFit"},null,8,["src","style"])):(o(),e(f,{key:1,class:"qr-loading"},{default:t((()=>[n(v,{class:"loading-text"},{default:t((()=>[s("生成二维码中...")])),_:1})])),_:1}))])),_:1}),n(v,{class:"qr-tip"},{default:t((()=>[s("请使用微信扫描二维码完成支付")])),_:1}),n(v,{class:"qr-amount"},{default:t((()=>[s("支付金额：¥"+c(L.value.amount)+"元",1)])),_:1}),E.value?(o(),e(v,{key:0,class:"qr-status"},{default:t((()=>[s("正在检查支付状态...")])),_:1})):r("",!0),E.value?(o(),e(v,{key:1,class:"qr-hint"},{default:t((()=>[s('如已支付完成，可点击下方"支付完成"按钮')])),_:1})):r("",!0)])),_:1})])),_:1})])),_:1})):r("",!0)])),_:1})}}},[["__scopeId","data-v-1820e72e"]]);export{U as default};
