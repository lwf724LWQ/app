import{r as e,C as a,R as t,s as l,p as s,ak as c,c as u,b as n,u as o,o as r,e as i,f as d,z as v,H as f,n as _,g as p,K as h,q as m,j as y,t as k,v as g,I as w,an as b,A as x,h as C,i as q,a1 as I}from"./index-BgH6xnyV.js";import{f as $,g as F,e as R,H as T,I as U}from"./apis.BPdXt_sA.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const j=D({__name:"recharge",setup(D){const j=e("vfmumq"),V=e(0),z=e(10),E=e(""),N=e(!1),A=e(!1),H=e(200),L=e(""),O=e(""),K=e(null),P=e(!1),S=e(!1),B=e(""),G=a((()=>E.value&&E.value>0?E.value:z.value)),J=a((()=>N.value&&G.value>0)),M=()=>{m()},Q=()=>{y({title:"充值说明",content:"1元=1金币，金币仅限平台内使用，充值后不可退还。",showCancel:!1})},W=e=>{z.value=e,E.value=""},X=()=>{E.value&&E.value>0&&(z.value=0)},Y=()=>{N.value=!N.value},Z=()=>{y({title:"充值服务协议",content:"这里是充值服务协议的内容...",showCancel:!1})},ee=()=>{s({url:"/pages/transaction/transaction"})},ae=()=>{J.value&&y({title:"确认支付",content:`确认支付 ¥${G.value}元 购买 ${G.value}个金币？`,success:e=>{e.confirm&&te()}})},te=async()=>{C({title:"处理中..."});try{const e={info:`用户充值${G.value}元`,amount:G.value.toString(),type:0,account:F()||j.value,payType:0,channel:0},a=await T(e);q(),200===a.code?a.data&&a.data.coreUrl&&a.data.coreUrl.includes("weixin://wxpay")?(B.value=a.data.orderNo||`ORDER_${Date.now()}`,L.value=a.data.coreUrl,A.value=!0,setTimeout((()=>{se(a.data.coreUrl),ie()}),100)):(l({title:a.msg||"充值成功",icon:"success"}),await le(),y({title:"支付成功",content:`恭喜您！成功充值${G.value}个金币`,showCancel:!1,success:()=>{oe(),setTimeout((()=>{s({url:"/pages/orders/orders"})}),500)}}),z.value=10,E.value="",N.value=!1):l({title:a.msg||"充值失败",icon:"none"})}catch(e){q(),l({title:"网络错误，请重试",icon:"none"})}},le=async()=>{try{const e=F();if(e){j.value=e;const a=await R({account:e});200===a.code&&(V.value=a.data||0)}}catch(e){}},se=e=>{try{I((()=>import("./browser.BBL8EhVO.js").then((e=>e.b))),[]).then((a=>{a.toDataURL(e,{width:H.value,height:H.value,margin:2,color:{dark:"#000000",light:"#FFFFFF"}},((a,t)=>{a?ce(e):O.value=t}))})).catch((a=>{ce(e)}))}catch(a){ce(e)}},ce=e=>{try{const a=encodeURIComponent(e),t=`https://api.qrserver.com/v1/create-qr-code/?size=${H.value}x${H.value}&data=${a}`;O.value=t}catch(a){l({title:"二维码生成失败",icon:"none"})}},ue=()=>{de(),A.value=!1,L.value="",O.value="",B.value=""},ne=async()=>{try{S.value=!0,await le(),z.value=10,E.value="",N.value=!1,setTimeout((()=>{S.value=!1}),1e3)}catch(e){S.value=!1,l({title:"刷新失败",icon:"none",duration:2e3})}},oe=async()=>{try{await le(),z.value=10,E.value="",N.value=!1}catch(e){}},re=async()=>{try{de(),await le(),y({title:"支付成功",content:`恭喜您！成功充值${G.value}个金币`,showCancel:!1,success:()=>{oe(),setTimeout((()=>{s({url:"/pages/orders/orders"})}),500)}}),ue(),z.value=10,E.value="",N.value=!1}catch(e){}},ie=()=>{K.value&&clearInterval(K.value),P.value=!0;let e=0;const a=Date.now();K.value=setInterval((async()=>{try{e++;const s=await U({orderNo:B.value});if(200===s.code){const a=s.data;if("success"===a||"paid"===a||1===a)return de(),void(await re());if(("failed"===a||"cancelled"===a||0===a)&&e>=5)return de(),l({title:"支付失败，请重试",icon:"none",duration:3e3}),void ue()}if(Date.now()-a>=6e4){de();try{const e=await U({orderNo:B.value});if(200===e.code){const a=e.data;"success"===a||"paid"===a||1===a?await re():(l({title:"支付失败，请重试",icon:"none",duration:3e3}),ue())}else l({title:"支付失败，请重试",icon:"none",duration:3e3}),ue()}catch(t){l({title:"支付失败，请重试",icon:"none",duration:3e3}),ue()}return}}catch(t){e>=20&&(de(),l({title:"支付检查失败，请重试",icon:"none",duration:3e3}),ue())}}),1e4)},de=()=>{K.value&&(clearInterval(K.value),K.value=null),P.value=!1};return t((async()=>{$()?await le():(l({title:"请先登录",icon:"none"}),setTimeout((()=>{s({url:"/pages/login/login"})}),1500))})),c((()=>{de()})),(e,a)=>{const t=k,l=o,s=g,c=w,m=b,y=x;return r(),u(l,{class:"recharge-container"},{default:n((()=>[i(l,{class:"navbar"},{default:n((()=>[i(l,{class:"nav-content"},{default:n((()=>[i(l,{class:"nav-left",onClick:M},{default:n((()=>[i(t,{class:"back-arrow"},{default:n((()=>[d("‹")])),_:1})])),_:1}),i(t,{class:"nav-title"},{default:n((()=>[d("我的金币")])),_:1}),i(l,{class:"nav-right",onClick:Q},{default:n((()=>[i(t,{class:"help-text"},{default:n((()=>[d("说明")])),_:1})])),_:1})])),_:1})])),_:1}),i(m,{class:"main-content","scroll-y":"true","refresher-enabled":"true","refresher-triggered":S.value,onRefresherrefresh:ne,"refresher-threshold":100,"refresher-default-style":"black","refresher-background":"#f5f5f5","enable-passive":!0},{default:n((()=>[i(l,{class:"user-info-section"},{default:n((()=>[i(t,{class:"user-text"},{default:n((()=>[d("当前用户: "+v(j.value),1)])),_:1}),i(l,{class:"balance-section"},{default:n((()=>[i(t,{class:"balance-text"},{default:n((()=>[d("我的余额: ")])),_:1}),i(t,{class:"balance-amount"},{default:n((()=>[d(v(V.value)+"金币",1)])),_:1}),i(s,{class:"record-btn",onClick:f(ee,["stop"])},{default:n((()=>[d("金币交易记录")])),_:1})])),_:1})])),_:1}),i(l,{class:"recharge-section"},{default:n((()=>[i(t,{class:"section-title"},{default:n((()=>[d("充值金币")])),_:1}),i(l,{class:"amount-options"},{default:n((()=>[i(l,{class:_(["amount-option",{active:10===z.value}]),onClick:a[0]||(a[0]=f((e=>W(10)),["stop"]))},{default:n((()=>[i(t,{class:"amount-text"},{default:n((()=>[d("10个金币")])),_:1}),i(t,{class:"price-text"},{default:n((()=>[d("10元")])),_:1}),10===z.value?(r(),u(l,{key:0,class:"check-icon"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"]),i(l,{class:_(["amount-option",{active:50===z.value}]),onClick:a[1]||(a[1]=f((e=>W(50)),["stop"]))},{default:n((()=>[i(t,{class:"amount-text"},{default:n((()=>[d("50个金币")])),_:1}),i(t,{class:"price-text"},{default:n((()=>[d("50元")])),_:1}),50===z.value?(r(),u(l,{key:0,class:"check-icon"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"]),i(l,{class:_(["amount-option",{active:100===z.value}]),onClick:a[2]||(a[2]=f((e=>W(100)),["stop"]))},{default:n((()=>[i(t,{class:"amount-text"},{default:n((()=>[d("100个金币")])),_:1}),i(t,{class:"price-text"},{default:n((()=>[d("100元")])),_:1}),100===z.value?(r(),u(l,{key:0,class:"check-icon"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"])])),_:1}),i(l,{class:"custom-amount-section"},{default:n((()=>[i(c,{type:"number",placeholder:"自定义金额",class:"custom-input",modelValue:E.value,"onUpdate:modelValue":a[3]||(a[3]=e=>E.value=e),onInput:X},null,8,["modelValue"]),i(t,{class:"conversion-text"},{default:n((()=>[d("元="+v(E.value||0)+"金币",1)])),_:1})])),_:1}),i(l,{class:"agreement-section"},{default:n((()=>[i(l,{class:"agreement-checkbox",onClick:f(Y,["stop"])},{default:n((()=>[i(l,{class:_(["checkbox",{checked:N.value}])},{default:n((()=>[N.value?(r(),u(t,{key:0,class:"check-mark"},{default:n((()=>[d("✓")])),_:1})):p("",!0)])),_:1},8,["class"]),i(t,{class:"agreement-text"},{default:n((()=>[d(" 我已阅读并同意 "),i(t,{class:"link-text",onClick:f(Z,["stop","prevent"])},{default:n((()=>[d("《充值服务协议》")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),i(l,{class:"rules-section"},{default:n((()=>[i(t,{class:"rule-item"},{default:n((()=>[d("1、1元=1金币")])),_:1}),i(t,{class:"rule-item"},{default:n((()=>[d("2、金币仅限于平台内部使用,充值后不可退还,不可兑换,不可提现")])),_:1}),i(t,{class:"rule-item"},{default:n((()=>[d("3、若有疑问、请联系管理员")])),_:1})])),_:1}),i(l,{class:"payment-section"},{default:n((()=>[i(s,{class:_(["payment-btn",{disabled:!J.value}]),onClick:f(ae,["stop"]),disabled:!J.value},{default:n((()=>[d(" 支付 ¥"+v(G.value)+"元 ",1)])),_:1},8,["class","disabled"])])),_:1})])),_:1},8,["refresher-triggered"]),A.value?(r(),u(l,{key:0,class:"qr-modal",onClick:ue},{default:n((()=>[i(l,{class:"qr-content",onClick:a[4]||(a[4]=f((()=>{}),["stop"]))},{default:n((()=>[i(l,{class:"qr-header"},{default:n((()=>[i(t,{class:"qr-title"},{default:n((()=>[d("扫码支付")])),_:1}),i(t,{class:"close-btn",onClick:ue},{default:n((()=>[d("×")])),_:1})])),_:1}),i(l,{class:"qr-body"},{default:n((()=>[i(l,{class:"qr-code-container"},{default:n((()=>[O.value?(r(),u(y,{key:0,src:O.value,class:"qr-image",style:h({width:H.value+"px",height:H.value+"px"}),mode:"aspectFit"},null,8,["src","style"])):(r(),u(l,{key:1,class:"qr-loading"},{default:n((()=>[i(t,{class:"loading-text"},{default:n((()=>[d("生成二维码中...")])),_:1})])),_:1}))])),_:1}),i(t,{class:"qr-tip"},{default:n((()=>[d("请使用微信扫描二维码完成支付")])),_:1}),i(t,{class:"qr-amount"},{default:n((()=>[d("支付金额：¥"+v(G.value)+"元",1)])),_:1}),P.value?(r(),u(t,{key:0,class:"qr-status"},{default:n((()=>[d("正在检查支付状态...")])),_:1})):p("",!0),P.value?(r(),u(t,{key:1,class:"qr-hint"},{default:n((()=>[d("请在1分钟内完成支付，请耐心等待系统检查")])),_:1})):p("",!0)])),_:1})])),_:1})])),_:1})):p("",!0)])),_:1})}}},[["__scopeId","data-v-b9f57365"]]);export{j as default};
